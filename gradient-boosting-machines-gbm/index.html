<!DOCTYPE html>
<html lang="zh-TW" prefix="og: http://ogp.me/ns#">
<head>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">


	
<title>Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言</title>
<meta name="robots" content="max-image-preview:large">


<meta name="description" content="Gradient Boosting Machines 是一個超級受歡迎的機器學習法，在許多領域上都有非常成功的表現，也是Kaggle競賽時常勝出的主要演算法之一。有別於隨機森林集成眾多深且獨立的樹模型，GBM則是集成諸多淺且弱連續的樹模型，每個樹模型會以之前的樹模型為基礎去學習和精進，結果通常是難以擊敗的。">

<meta property="og:locale" content="zh_TW">
<meta property="og:type" content="article">
<meta property="og:title" content="Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言">
<meta property="og:description" content="Gradient Boosting Machines 是一個超級受歡迎的機器學習法，在許多領域上都有非常成功的表現，也是Kaggle競賽時常勝出的主要演算法之一。有別於隨機森林集成眾多深且獨立的樹模型，GBM則是集成諸多淺且弱連續的樹模型，每個樹模型會以之前的樹模型為基礎去學習和精進，結果通常是難以擊敗的。">
<meta property="og:url" content="/gradient-boosting-machines-gbm/">
<meta property="og:site_name" content="果醬珍珍•JamJam">
<meta property="article:section" content=" 程式與統計">
<meta property="article:published_time" content="2019-04-14T14:54:16+08:00">
<meta property="og:image" content="/wp-content/uploads/2019/04/ben-neale-193521-unsplash-1024x576.jpg">
<meta property="og:image:width" content="1024">
<meta property="og:image:height" content="576">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:description" content="Gradient Boosting Machines 是一個超級受歡迎的機器學習法，在許多領域上都有非常成功的表現，也是Kaggle競賽時常勝出的主要演算法之一。有別於隨機森林集成眾多深且獨立的樹模型，GBM則是集成諸多淺且弱連續的樹模型，每個樹模型會以之前的樹模型為基礎去學習和精進，結果通常是難以擊敗的。">
<meta name="twitter:title" content="Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言">
<meta name="twitter:image" content="/wp-content/uploads/2019/04/ben-neale-193521-unsplash.jpg">


<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//s.w.org">



<link rel="stylesheet" id="crayon-css" href="/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-theme-hwj-based-on-monokai-css" href="/wp-content/uploads/crayon-syntax-highlighter/themes/hwj-based-on-monokai/hwj-based-on-monokai.css" type="text/css" media="all">
<link rel="stylesheet" id="crayon-font-monospace-css" href="/wp-content/plugins/crayon-syntax-highlighter/fonts/monospace.css" type="text/css" media="all">
<link rel="stylesheet" id="sb_instagram_styles-css" href="/wp-content/plugins/instagram-feed/css/sb-instagram-2-2.min.css" type="text/css" media="all">
<link rel="stylesheet" id="sydney-bootstrap-css" href="/wp-content/themes/hwj-based-on-sydney/css/bootstrap/bootstrap.min.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="titan-adminbar-styles-css" href="/wp-content/plugins/anti-spam/assets/css/admin-bar.css" type="text/css" media="all">
<link rel="stylesheet" id="sydney-fonts-css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C600%7CRaleway%3A400%2C500%2C600" type="text/css" media="all">
<link rel="stylesheet" id="sydney-style-css" href="/wp-content/themes/hwj-based-on-sydney/style.css" type="text/css" media="all">
<style id="sydney-style-inline-css" type="text/css">
.site-title { font-size:32px; }
.site-description { font-size:16px; }
#mainnav ul li a { font-size:14px; }
h1 { font-size:52px; }
h2 { font-size:42px; }
h3 { font-size:32px; }
h4 { font-size:25px; }
h5 { font-size:20px; }
h6 { font-size:18px; }
body { font-size:16px; }
.single .hentry .title-post { font-size:24px; }
.header-image { background-size:cover;}
.header-image { height:500px; }
.widget-area .widget_fp_social a,#mainnav ul li a:hover, .sydney_contact_info_widget span, .roll-team .team-content .name,.roll-team .team-item .team-pop .team-social li:hover a,.roll-infomation li.address:before,.roll-infomation li.phone:before,.roll-infomation li.email:before,.roll-testimonials .name,.roll-button.border,.roll-button:hover,.roll-icon-list .icon i,.roll-icon-list .content h3 a:hover,.roll-icon-box.white .content h3 a,.roll-icon-box .icon i,.roll-icon-box .content h3 a:hover,.switcher-container .switcher-icon a:focus,.go-top:hover,.hentry .meta-post a:hover,#mainnav > ul > li > a.active, #mainnav > ul > li > a:hover, button:hover, input[type="button"]:hover, input[type="reset"]:hover, input[type="submit"]:hover, .text-color, .social-menu-widget a, .social-menu-widget a:hover, .archive .team-social li a, a, h1 a, h2 a, h3 a, h4 a, h5 a, h6 a,.classic-alt .meta-post a,.single .hentry .meta-post a { color:#3d3d3d}
.reply,.woocommerce div.product .woocommerce-tabs ul.tabs li.active,.woocommerce #respond input#submit,.woocommerce a.button,.woocommerce button.button,.woocommerce input.button,.project-filter li a.active, .project-filter li a:hover,.preloader .pre-bounce1, .preloader .pre-bounce2,.roll-team .team-item .team-pop,.roll-progress .progress-animate,.roll-socials li a:hover,.roll-project .project-item .project-pop,.roll-project .project-filter li.active,.roll-project .project-filter li:hover,.roll-button.light:hover,.roll-button.border:hover,.roll-button,.roll-icon-box.white .icon,.owl-theme .owl-controls .owl-page.active span,.owl-theme .owl-controls.clickable .owl-page:hover span,.go-top,.bottom .socials li:hover a,.sidebar .widget:before,.blog-pagination ul li.active,.blog-pagination ul li:hover a,.content-area .hentry:after,.text-slider .maintitle:after,.error-wrap #search-submit:hover,#mainnav .sub-menu li:hover > a,#mainnav ul li ul:after, button, input[type="button"], input[type="reset"], input[type="submit"], .panel-grid-cell .widget-title:after { background-color:#3d3d3d}
.roll-socials li a:hover,.roll-socials li a,.roll-button.light:hover,.roll-button.border,.roll-button,.roll-icon-list .icon,.roll-icon-box .icon,.owl-theme .owl-controls .owl-page span,.comment .comment-detail,.widget-tags .tag-list a:hover,.blog-pagination ul li,.hentry blockquote,.error-wrap #search-submit:hover,textarea:focus,input[type="text"]:focus,input[type="password"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="time"]:focus,input[type="week"]:focus,input[type="number"]:focus,input[type="email"]:focus,input[type="url"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="color"]:focus, button, input[type="button"], input[type="reset"], input[type="submit"], .archive .team-social li a { border-color:#3d3d3d}
.site-header.float-header { background-color:rgba(0,0,0,0.9);}
@media only screen and (max-width: 1024px) { .site-header { background-color:#000000;}}
.site-title a, .site-title a:hover { color:#ffffff}
.site-description { color:#ffffff}
#mainnav ul li a, #mainnav ul li::before { color:#ffffff}
#mainnav .sub-menu li a { color:#ffffff}
#mainnav .sub-menu li a { background:#1c1c1c}
.text-slider .maintitle, .text-slider .subtitle { color:#ffffff}
body { color:#5e5e5e}
#secondary { background-color:#ffffff}
#secondary, #secondary a, #secondary .widget-title { color:#767676}
.footer-widgets { background-color:#252525}
.btn-menu { color:#ffffff}
#mainnav ul li a:hover { color:#d65050}
.site-footer { background-color:#1c1c1c}
.site-footer,.site-footer a { color:#666666}
.overlay { background-color:#000000}
.page-wrap { padding-top:10px;}
.page-wrap { padding-bottom:100px;}
@media only screen and (max-width: 1025px) {		
			.mobile-slide {
				display: block;
			}
			.slide-item {
				background-image: none !important;
			}
			.header-slider {
			}
			.slide-item {
				height: auto !important;
			}
			.slide-inner {
				min-height: initial;
			} 
		}
@media only screen and (max-width: 780px) { 
    	h1 { font-size: 32px;}
		h2 { font-size: 28px;}
		h3 { font-size: 22px;}
		h4 { font-size: 18px;}
		h5 { font-size: 16px;}
		h6 { font-size: 14px;}
    }

</style>
<link rel="stylesheet" id="sydney-font-awesome-css" href="/wp-content/themes/hwj-based-on-sydney/fonts/font-awesome.min.css" type="text/css" media="all">

<script type="text/javascript" src="/wp-includes/js/jquery/jquery.min.js" id="jquery-core-js"></script>
<script type="text/javascript" src="/wp-includes/js/jquery/jquery-migrate.min.js" id="jquery-migrate-js"></script>
<script type="text/javascript" id="crayon_js-js-extra">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"http:\/\/localhost\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type="text/javascript" src="/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js" id="crayon_js-js"></script>





</head><body><div id="fb-root"></div><script>(function(d, s, id) {

	var js, fjs = d.getElementsByTagName(s)[0];

	if (d.getElementById(id)) return;

	js = d.createElement(s); js.id = id;

	js.src = '//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.3';

	fjs.parentNode.insertBefore(js, fjs);

	}(document, 'script', 'facebook-jssdk'));</script>	<style type="text/css">
		.header-image {
			background-image: url(/wp-content/uploads/2018/09/果醬珍珍_首圖_10.jpg);
			display: block;
		}
		@media only screen and (max-width: 1024px) {
			.header-inner {
				display: block;
			}
			.header-image {
				background-image: none;
				height: auto !important;
			}		
		}
	</style>
			<style type="text/css" id="wp-custom-css">
			.entry-content a {
	text-decoration: underline;
	color: #9f6ad4;
}		</style>
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>
	

	




	<div class="preloader">
	    <div class="spinner">
	        <div class="pre-bounce1"></div>
	        <div class="pre-bounce2"></div>
	    </div>
	</div>
	
<div id="page" class="hfeed site">
	<a class="skip-link screen-reader-text" href="#content">跳至主內容區</a>

	
	
	
	<div id="masthead" class="site-header" role="banner" style="display:none;"> 
		<div class="header-wrap">
            <div class="container">
                <div class="row">
				<div class="col-md-4 col-sm-8 col-xs-12">
		        					<a href="/" title="果醬珍珍•JamJam"><img class="site-logo" src="/wp-content/uploads/2018/09/grape_320.png" alt="果醬珍珍•JamJam"></a>
		        				</div>
				<div class="col-md-8 col-sm-4 col-xs-12">
					<div class="btn-menu"></div>
					<nav id="mainnav" class="mainnav" role="navigation">
						<div class="menu-jamleecute-container"><ul id="menu-jamleecute" class="menu"><li id="menu-item-1691" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-1691"><a href="/category/programming-statistics/"> 程式與統計</a></li>
<li id="menu-item-626" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-626"><a href="/category/travel/">旅遊</a></li>
<li id="menu-item-627" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-627"><a href="/category/foodie/">美食</a></li>
<li id="menu-item-2415" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2415"><a href="/%e7%b0%a1%e4%bb%8b/">關於我</a></li>
</ul></div>					</nav>
				</div>
				</div>
			</div>
		</div>
	</div>
	
	
	

	
	<style>
	.header-img-bounding-box {
	  background-image: url("/wp-content/uploads/2018/09/%E8%83%8C%E6%99%AF%E5%8E%9F%E5%9C%96_v2.jpg");
    background-size:     cover;                      /* <------ */
    background-repeat:   no-repeat;
    background-position: center center;              /* optional, center the image */
/* 	height: 300px; */
	padding-top:55px;
	padding-bottom:55px;
		}
		.title_img {
		    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 50%;
		min-width: 340px;
			max-width: 800px;

		}
		
		
		.subtitle_img {
			display: block;
    margin-left: auto;
    margin-right: auto;
    width: 50%;
		min-width: 340px;
			max-width: 800px;
		}
		
		
		.subtitle_overlay {
			margin-top:20px;
			background-color: rgba(255, 255, 255, 0.7);
			padding-bottom:8px;
		}
	</style>
	
	<div>
		<a href="/">
		<div class="header-img-bounding-box">

			<img src="/wp-content/uploads/2018/09/title.png" class="title_img">
			<div class="subtitle_overlay">
			<img src="/wp-content/uploads/2018/09/subtitle.png" class="subtitle_img">
			</div>			
		</div>	
		</a>
	</div>
	
	
	
	<header>
		<nav id="my_mainnav" class="my_mainnav" role="navigation">
				<div class="menu-jamleecute-container"><ul id="menu-jamleecute-1" class="menu"><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-1691"><a href="/category/programming-statistics/"> 程式與統計</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-626"><a href="/category/travel/">旅遊</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-627"><a href="/category/foodie/">美食</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2415"><a href="/%e7%b0%a1%e4%bb%8b/">關於我</a></li>
</ul></div>		</nav>
	</header>

	
	
	
	<div id="content" class="page-wrap">
		
		
		
		<style>
			.home_intro {
				    margin: 0 12%;
					/*height: 400px;*/
    				/*background: yellow;*/
				
			}
			
			.home_intro .content{
				display: flex; 
    display: -webkit-flex;
    justify-content: center;
    -webkit-justify-content: center;
    flex-wrap: wrap;
			}
			.home_intro .content .intro {
				width: 240px;
    			
				margin: 0 auto;
				
			}
			.home_intro .content .intro .image {
				/*width: 240px;
    			padding: 0px;
				margin: 0 auto;
				display: inline-block;*/
			  position: relative;
			  width: 240px;
			  height: 240px;
			  overflow: hidden;
			  border-radius: 50%;
			}
			.home_intro .content .description{
				padding: 0 0px;
    			margin: 0 auto;
    			width: 240px;
				text-align: center;
			}
			.home_intro .content .social_icon {
				margin: 0 7px;
			}
			
			.circular--landscape {
			  display: inline-block;
			  position: relative;
			  width: 200px;
			  height: 200px;
			  overflow: hidden;
			  border-radius: 50%;
			}

			.home_intro .content .intro .image img {
			  width: auto;
			  height: 100%;
			  /*margin-left: -50px;*/
			}
		</style>
		

					
				
		
		<div class="container content-wrapper">
			<div class="row">	
				
				
				
	
	
	<div id="primary" class="content-area col-md-9 ">

		
		<main id="main" class="post-wrap" role="main">

		
			
<article id="post-2875" class="post-2875 post type-post status-publish format-standard has-post-thumbnail hentry category-programming-statistics category-statistics-model">
	
	
			<div class="entry-thumb">
			<img width="7827" height="4404" src="/wp-content/uploads/2019/04/ben-neale-193521-unsplash.jpg" class="attachment-large-thumb size-large-thumb wp-post-image" alt="ben-neale-193521-unsplash" loading="lazy" srcset="/wp-content/uploads/2019/04/ben-neale-193521-unsplash.jpg 7827w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-300x169.jpg 300w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-768x432.jpg 768w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-1024x576.jpg 1024w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-830x467.jpg 830w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-230x129.jpg 230w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-350x197.jpg 350w,/wp-content/uploads/2019/04/ben-neale-193521-unsplash-480x270.jpg 480w" sizes="(max-width: 7827px) 100vw, 7827px">		</div>
		
	<header class="entry-header">
		
		<div class="meta-post">
			<a href="/category/programming-statistics/" title=" 程式與統計" class="post-cat"> 程式與統計</a><a href="/category/programming-statistics/statistics-model/" title="統計模型" class="post-cat">統計模型</a>		</div>

		<h1 class="title-post entry-title">Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言</h1>
				<div class="single-meta">
			<span class="posted-on">發表於 <a href="/gradient-boosting-machines-gbm/" rel="bookmark"><time class="entry-date published updated" datetime="2019-04-14T22:54:16+08:00">2019-04-14</time></a></span><span class="byline"> <span class="author vcard"><a class="url fn n" href="/author/jamleecute/">jamleecute</a></span></span>		</div>
			</header>

	

	<div class="entry-content">
		<p>Gradient Boosting Machines 是一個超級受歡迎的機器學習法，在許多領域上都有非常成功的表現，也是Kaggle競賽時常勝出的主要演算法之一。有別於<a href="/random-forests-%e9%9a%a8%e6%a9%9f%e6%a3%ae%e6%9e%97/" target="_blank" rel="noopener noreferrer">隨機森林</a>集成眾多深且獨立的樹模型，GBM則是集成諸多淺且弱連續的樹模型，每個樹模型會以之前的樹模型為基礎去學習和精進，結果通常是難以擊敗的。</p>
<h3>套件與資料準備</h3>
<p></p>

		<div id="crayon-60ed86a824300825535400" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
library(rsample)      # data splitting 
library(gbm)          # basic implementation
library(xgboost)      # a faster implementation of gbm
library(caret)        # an aggregator package for performing many machine learning models
library(h2o)          # a java-based platform
library(pdp)          # model visualization
library(ggplot2)      # model visualization
library(lime)         # model visualization
library(vtreat)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824300825535400-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824300825535400-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824300825535400-1">library(rsample)      # data splitting </div><div class="crayon-line" id="crayon-60ed86a824300825535400-2">library(gbm)          # basic implementation</div><div class="crayon-line" id="crayon-60ed86a824300825535400-3">library(xgboost)      # a faster implementation of gbm</div><div class="crayon-line" id="crayon-60ed86a824300825535400-4">library(caret)        # an aggregator package for performing many machine learning models</div><div class="crayon-line" id="crayon-60ed86a824300825535400-5">library(h2o)          # a java-based platform</div><div class="crayon-line" id="crayon-60ed86a824300825535400-6">library(pdp)          # model visualization</div><div class="crayon-line" id="crayon-60ed86a824300825535400-7">library(ggplot2)      # model visualization</div><div class="crayon-line" id="crayon-60ed86a824300825535400-8">library(lime)         # model visualization</div><div class="crayon-line" id="crayon-60ed86a824300825535400-9">library(vtreat)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>使用AmesHousing套件中的Ames Housing數據，並將數據切分為7:3的訓練測試比例。</p>

		<div id="crayon-60ed86a824305027785490" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# Create training (70%) and test (30%) sets for the AmesHousing::make_ames() data.
# Use set.seed for reproducibility
set.seed(123)
ames_split <- initial_split(AmesHousing::make_ames(), prop = .7)
ames_train <- training(ames_split)
ames_test  <- testing(ames_split)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824305027785490-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824305027785490-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824305027785490-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824305027785490-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824305027785490-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824305027785490-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824305027785490-1"># Create training (70%) and test (30%) sets for the AmesHousing::make_ames() data.</div><div class="crayon-line" id="crayon-60ed86a824305027785490-2"># Use set.seed for reproducibility</div><div class="crayon-line" id="crayon-60ed86a824305027785490-3">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824305027785490-4">ames_split <div class="crayon-line" id="crayon-60ed86a824305027785490-5">ames_train <div class="crayon-line" id="crayon-60ed86a824305027785490-6">ames_test  </div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>tree-based演算法往往可以將未處理資料配適的很好(即不需要特別將資料進行normalize, center,scale)，所以在以下筆記中將聚焦在如何使用多種不同套件執行GBMs。而雖然在這邊沒有去進行資料前處理，但我們仍可花時間透過處理變數特徵使得模型成效更佳。</p>
<h3>Gradient Boosting Machines’ Advantage & Disadvantages</h3>
<h4>優勢</h4>
<ol>
<li>產生的預測精準度通常無人能打敗</li>
<li>擁有許多彈性 – 可以針對不同的Loss Function來進行優化(*Loss Function即所有需要被「最小化」的目標函式，一個最常用來尋找使目標函式最小值的資料點的方法即為gradient descent)，且有hyperparameters的參數選項可以tuning，好讓目標函式配適的很好。</li>
<li>不需要資料前處理 – 通常可以很好的處理類別和數值型變數。</li>
<li>可以處理遺失值 – 不需要空值填補。</li>
</ol>
<h4>劣勢</h4>
<ol>
<li>GBMs會持續優化模型來最小化誤差。這樣可能會過度擬和極端值的部分而造成過度配適。因此必須綜合使用cross validation來銷除這個情況。</li>
<li>計算上成本非常高 – GBMs通常會包含許多樹(>1000)，會佔用許多時間和記憶體。</li>
<li>模型彈性度高，導致許多參數會影響grid search的流程(比如說迭代次數，樹的深度，參數正規化等等)，在tuning模型的時候會需要大型的grid search過程。</li>
<li>可解釋程度稍稍少了一點，但有許多輔助工具如變數重要性、partial dependence plots, LIME等。</li>
</ol>
<h3>Gradient Boosting Machines (GBMs) 概念</h3>
<p>許多監督式機器學習模型都是建立在單一預測模的基礎上（比如說linear regression, penalized models or regularized regression, naive Bayes, support vector machines)。而則有像是Bagging和Random Forests這種集成學習演算法(ensemble learning)，集成眾多預測模型並單純平均每個模型的預測結果得出預測值。另外一種則是Boosting系列，是基於不一樣的建設性策略來進行集成學習。</p>
<p>Boosting的主要概念就是將新模型「有順序、循序漸進」的加入集成學習。在每一次迭代中，會新增一個新的(new)、弱的(weak)、base-learner模型，針對到目前為止集成學習的誤差進行訓練。</p>
<p>以下進一步解釋boosting models的特徵關鍵字：</p>
<ol>
<li>Base-learning models: Boosting是一個迭代改善任何弱學習模型的框架。許多Gradienet Boosting應用可允使用者任意加入眾多類型的weak learners模型。然而在實務上，boosted algorithm幾乎總是使用Decision Trees當作base-learner。也因此本學習筆記會主要討論boosting regression trees的應用。</li>
<li>Training weak models: 所謂的「弱模型(weak model)」指的是模型的錯誤率只有稍稍比隨機猜測好一點點的模型。Boosting背後的概念就是每一個順序模型都會建立一個僅稍稍改善殘餘誤差的弱模型(weak model)。以決策樹來說，較淺的樹就是弱模型的代表。一般來說，淺的決策樹模型切割數約在1~6之間。綜合多個弱模型會有以下好處(將較於綜合多個強模型)：
<ul>
<li>速率: 建構弱模型在計算成本上是便宜的。</li>
<li>精準度的改善: weak model允許演算法「慢慢學習」；即在模型表現不好的新領域進行些微調整。一般來說，慢慢學習的統計方法通常表現不錯。</li>
<li>避免overfitting: 由於在集成學習過程中，每一次訓練模型僅稍稍貢獻一點點額外的成效改善，使得我們有辦法即時在偵測到overfitting時即停止學習(使用的cross validation)。</li>
</ul>
</li>
<li>針對集成學習的殘餘誤差有順序性的訓練: Boosted trees是有順序性的；每一個樹模型都是依據前面的樹模型所得的資訊而訓練而成。基本的boosted regression trees演算法可被一般化為以下步驟(其中x代表features而y代表目標回應變數)：
<ul>
<li>依據原始資料配適一棵樹模型: \(F_{1}(x) = y\)</li>
<li>並依據先前的殘餘誤差訓練下一棵樹模型: \(h_{1}(x) = y – F_{1}(x)\)</li>
<li>將新的樹新增到演算法：\(F_{2}(x) = F_{1}(x) + h_{1}(x)\)</li>
<li>再一次依據殘餘誤差訓練下一棵樹模型 = \(h_{2}(x) = y – F_{2}(x)\)</li>
<li>將新的樹新增到演算法：\(F_{3}(x) = F_{2}(x) + h_{2}(x)\)</li>
<li>持續這個過程直到一些機制(如cross validation)告訴演算法可以停止。</li>
</ul>
</li>
</ol>
<p>boosted regression trees的基本演算法概念可以一般化為以下，即最終模型是b個獨立的回歸樹模型階段性相加的結果：<br>
\[ f(x) = \sum_{b=1}^B f^b(x) \]</p>
<h3>Gradient descent</h3>
<p>許多演算法，包括Decision trees，都聚焦在最小化殘差，也因此皆強調「MSE Loss Function」的目標函式。上面所討論到的演算法摘要了boosting法如何循序漸進地利用有順序新的弱回歸樹模型來配飾真實資料趨勢並最小化誤差。這個就是gradient boosting用來最小化Meas Squared Error (MSE) Loss Funciton的方法。雖然有時候我們會想要聚焦在其他Loss function上，如Mean Absolute Error(MAE)，或是遇到分類問題時所使用的deviance。而<strong><em>gradient</em></strong> boosting machines的命名則是取自於這個方法可以擴張至除了MSE以外的Loss function。</p>
<p>Gradient Boosting被認為是一個<strong><em>gradient descent</em></strong>(梯度下降)的演算法。Gradient Descent是一個非常通用的最適化演算法，能夠找到解決各種問題的最佳解。Gradient Descent的概念就是迭代的微調整參數來來最小化損失函數Loss Funciton。Gradient Descent會在給定的一組參數\(\theta\)區間，衡量局部Loss(cost) function的gradient，並沿著gradient下降的方向。直到gradient為0時，則找到局部最小值。</p>
<p><strong><em>Gradient descent</em></strong>可以被應用在任意可微分的loss function上，所以讓GBMs可以針對感興趣的loss function來尋找最適解。在gradient descent中一個重要的參數就是由_learning rate_s所決定的每次的變動率(size of steps)。較小的變動率會使得模型訓練過程中會迭代多次來尋找最小值，而過高的變動率則可能會讓模型錯過最小值和遠遠偏離初始值。</p>
<p>此外，並不是所有的loss function都是凸形的(convex)(如碗型)。可能會有局部的最小值、平坦高原或不規則地形等，使得尋找global minimum變得困難。<strong><em>Stochastic gradient descent</em></strong>(隨機梯度下降)則可處理這樣的問題，透過抽樣一部分比例的觀察值（通常不重複），並使用此子集合建立下一個模型。這使得演算法變得更快一些，但是隨機抽樣的隨機性亦造成下降的loss function gradient的隨機性。雖然這個隨機性使得演算法無法找到absolute global minimum(全域最小值)，但隨機性確實能讓演算法跳脫local minimum(局部最小值)、平坦高原等局部解，並接近全域的最小值。</p>
<p>我們在下一個階段即能看到如何透過多種hyperparameters參數選項來調整如何處理loss function的gradient descent。</p>
<h3>Tuning</h3>
<p>GBMs的好處與壞處就是該演算法提供多個調整參數。好處是GBMs在執行上非常具彈性，但壞處就是在調整與尋找最適參數組合上會很耗時。以下為幾個GBMs最常見的調整hyperparameters參數：</p>
<ul>
<li>決策樹模型的數量：總共要配適的決策樹模型數量。GBMs通常會需要很多很多樹，但不像random Forests，GBMs是可以過度擬和(overfit)的，所以他演算的目標是尋找最適決策樹數量使得感興趣的loss function最小化。</li>
<li>決策樹的深度：d,每棵樹模型的切割(split)數。用來控制boosted集成模型的複雜度。通常\(d=1\)的效果不錯，即此弱模型是由一次分割所得的樹模型所組成。而更常見的split數可能介在\(1<d<10\)之間。</li>
<li>Learning rate: 決定演算法計算gradient descent的速率。較慢的learning rate速率，可以避免overfitting的機會，但同時也會增加尋找最適解的時間。learning rate也被稱作shrinkage。</li>
<li>subsampling: 控制是否要使用原始訓練資料部分比例的抽樣子集合。使用少於100%的訓練資料表示你將使用stochastic gradient descent，這將有助於避免overfitting以及陷在loss function gradient的局部最小最大值。</li>
</ul>
<p>而在本學習筆記中，亦會介紹到專屬於特定package的調整hyperparameters參數，用來改善模型成效以及模型訓練與調整的效率。</p>
<h3>使用R實作Gradient Boosting Machines</h3>
<p>有很多執行GBMs和GBM變種的套件。而本學習筆記會cover到的幾個最受歡迎的套件，包括：</p>
<ul>
<li>gbm: 最原始的執行GBMs的套件。</li>
<li>xgboost: 一個更快速且有效的gradient boosting架構（後端為c++）。</li>
<li>h2o: 強大的java-based的介面，提供平行分散演算法和高銷率的生產。</li>
</ul>
<h3>gbm</h3>
<p>gbm套件是R裡面最原始執行GBM的套件。是來自於Freund & Schapire’s <a href="http://www.site.uottawa.ca/~stan/csi5387/boost-tut-ppr.pdf" target="_blank" rel="noopener noreferrer">AdaBoost algorithm</a>的Friedman’s <a href="https://statweb.stanford.edu/~jhf/ftp/trebst.pdf" target="_blank" rel="noopener noreferrer">gradient boosting machine</a>延伸。由Mark Landry撰寫的GBM套件簡報可參考<a href="https://www.slideshare.net/mark_landry/gbm-package-in-r" target="_blank" rel="noopener noreferrer">此連結</a>。</p>
<p>gbm套件幾個功能與特色包括：</p>
<ul>
<li>Stochastic GBM(隨機 GBM)</li>
<li>可支援到1024個factor levels</li>
<li>支援「分類」和「回歸」樹</li>
<li>包括許多loss functions</li>
<li>提供Out-of-bag 估計法來尋找最適的迭代次數</li>
<li>容易overfitting – 因為套件中沒有自動使用提早煞車功能來偵測overfitting</li>
<li>如果內部使用cross-validation，這可以被平行分散到所有機器核心</li>
<li>目前gbm套件正在進行重新建構與重寫(並已持續一段時間)。</li>
</ul>
<h4>基本的gbm實作</h4>
<p>gbm套件中有兩個主要的訓練用函數：gbm::gbm跟gbm::fit。</p>
<ul>
<li>gbm::gbm – 使用「formula介面」來設定模型。</li>
<li>gbm::fit – 使用「x & y矩陣」來設定模型。</li>
</ul>
<p><span style="color: #9f6ad4;">當變數量很大的時候，使用「x & y 矩陣」會比「formula」介面來的更有效率。</span></p>
<p>gbm()函數預設的幾個參數值如下：</p>
<ul>
<li>learning rate(shrinkage):0.1。學習步伐，通常越小的學習步伐會需要越多模型數(n.tree)來找到最小的MSE。而預設n.tree為100，是相當足夠的。</li>
<li>number of trees(n.tree): 100。總迭代次數(新增模型數)。</li>
<li>depth of tree(interaction.depth): 1。最淺的樹（最弱的模型）。</li>
<li>bag.fraction: 0.5。訓練資料集有多少比例會被抽樣做為下一個樹模型的基礎。用來替模型注入隨機性。</li>
<li>train.fraction: 1。模型首次使用訓練資料的比例，剩餘的觀測資料則最為OOB sample用來估計loss function用。</li>
<li>cv.folds: 0。如果使用>1的cross validation folds，除了會回傳該參數組合下的模型配適結果，也會估計cv.error。</li>
<li>verbose: 預設為FALSE。決定是否要印出程序和成效指標。</li>
<li>n.cores: 使用的CPU核心數。由於在使用cross validation的時候，loop會將不同CV folds分配到不同核心。沒特別設定的話會使用偵測機器核心數函數來處理parallele::detectCores。</li>
</ul>
<p>以下我們來建立一個學習步伐為0.001且模型數量為10000的GBMs。並使用5 folds的交叉驗證計算cross-validated error。</p>

		<div id="crayon-60ed86a824308976057359" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# 使抽樣結果可以重複
set.seed(123)

# train GBM model
system.time(
  gbm.fit <- gbm(
  formula = Sale_Price ~ .,
  distribution = "gaussian",
  data = ames_train,
  n.trees = 10000, # 總迭代次數
  interaction.depth = 1, # 弱模型的切割數
  shrinkage = 0.001, # 學習步伐
  cv.folds = 5, # cross validation folds
  n.cores = NULL, # will use all cores by default
  verbose = FALSE
  )  
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824308976057359-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824308976057359-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824308976057359-1"># 使抽樣結果可以重複</div><div class="crayon-line" id="crayon-60ed86a824308976057359-2">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824308976057359-3"> </div><div class="crayon-line" id="crayon-60ed86a824308976057359-4"># train GBM model</div><div class="crayon-line" id="crayon-60ed86a824308976057359-5">system.time(</div><div class="crayon-line" id="crayon-60ed86a824308976057359-6">  gbm.fit <div class="crayon-line" id="crayon-60ed86a824308976057359-7">  formula = Sale_Price ~ .,</div><div class="crayon-line" id="crayon-60ed86a824308976057359-8">  distribution = "gaussian",</div><div class="crayon-line" id="crayon-60ed86a824308976057359-9">  data = ames_train,</div><div class="crayon-line" id="crayon-60ed86a824308976057359-10">  n.trees = 10000, # 總迭代次數</div><div class="crayon-line" id="crayon-60ed86a824308976057359-11">  interaction.depth = 1, # 弱模型的切割數</div><div class="crayon-line" id="crayon-60ed86a824308976057359-12">  shrinkage = 0.001, # 學習步伐</div><div class="crayon-line" id="crayon-60ed86a824308976057359-13">  cv.folds = 5, # cross validation folds</div><div class="crayon-line" id="crayon-60ed86a824308976057359-14">  n.cores = NULL, # will use all cores by default</div><div class="crayon-line" id="crayon-60ed86a824308976057359-15">  verbose = FALSE</div><div class="crayon-line" id="crayon-60ed86a824308976057359-16">  )  </div><div class="crayon-line" id="crayon-60ed86a824308976057359-17">)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82430b906908257" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    user  system elapsed 
##  23.348   0.332  80.086
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82430b906908257-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82430b906908257-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82430b906908257-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82430b906908257-1">##    user  system elapsed </div><div class="crayon-line" id="crayon-60ed86a82430b906908257-2">##  23.348   0.332  80.086</div><div class="crayon-line" id="crayon-60ed86a82430b906908257-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>GBMs模型約花80秒(約1分多鐘)。</p>
<p>將模型結果印出。結果包括文字資訊以及每一次迭代次數所對應的loss function(squared error loss)變化。</p>

		<div id="crayon-60ed86a82430c474758228" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
print(gbm.fit) </textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82430c474758228-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82430c474758228-1">print(gbm.fit) </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82430d914506885" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## gbm(formula = Sale_Price ~ ., distribution = "gaussian", data = ames_train, 
##     n.trees = 10000, interaction.depth = 1, shrinkage = 0.001, 
##     cv.folds = 5, verbose = FALSE, n.cores = NULL)
## A gradient boosted model with gaussian loss function.
## 10000 iterations were performed.
## The best cross-validation iteration was 10000.
## There were 80 predictors of which 45 had non-zero influence.
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82430d914506885-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82430d914506885-1">## gbm(formula = Sale_Price ~ ., distribution = "gaussian", data = ames_train, </div><div class="crayon-line" id="crayon-60ed86a82430d914506885-2">##     n.trees = 10000, interaction.depth = 1, shrinkage = 0.001, </div><div class="crayon-line" id="crayon-60ed86a82430d914506885-3">##     cv.folds = 5, verbose = FALSE, n.cores = NULL)</div><div class="crayon-line" id="crayon-60ed86a82430d914506885-4">## A gradient boosted model with gaussian loss function.</div><div class="crayon-line" id="crayon-60ed86a82430d914506885-5">## 10000 iterations were performed.</div><div class="crayon-line" id="crayon-60ed86a82430d914506885-6">## The best cross-validation iteration was 10000.</div><div class="crayon-line" id="crayon-60ed86a82430d914506885-7">## There were 80 predictors of which 45 had non-zero influence.</div><div class="crayon-line" id="crayon-60ed86a82430d914506885-8"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>模型結果資訊是由list所儲存。可以使用索引的方式取出。</p>
<p>比如說我們來看最小的CV RMSE值。</p>

		<div id="crayon-60ed86a82430f107418275" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
sqrt(min(gbm.fit$cv.error))</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82430f107418275-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82430f107418275-1">sqrt(min(gbm.fit$cv.error))</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824310577690534" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 29133.33
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824310577690534-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824310577690534-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824310577690534-1">## [1] 29133.33</div><div class="crayon-line" id="crayon-60ed86a824310577690534-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>表示平均來說模型估計值離真實Sale_Price差了約30K。</p>
<p>我們也可以透過以下方式將GBMs找尋最佳迭代數的過程繪出：(其中黑線的為訓練誤差(train.error)，綠線為cv.error, 若method使用“test”，則會有紅線表示valid.error)</p>

		<div id="crayon-60ed86a824311417293642" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
gbm.perf(object = gbm.fit, plot.it = TRUE,method = "cv")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824311417293642-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824311417293642-1">gbm.perf(object = gbm.fit, plot.it = TRUE,method = "cv")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-6-1-1.png" alt="gradient boosting machines, GBM"></p>

		<div id="crayon-60ed86a824312811217667" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 10000
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824312811217667-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824312811217667-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824312811217667-1">## [1] 10000</div><div class="crayon-line" id="crayon-60ed86a824312811217667-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>可以發現以此小學習步伐(0.001)，會需要很多模型來接近最小的loss function(使cv.error最小化)，最佳迭代數為10000。</p>
<h4>Tuning</h4>
<p>「手動tuning」</p>
<p>假設我們將學習步伐加大為0.1，迭代模型數降低為5000，且模型複雜度增加到3 splits。</p>

		<div id="crayon-60ed86a824314499246202" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# for reproducibility
set.seed(123)

# train GBM model
system.time(
gbm.fit2 <- gbm(
  formula = Sale_Price ~ .,
  distribution = "gaussian",
  data = ames_train,
  n.trees = 5000,
  interaction.depth = 3,
  shrinkage = 0.1,
  cv.folds = 5,
  n.cores = NULL, # will use all cores by default
  verbose = FALSE
  ) 
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824314499246202-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824314499246202-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824314499246202-1"># for reproducibility</div><div class="crayon-line" id="crayon-60ed86a824314499246202-2">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824314499246202-3"> </div><div class="crayon-line" id="crayon-60ed86a824314499246202-4"># train GBM model</div><div class="crayon-line" id="crayon-60ed86a824314499246202-5">system.time(</div><div class="crayon-line" id="crayon-60ed86a824314499246202-6">gbm.fit2 <div class="crayon-line" id="crayon-60ed86a824314499246202-7">  formula = Sale_Price ~ .,</div><div class="crayon-line" id="crayon-60ed86a824314499246202-8">  distribution = "gaussian",</div><div class="crayon-line" id="crayon-60ed86a824314499246202-9">  data = ames_train,</div><div class="crayon-line" id="crayon-60ed86a824314499246202-10">  n.trees = 5000,</div><div class="crayon-line" id="crayon-60ed86a824314499246202-11">  interaction.depth = 3,</div><div class="crayon-line" id="crayon-60ed86a824314499246202-12">  shrinkage = 0.1,</div><div class="crayon-line" id="crayon-60ed86a824314499246202-13">  cv.folds = 5,</div><div class="crayon-line" id="crayon-60ed86a824314499246202-14">  n.cores = NULL, # will use all cores by default</div><div class="crayon-line" id="crayon-60ed86a824314499246202-15">  verbose = FALSE</div><div class="crayon-line" id="crayon-60ed86a824314499246202-16">  ) </div><div class="crayon-line" id="crayon-60ed86a824314499246202-17">)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824315294276476" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    user  system elapsed 
##  35.555   1.314 151.695
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824315294276476-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824315294276476-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824315294276476-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824315294276476-1">##    user  system elapsed </div><div class="crayon-line" id="crayon-60ed86a824315294276476-2">##  35.555   1.314 151.695</div><div class="crayon-line" id="crayon-60ed86a824315294276476-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>調大步伐後(0.1)，花的時間變多為151秒(2.5分鐘)，GBMs模型最小cv.error變得更低(23K)。<br>
(v.s.小步伐(0.001)的cv.error: 29K)</p>

		<div id="crayon-60ed86a824316775476999" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
sqrt(min(gbm.fit2$cv.error))</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824316775476999-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824316775476999-1">sqrt(min(gbm.fit2$cv.error))</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824317699188136" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 23112.1
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824317699188136-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824317699188136-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824317699188136-1">## [1] 23112.1</div><div class="crayon-line" id="crayon-60ed86a824317699188136-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>將模型結果印出。最佳迭代數(所需模型數)為1260。</p>

		<div id="crayon-60ed86a824318441806392" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
gbm.perf(object = gbm.fit2, method = "cv")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824318441806392-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824318441806392-1">gbm.perf(object = gbm.fit2, method = "cv")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-9-1-1.png" alt="gradient boosting machines, GBM"></p>

		<div id="crayon-60ed86a82431a800315381" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 1260
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82431a800315381-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82431a800315381-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82431a800315381-1">## [1] 1260</div><div class="crayon-line" id="crayon-60ed86a82431a800315381-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>「grid search自動化tuning」</p>
<p>因為手動調整參數是沒效率的，我們來建立hyperparameters grid並自動套用grid search。</p>

		<div id="crayon-60ed86a82431b639428579" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# create hyperparameter grid
hyper_grid <- expand.grid(
  shrinkage = c(.01, .1, .3), # 學習步伐
  interaction.depth = c(1, 3, 5), # 模型切割數
  n.minobsinnode = c(5, 10, 15), # 節點最小觀測值個數
  bag.fraction = c(.65, .8, 1), # 使用隨機梯度下降(<1)
  optimal_trees = 0,               # 儲存最適模型樹的欄位
  min_RMSE = 0                     # 儲存最小均方差的欄位
)

# total number of combinations
nrow(hyper_grid)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82431b639428579-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82431b639428579-1"># create hyperparameter grid</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-2">hyper_grid <div class="crayon-line" id="crayon-60ed86a82431b639428579-3">  shrinkage = c(.01, .1, .3), # 學習步伐</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-4">  interaction.depth = c(1, 3, 5), # 模型切割數</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-5">  n.minobsinnode = c(5, 10, 15), # 節點最小觀測值個數</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-6">  bag.fraction = c(.65, .8, 1), # 使用隨機梯度下降(<div class="crayon-line" id="crayon-60ed86a82431b639428579-7">  optimal_trees = 0,               # 儲存最適模型樹的欄位</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-8">  min_RMSE = 0                     # 儲存最小均方差的欄位</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-9">)</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-10"> </div><div class="crayon-line" id="crayon-60ed86a82431b639428579-11"># total number of combinations</div><div class="crayon-line" id="crayon-60ed86a82431b639428579-12">nrow(hyper_grid)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82431c531927981" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 81
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82431c531927981-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82431c531927981-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82431c531927981-1">## [1] 81</div><div class="crayon-line" id="crayon-60ed86a82431c531927981-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>我們一一測試以上81種超參數排列組合的效果，並指定使用5000個樹模型。<br>
另外，為了降低執行的時間，有別於使用cross validation，我們改使用75%的訓練資料，使用剩下的25%的資料來進行OOB評估效果。需要特別注意的是，當使用train.fraction參數時，模型會直接使用前XX %的資料來使用，因此需要確保說資料是隨機排列的。</p>
<p>先將資料進行隨機排列處理。</p>

		<div id="crayon-60ed86a82431d376636841" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# randomize data
random_index <- sample(1:nrow(ames_train), nrow(ames_train))
random_ames_train <- ames_train[random_index, ]</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82431d376636841-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82431d376636841-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82431d376636841-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82431d376636841-1"># randomize data</div><div class="crayon-line" id="crayon-60ed86a82431d376636841-2">random_index <div class="crayon-line" id="crayon-60ed86a82431d376636841-3">random_ames_train </div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>開始執行grid search</p>

		<div id="crayon-60ed86a82431f500641759" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# grid search 
for(i in 1:nrow(hyper_grid)) {

  # reproducibility
  set.seed(123)

  # train model
  gbm.tune <- gbm(
    formula = Sale_Price ~ .,
    distribution = "gaussian",
    data = random_ames_train,
    n.trees = 5000, # 使用5000個樹模型
    interaction.depth = hyper_grid$interaction.depth[i],
    shrinkage = hyper_grid$shrinkage[i],
    n.minobsinnode = hyper_grid$n.minobsinnode[i],
    bag.fraction = hyper_grid$bag.fraction[i],
    train.fraction = .75, # 使用75%的訓練資料，並用剩餘資料做OOB成效評估/驗證
    n.cores = NULL, # will use all cores by default
    verbose = FALSE
  )

  # 將每個GBM模型最小的模型代號和對應的驗證均方誤差(valid RMSE)回傳到
  hyper_grid$optimal_trees[i] <- which.min(gbm.tune$valid.error)
  hyper_grid$min_RMSE[i] <- sqrt(min(gbm.tune$valid.error))
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-21">21</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-22">22</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-23">23</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-24">24</div><div class="crayon-num" data-line="crayon-60ed86a82431f500641759-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82431f500641759-1"># grid search </div><div class="crayon-line" id="crayon-60ed86a82431f500641759-2">for(i in 1:nrow(hyper_grid)) {</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-3"> </div><div class="crayon-line" id="crayon-60ed86a82431f500641759-4">  # reproducibility</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-5">  set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-6"> </div><div class="crayon-line" id="crayon-60ed86a82431f500641759-7">  # train model</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-8">  gbm.tune <div class="crayon-line" id="crayon-60ed86a82431f500641759-9">    formula = Sale_Price ~ .,</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-10">    distribution = "gaussian",</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-11">    data = random_ames_train,</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-12">    n.trees = 5000, # 使用5000個樹模型</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-13">    interaction.depth = hyper_grid$interaction.depth[i],</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-14">    shrinkage = hyper_grid$shrinkage[i],</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-15">    n.minobsinnode = hyper_grid$n.minobsinnode[i],</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-16">    bag.fraction = hyper_grid$bag.fraction[i],</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-17">    train.fraction = .75, # 使用75%的訓練資料，並用剩餘資料做OOB成效評估/驗證</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-18">    n.cores = NULL, # will use all cores by default</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-19">    verbose = FALSE</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-20">  )</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-21"> </div><div class="crayon-line" id="crayon-60ed86a82431f500641759-22">  # 將每個GBM模型最小的模型代號和對應的驗證均方誤差(valid RMSE)回傳到</div><div class="crayon-line" id="crayon-60ed86a82431f500641759-23">  hyper_grid$optimal_trees[i] <div class="crayon-line" id="crayon-60ed86a82431f500641759-24">  hyper_grid$min_RMSE[i] <div class="crayon-line" id="crayon-60ed86a82431f500641759-25">}</div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>將每種參數組合的結果，依照RMSE由小到大排列，並取出排名前10的模型，查看參數組合細節。</p>

		<div id="crayon-60ed86a824320618565453" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
hyper_grid %>% 
  dplyr::arrange(min_RMSE) %>%
  head(10)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824320618565453-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824320618565453-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824320618565453-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824320618565453-1">hyper_grid %>% </div><div class="crayon-line" id="crayon-60ed86a824320618565453-2">  dplyr::arrange(min_RMSE) %>%</div><div class="crayon-line" id="crayon-60ed86a824320618565453-3">  head(10)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824321686702709" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    shrinkage interaction.depth n.minobsinnode bag.fraction optimal_trees
## 1       0.01                 5              5         0.65          3867
## 2       0.01                 5              5         0.80          4209
## 3       0.01                 5              5         1.00          4281
## 4       0.10                 3             10         0.80           489
## 5       0.01                 3              5         0.80          4777
## 6       0.01                 3             10         0.80          4919
## 7       0.01                 3              5         0.65          4997
## 8       0.01                 5             10         0.80          4123
## 9       0.01                 5             10         0.65          4850
## 10      0.01                 3             10         1.00          4794
##    min_RMSE
## 1  16647.87
## 2  16960.78
## 3  17084.29
## 4  17093.77
## 5  17121.26
## 6  17139.59
## 7  17139.88
## 8  17162.60
## 9  17247.72
## 10 17353.36
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824321686702709-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824321686702709-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824321686702709-1">##    shrinkage interaction.depth n.minobsinnode bag.fraction optimal_trees</div><div class="crayon-line" id="crayon-60ed86a824321686702709-2">## 1       0.01                 5              5         0.65          3867</div><div class="crayon-line" id="crayon-60ed86a824321686702709-3">## 2       0.01                 5              5         0.80          4209</div><div class="crayon-line" id="crayon-60ed86a824321686702709-4">## 3       0.01                 5              5         1.00          4281</div><div class="crayon-line" id="crayon-60ed86a824321686702709-5">## 4       0.10                 3             10         0.80           489</div><div class="crayon-line" id="crayon-60ed86a824321686702709-6">## 5       0.01                 3              5         0.80          4777</div><div class="crayon-line" id="crayon-60ed86a824321686702709-7">## 6       0.01                 3             10         0.80          4919</div><div class="crayon-line" id="crayon-60ed86a824321686702709-8">## 7       0.01                 3              5         0.65          4997</div><div class="crayon-line" id="crayon-60ed86a824321686702709-9">## 8       0.01                 5             10         0.80          4123</div><div class="crayon-line" id="crayon-60ed86a824321686702709-10">## 9       0.01                 5             10         0.65          4850</div><div class="crayon-line" id="crayon-60ed86a824321686702709-11">## 10      0.01                 3             10         1.00          4794</div><div class="crayon-line" id="crayon-60ed86a824321686702709-12">##    min_RMSE</div><div class="crayon-line" id="crayon-60ed86a824321686702709-13">## 1  16647.87</div><div class="crayon-line" id="crayon-60ed86a824321686702709-14">## 2  16960.78</div><div class="crayon-line" id="crayon-60ed86a824321686702709-15">## 3  17084.29</div><div class="crayon-line" id="crayon-60ed86a824321686702709-16">## 4  17093.77</div><div class="crayon-line" id="crayon-60ed86a824321686702709-17">## 5  17121.26</div><div class="crayon-line" id="crayon-60ed86a824321686702709-18">## 6  17139.59</div><div class="crayon-line" id="crayon-60ed86a824321686702709-19">## 7  17139.88</div><div class="crayon-line" id="crayon-60ed86a824321686702709-20">## 8  17162.60</div><div class="crayon-line" id="crayon-60ed86a824321686702709-21">## 9  17247.72</div><div class="crayon-line" id="crayon-60ed86a824321686702709-22">## 10 17353.36</div><div class="crayon-line" id="crayon-60ed86a824321686702709-23"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>我們可以看到以下幾點：</p>
<ol>
<li>最佳模型的最小RMSE(17K)，較先前的RMSE(23K)降低了有6K左右。</li>
<li>前十的模型的學習步伐都小於0.3，表示較小的學習步伐在尋找最小誤差的模型效果是不錯的。</li>
<li>前十的模型都選用>1切割數的樹模型，。</li>
<li>十個模型有8個模型都使用bag.fraction < 1的隨機梯度下降(即使用<100%的訓練資料集進行每個模型的訓練)，這將有助於避免overfitting以及陷在loss function gradient的局部最小最大值。</li>
<li>前十的模型中，也沒有使用採用節點觀測數大於等於15者。因為較小觀測數的節點較能捕捉到更多特徵。</li>
<li>部分參數組合所使用的最佳迭代數（總樹模型數）都很接近5000個。下次執行grid search時或許可以考慮增大樹模型數。</li>
</ol>
<p>根據以上測試，我們已更接近最適的參數組合區間，我們此時在此聚焦範圍內再一次執行81種超參數組合的最佳模型搜尋。</p>

		<div id="crayon-60ed86a824323594038532" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# 根據上一部的結果，調整參數區間與數值
hyper_grid_2 <- expand.grid(
  shrinkage = c(.01, .05, .1), # 聚焦更小的學習步伐
  interaction.depth = c(3, 5, 7), #聚焦>1的切割數
  n.minobsinnode = c(5, 7, 10), # 聚焦更小的節點觀測值數量
  bag.fraction = c(.65, .8, 1), # 不變
  optimal_trees = 0,               # a place to dump results
  min_RMSE = 0                     # a place to dump results
)

# total number of combinations
nrow(hyper_grid_2)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824323594038532-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824323594038532-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824323594038532-1"># 根據上一部的結果，調整參數區間與數值</div><div class="crayon-line" id="crayon-60ed86a824323594038532-2">hyper_grid_2 <div class="crayon-line" id="crayon-60ed86a824323594038532-3">  shrinkage = c(.01, .05, .1), # 聚焦更小的學習步伐</div><div class="crayon-line" id="crayon-60ed86a824323594038532-4">  interaction.depth = c(3, 5, 7), #聚焦>1的切割數</div><div class="crayon-line" id="crayon-60ed86a824323594038532-5">  n.minobsinnode = c(5, 7, 10), # 聚焦更小的節點觀測值數量</div><div class="crayon-line" id="crayon-60ed86a824323594038532-6">  bag.fraction = c(.65, .8, 1), # 不變</div><div class="crayon-line" id="crayon-60ed86a824323594038532-7">  optimal_trees = 0,               # a place to dump results</div><div class="crayon-line" id="crayon-60ed86a824323594038532-8">  min_RMSE = 0                     # a place to dump results</div><div class="crayon-line" id="crayon-60ed86a824323594038532-9">)</div><div class="crayon-line" id="crayon-60ed86a824323594038532-10"> </div><div class="crayon-line" id="crayon-60ed86a824323594038532-11"># total number of combinations</div><div class="crayon-line" id="crayon-60ed86a824323594038532-12">nrow(hyper_grid_2)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824324405183851" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 81
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824324405183851-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824324405183851-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824324405183851-1">## [1] 81</div><div class="crayon-line" id="crayon-60ed86a824324405183851-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>我們再一次的用for loop迴圈執行以上81種超參數組合的模型，找出每一次最適的模型與對應的最小誤差。</p>

		<div id="crayon-60ed86a824326517897835" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# grid search 
for(i in 1:nrow(hyper_grid_2)) {

  # reproducibility
  set.seed(123)

  # train model
  gbm.tune <- gbm(
    formula = Sale_Price ~ .,
    distribution = "gaussian",
    data = random_ames_train,
    n.trees = 6000,
    interaction.depth = hyper_grid_2$interaction.depth[i],
    shrinkage = hyper_grid_2$shrinkage[i],
    n.minobsinnode = hyper_grid_2$n.minobsinnode[i],
    bag.fraction = hyper_grid_2$bag.fraction[i],
    train.fraction = .75, # 使用剩餘的25%資料估計OOB誤差
    n.cores = NULL, # will use all cores by default
    verbose = FALSE
  )

  # add min training error and trees to grid
  hyper_grid_2$optimal_trees[i] <- which.min(gbm.tune$valid.error)
  hyper_grid_2$min_RMSE[i] <- sqrt(min(gbm.tune$valid.error))
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824326517897835-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-23">23</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-24">24</div><div class="crayon-num" data-line="crayon-60ed86a824326517897835-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824326517897835-1"># grid search </div><div class="crayon-line" id="crayon-60ed86a824326517897835-2">for(i in 1:nrow(hyper_grid_2)) {</div><div class="crayon-line" id="crayon-60ed86a824326517897835-3"> </div><div class="crayon-line" id="crayon-60ed86a824326517897835-4">  # reproducibility</div><div class="crayon-line" id="crayon-60ed86a824326517897835-5">  set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824326517897835-6"> </div><div class="crayon-line" id="crayon-60ed86a824326517897835-7">  # train model</div><div class="crayon-line" id="crayon-60ed86a824326517897835-8">  gbm.tune <div class="crayon-line" id="crayon-60ed86a824326517897835-9">    formula = Sale_Price ~ .,</div><div class="crayon-line" id="crayon-60ed86a824326517897835-10">    distribution = "gaussian",</div><div class="crayon-line" id="crayon-60ed86a824326517897835-11">    data = random_ames_train,</div><div class="crayon-line" id="crayon-60ed86a824326517897835-12">    n.trees = 6000,</div><div class="crayon-line" id="crayon-60ed86a824326517897835-13">    interaction.depth = hyper_grid_2$interaction.depth[i],</div><div class="crayon-line" id="crayon-60ed86a824326517897835-14">    shrinkage = hyper_grid_2$shrinkage[i],</div><div class="crayon-line" id="crayon-60ed86a824326517897835-15">    n.minobsinnode = hyper_grid_2$n.minobsinnode[i],</div><div class="crayon-line" id="crayon-60ed86a824326517897835-16">    bag.fraction = hyper_grid_2$bag.fraction[i],</div><div class="crayon-line" id="crayon-60ed86a824326517897835-17">    train.fraction = .75, # 使用剩餘的25%資料估計OOB誤差</div><div class="crayon-line" id="crayon-60ed86a824326517897835-18">    n.cores = NULL, # will use all cores by default</div><div class="crayon-line" id="crayon-60ed86a824326517897835-19">    verbose = FALSE</div><div class="crayon-line" id="crayon-60ed86a824326517897835-20">  )</div><div class="crayon-line" id="crayon-60ed86a824326517897835-21"> </div><div class="crayon-line" id="crayon-60ed86a824326517897835-22">  # add min training error and trees to grid</div><div class="crayon-line" id="crayon-60ed86a824326517897835-23">  hyper_grid_2$optimal_trees[i] <div class="crayon-line" id="crayon-60ed86a824326517897835-24">  hyper_grid_2$min_RMSE[i] <div class="crayon-line" id="crayon-60ed86a824326517897835-25">}</div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>檢視結果</p>

		<div id="crayon-60ed86a824327140921868" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
hyper_grid_2 %>% 
  dplyr::arrange(min_RMSE) %>%
  head(10)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824327140921868-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824327140921868-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824327140921868-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824327140921868-1">hyper_grid_2 %>% </div><div class="crayon-line" id="crayon-60ed86a824327140921868-2">  dplyr::arrange(min_RMSE) %>%</div><div class="crayon-line" id="crayon-60ed86a824327140921868-3">  head(10)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824328095295393" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    shrinkage interaction.depth n.minobsinnode bag.fraction
## 1       0.01                 5              5         0.65
## 2       0.01                 7              5         0.65
## 3       0.05                 5              5         0.65
## 4       0.01                 7              5         0.80
## 5       0.01                 7              7         0.65
## 6       0.05                 5             10         0.80
## 7       0.01                 5              5         0.80
## 8       0.01                 3              7         0.80
## 9       0.01                 5              7         0.65
## 10      0.01                 5              7         0.80
##    optimal_trees min_RMSE
## 1           3867 16647.87
## 2           2905 16782.26
## 3            640 16783.13
## 4           4193 16833.74
## 5           3275 16906.53
## 6            958 16933.12
## 7           4209 16960.78
## 8           5813 16998.79
## 9           4798 17003.94
## 10          4753 17004.20
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824328095295393-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824328095295393-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824328095295393-1">##    shrinkage interaction.depth n.minobsinnode bag.fraction</div><div class="crayon-line" id="crayon-60ed86a824328095295393-2">## 1       0.01                 5              5         0.65</div><div class="crayon-line" id="crayon-60ed86a824328095295393-3">## 2       0.01                 7              5         0.65</div><div class="crayon-line" id="crayon-60ed86a824328095295393-4">## 3       0.05                 5              5         0.65</div><div class="crayon-line" id="crayon-60ed86a824328095295393-5">## 4       0.01                 7              5         0.80</div><div class="crayon-line" id="crayon-60ed86a824328095295393-6">## 5       0.01                 7              7         0.65</div><div class="crayon-line" id="crayon-60ed86a824328095295393-7">## 6       0.05                 5             10         0.80</div><div class="crayon-line" id="crayon-60ed86a824328095295393-8">## 7       0.01                 5              5         0.80</div><div class="crayon-line" id="crayon-60ed86a824328095295393-9">## 8       0.01                 3              7         0.80</div><div class="crayon-line" id="crayon-60ed86a824328095295393-10">## 9       0.01                 5              7         0.65</div><div class="crayon-line" id="crayon-60ed86a824328095295393-11">## 10      0.01                 5              7         0.80</div><div class="crayon-line" id="crayon-60ed86a824328095295393-12">##    optimal_trees min_RMSE</div><div class="crayon-line" id="crayon-60ed86a824328095295393-13">## 1           3867 16647.87</div><div class="crayon-line" id="crayon-60ed86a824328095295393-14">## 2           2905 16782.26</div><div class="crayon-line" id="crayon-60ed86a824328095295393-15">## 3            640 16783.13</div><div class="crayon-line" id="crayon-60ed86a824328095295393-16">## 4           4193 16833.74</div><div class="crayon-line" id="crayon-60ed86a824328095295393-17">## 5           3275 16906.53</div><div class="crayon-line" id="crayon-60ed86a824328095295393-18">## 6            958 16933.12</div><div class="crayon-line" id="crayon-60ed86a824328095295393-19">## 7           4209 16960.78</div><div class="crayon-line" id="crayon-60ed86a824328095295393-20">## 8           5813 16998.79</div><div class="crayon-line" id="crayon-60ed86a824328095295393-21">## 9           4798 17003.94</div><div class="crayon-line" id="crayon-60ed86a824328095295393-22">## 10          4753 17004.20</div><div class="crayon-line" id="crayon-60ed86a824328095295393-23"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>本次結果與上一次結果十分類似。最佳模型和上一次選出的最佳模型是一樣的(相同的參數排列組合)，RMSE約是17K。</p>
<p>一旦找到最佳模型，我們則可使用該參數組合來train一個模型。也因為最佳模型約收斂在僅1634個樹模型，我們可以 訓練一個由1634個樹模型所組成的cross validation模型(使用CV來提供更穩健的誤差估計值)。</p>

		<div id="crayon-60ed86a82432a950918306" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# for reproducibility
set.seed(123)

system.time(
# train GBM model
gbm.fit.final <- gbm(
  formula = Sale_Price ~ .,
  distribution = "gaussian",
  data = ames_train,
  n.trees = 1634,
  interaction.depth = 5,
  shrinkage = 0.05,
  n.minobsinnode = 7,
  bag.fraction = .8, 
  train.fraction = 1, # 如果使用<1(xx%)的訓練比例，就會用剩餘的(1-XX%)資料估計OOB誤差
  cv.folds = 4, # 有別於使用OOB估計誤差，我們估計更穩健的CV誤差
  n.cores = NULL, # will use all cores by default
  verbose = FALSE
  )
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82432a950918306-20">20</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82432a950918306-1"># for reproducibility</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-2">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-3"> </div><div class="crayon-line" id="crayon-60ed86a82432a950918306-4">system.time(</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-5"># train GBM model</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-6">gbm.fit.final <div class="crayon-line" id="crayon-60ed86a82432a950918306-7">  formula = Sale_Price ~ .,</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-8">  distribution = "gaussian",</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-9">  data = ames_train,</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-10">  n.trees = 1634,</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-11">  interaction.depth = 5,</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-12">  shrinkage = 0.05,</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-13">  n.minobsinnode = 7,</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-14">  bag.fraction = .8, </div><div class="crayon-line" id="crayon-60ed86a82432a950918306-15">  train.fraction = 1, # 如果使用<div class="crayon-line" id="crayon-60ed86a82432a950918306-16">  cv.folds = 4, # 有別於使用OOB估計誤差，我們估計更穩健的CV誤差</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-17">  n.cores = NULL, # will use all cores by default</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-18">  verbose = FALSE</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-19">  )</div><div class="crayon-line" id="crayon-60ed86a82432a950918306-20">)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82432b781122535" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    user  system elapsed 
##  18.394   0.617  49.558
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82432b781122535-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82432b781122535-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82432b781122535-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82432b781122535-1">##    user  system elapsed </div><div class="crayon-line" id="crayon-60ed86a82432b781122535-2">##  18.394   0.617  49.558</div><div class="crayon-line" id="crayon-60ed86a82432b781122535-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>最佳模型的cv誤差如下(22K)。</p>

		<div id="crayon-60ed86a82432c426753710" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
sqrt(min(gbm.fit.final$cv.error)) # 必須是模型參數cv.folds > 1 才會回傳cv.error</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82432c426753710-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82432c426753710-1">sqrt(min(gbm.fit.final$cv.error)) # 必須是模型參數cv.folds > 1 才會回傳cv.error</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82432e589789534" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 22165.11
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82432e589789534-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82432e589789534-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82432e589789534-1">## [1] 22165.11</div><div class="crayon-line" id="crayon-60ed86a82432e589789534-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h4>視覺化</h4>
<h5>variable importance</h5>
<p>執行完最後的最佳模型後(gbm.fit.final)，我們會想要看對目標變數sale price來說最有影響力的解釋變數有哪些，以捕捉模型的「可解釋性」。我們可以使用summary()函數來回傳gmb模型中最具影響力的解釋變數清單(data frame & plot)。並可以使用gbm模型summary函式中的cBars參數來指定要顯示的解釋變數清單數(根據影響力排名)。預設使用相對影響力來計算變數重要性。以下說明計算變數重要性的兩個方法：</p>
<ol>
<li>method = relative.influence: 每棵樹在進行節點分割時，gbm會計算每個變數作為切點，切割後對模型誤差所帶來的改善(回歸模型的話就是MSE)。gbm於是會平均每個變數在不同樹模型的誤差改善值，當作變數影響力。具有越高平均誤差降低值得變數即被視作最具影響力的變數。</li>
<li>method = permutation.test.gbm: 模型會隨機置換（一次一個）不同預測變數，來計算個別變數的對預測性能的改善（使用所有training data），並平均每個變數在不同樹模型對正確率造成的改變量。具有越高正確率改變量的預測變數越具重要性。</li>
</ol>
<p></p>

		<div id="crayon-60ed86a82432f530200382" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
par(mar = c(5, 8, 1, 1))
# S3 method for class 'gbm'
summary(
  gbm.fit.final, # gbm object
  cBars = 10, # the number of bars to draw. length(object$var.names)
  plotit = TRUE, # an indicator as to whether the plot is generated.defult TRUE.
  method = relative.influence, # The function used to compute the relative influence. 亦可使用permutation.test.gbm
  las = 2
  )</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82432f530200382-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82432f530200382-1">par(mar = c(5, 8, 1, 1))</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-2"># S3 method for class 'gbm'</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-3">summary(</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-4">  gbm.fit.final, # gbm object</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-5">  cBars = 10, # the number of bars to draw. length(object$var.names)</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-6">  plotit = TRUE, # an indicator as to whether the plot is generated.defult TRUE.</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-7">  method = relative.influence, # The function used to compute the relative influence. 亦可使用permutation.test.gbm</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-8">  las = 2</div><div class="crayon-line" id="crayon-60ed86a82432f530200382-9">  )</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-19-1-1.png" alt="gradient boosting machines, GBM"></p>

		<div id="crayon-60ed86a824330924260763" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##                                   var      rel.inf
## Overall_Qual             Overall_Qual 4.199240e+01
## Gr_Liv_Area               Gr_Liv_Area 1.343609e+01
## Neighborhood             Neighborhood 1.111899e+01
## Garage_Cars               Garage_Cars 5.374303e+00
## Total_Bsmt_SF           Total_Bsmt_SF 5.031406e+00
## First_Flr_SF             First_Flr_SF 3.641743e+00
## Bsmt_Qual                   Bsmt_Qual 2.365967e+00
## Exter_Qual                 Exter_Qual 1.559647e+00
## Kitchen_Qual             Kitchen_Qual 1.210399e+00
## Year_Remod_Add         Year_Remod_Add 9.800489e-01
## MS_SubClass               MS_SubClass 9.168515e-01
## Fireplace_Qu             Fireplace_Qu 7.900484e-01
## Mas_Vnr_Area             Mas_Vnr_Area 7.480704e-01
## Lot_Area                     Lot_Area 7.181146e-01
## Bsmt_Unf_SF               Bsmt_Unf_SF 7.036017e-01
## Second_Flr_SF           Second_Flr_SF 6.564021e-01
## Garage_Area               Garage_Area 5.812072e-01
## Screen_Porch             Screen_Porch 5.697864e-01
## Bsmt_Exposure           Bsmt_Exposure 5.447030e-01
## Overall_Cond             Overall_Cond 5.149690e-01
## BsmtFin_Type_1         BsmtFin_Type_1 5.136834e-01
## Full_Bath                   Full_Bath 4.517156e-01
## Lot_Frontage             Lot_Frontage 4.308841e-01
## Latitude                     Latitude 4.021943e-01
## Sale_Condition         Sale_Condition 3.736402e-01
## Garage_Type               Garage_Type 3.400862e-01
## Bsmt_Full_Bath         Bsmt_Full_Bath 2.830678e-01
## Garage_Finish           Garage_Finish 2.794122e-01
## Open_Porch_SF           Open_Porch_SF 2.731140e-01
## Exterior_1st             Exterior_1st 2.449858e-01
## Fireplaces                 Fireplaces 2.446628e-01
## Sale_Type                   Sale_Type 2.083020e-01
## Year_Built                 Year_Built 2.060348e-01
## Central_Air               Central_Air 1.895762e-01
## Exterior_2nd             Exterior_2nd 1.791393e-01
## TotRms_AbvGrd           TotRms_AbvGrd 1.624508e-01
## Wood_Deck_SF             Wood_Deck_SF 1.619419e-01
## Mo_Sold                       Mo_Sold 1.556240e-01
## Condition_1               Condition_1 1.555862e-01
## Garage_Cond               Garage_Cond 1.433484e-01
## Functional                 Functional 1.195756e-01
## Land_Contour             Land_Contour 1.176260e-01
## Longitude                   Longitude 1.099157e-01
## Heating_QC                 Heating_QC 7.996284e-02
## Year_Sold                   Year_Sold 7.732664e-02
## Roof_Matl                   Roof_Matl 6.581906e-02
## House_Style               House_Style 5.653741e-02
## Mas_Vnr_Type             Mas_Vnr_Type 4.764729e-02
## Bedroom_AbvGr           Bedroom_AbvGr 4.542366e-02
## Lot_Config                 Lot_Config 3.928406e-02
## Paved_Drive               Paved_Drive 3.815510e-02
## BsmtFin_Type_2         BsmtFin_Type_2 3.573880e-02
## Roof_Style                 Roof_Style 3.492513e-02
## Bsmt_Cond                   Bsmt_Cond 3.320548e-02
## Land_Slope                 Land_Slope 3.191664e-02
## Exter_Cond                 Exter_Cond 3.036215e-02
## MS_Zoning                   MS_Zoning 3.016913e-02
## Enclosed_Porch         Enclosed_Porch 2.361207e-02
## Alley                           Alley 1.860542e-02
## Condition_2               Condition_2 1.829088e-02
## Half_Bath                   Half_Bath 1.622231e-02
## Three_season_porch Three_season_porch 1.091252e-02
## Foundation                 Foundation 1.039571e-02
## Low_Qual_Fin_SF       Low_Qual_Fin_SF 8.975948e-03
## BsmtFin_SF_2             BsmtFin_SF_2 8.747153e-03
## Fence                           Fence 7.868905e-03
## Lot_Shape                   Lot_Shape 5.645516e-03
## Electrical                 Electrical 4.850525e-03
## Heating                       Heating 4.405392e-03
## Garage_Qual               Garage_Qual 3.845332e-03
## BsmtFin_SF_1             BsmtFin_SF_1 2.902816e-03
## Misc_Val                     Misc_Val 2.321802e-03
## Bsmt_Half_Bath         Bsmt_Half_Bath 2.263392e-03
## Street                         Street 1.157860e-03
## Bldg_Type                   Bldg_Type 4.970819e-04
## Misc_Feature             Misc_Feature 4.236315e-04
## Pool_QC                       Pool_QC 1.575743e-04
## Pool_Area                   Pool_Area 9.720817e-05
## Utilities                   Utilities 0.000000e+00
## Kitchen_AbvGr           Kitchen_AbvGr 0.000000e+00
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824330924260763-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-23">23</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-24">24</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-25">25</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-26">26</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-27">27</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-28">28</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-29">29</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-30">30</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-31">31</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-32">32</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-33">33</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-34">34</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-35">35</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-36">36</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-37">37</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-38">38</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-39">39</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-40">40</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-41">41</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-42">42</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-43">43</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-44">44</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-45">45</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-46">46</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-47">47</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-48">48</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-49">49</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-50">50</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-51">51</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-52">52</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-53">53</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-54">54</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-55">55</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-56">56</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-57">57</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-58">58</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-59">59</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-60">60</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-61">61</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-62">62</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-63">63</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-64">64</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-65">65</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-66">66</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-67">67</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-68">68</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-69">69</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-70">70</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-71">71</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-72">72</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-73">73</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-74">74</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-75">75</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-76">76</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-77">77</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-78">78</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-79">79</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-80">80</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-81">81</div><div class="crayon-num" data-line="crayon-60ed86a824330924260763-82">82</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824330924260763-1">##                                   var      rel.inf</div><div class="crayon-line" id="crayon-60ed86a824330924260763-2">## Overall_Qual             Overall_Qual 4.199240e+01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-3">## Gr_Liv_Area               Gr_Liv_Area 1.343609e+01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-4">## Neighborhood             Neighborhood 1.111899e+01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-5">## Garage_Cars               Garage_Cars 5.374303e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-6">## Total_Bsmt_SF           Total_Bsmt_SF 5.031406e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-7">## First_Flr_SF             First_Flr_SF 3.641743e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-8">## Bsmt_Qual                   Bsmt_Qual 2.365967e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-9">## Exter_Qual                 Exter_Qual 1.559647e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-10">## Kitchen_Qual             Kitchen_Qual 1.210399e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-11">## Year_Remod_Add         Year_Remod_Add 9.800489e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-12">## MS_SubClass               MS_SubClass 9.168515e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-13">## Fireplace_Qu             Fireplace_Qu 7.900484e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-14">## Mas_Vnr_Area             Mas_Vnr_Area 7.480704e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-15">## Lot_Area                     Lot_Area 7.181146e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-16">## Bsmt_Unf_SF               Bsmt_Unf_SF 7.036017e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-17">## Second_Flr_SF           Second_Flr_SF 6.564021e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-18">## Garage_Area               Garage_Area 5.812072e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-19">## Screen_Porch             Screen_Porch 5.697864e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-20">## Bsmt_Exposure           Bsmt_Exposure 5.447030e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-21">## Overall_Cond             Overall_Cond 5.149690e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-22">## BsmtFin_Type_1         BsmtFin_Type_1 5.136834e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-23">## Full_Bath                   Full_Bath 4.517156e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-24">## Lot_Frontage             Lot_Frontage 4.308841e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-25">## Latitude                     Latitude 4.021943e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-26">## Sale_Condition         Sale_Condition 3.736402e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-27">## Garage_Type               Garage_Type 3.400862e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-28">## Bsmt_Full_Bath         Bsmt_Full_Bath 2.830678e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-29">## Garage_Finish           Garage_Finish 2.794122e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-30">## Open_Porch_SF           Open_Porch_SF 2.731140e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-31">## Exterior_1st             Exterior_1st 2.449858e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-32">## Fireplaces                 Fireplaces 2.446628e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-33">## Sale_Type                   Sale_Type 2.083020e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-34">## Year_Built                 Year_Built 2.060348e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-35">## Central_Air               Central_Air 1.895762e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-36">## Exterior_2nd             Exterior_2nd 1.791393e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-37">## TotRms_AbvGrd           TotRms_AbvGrd 1.624508e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-38">## Wood_Deck_SF             Wood_Deck_SF 1.619419e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-39">## Mo_Sold                       Mo_Sold 1.556240e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-40">## Condition_1               Condition_1 1.555862e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-41">## Garage_Cond               Garage_Cond 1.433484e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-42">## Functional                 Functional 1.195756e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-43">## Land_Contour             Land_Contour 1.176260e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-44">## Longitude                   Longitude 1.099157e-01</div><div class="crayon-line" id="crayon-60ed86a824330924260763-45">## Heating_QC                 Heating_QC 7.996284e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-46">## Year_Sold                   Year_Sold 7.732664e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-47">## Roof_Matl                   Roof_Matl 6.581906e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-48">## House_Style               House_Style 5.653741e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-49">## Mas_Vnr_Type             Mas_Vnr_Type 4.764729e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-50">## Bedroom_AbvGr           Bedroom_AbvGr 4.542366e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-51">## Lot_Config                 Lot_Config 3.928406e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-52">## Paved_Drive               Paved_Drive 3.815510e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-53">## BsmtFin_Type_2         BsmtFin_Type_2 3.573880e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-54">## Roof_Style                 Roof_Style 3.492513e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-55">## Bsmt_Cond                   Bsmt_Cond 3.320548e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-56">## Land_Slope                 Land_Slope 3.191664e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-57">## Exter_Cond                 Exter_Cond 3.036215e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-58">## MS_Zoning                   MS_Zoning 3.016913e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-59">## Enclosed_Porch         Enclosed_Porch 2.361207e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-60">## Alley                           Alley 1.860542e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-61">## Condition_2               Condition_2 1.829088e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-62">## Half_Bath                   Half_Bath 1.622231e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-63">## Three_season_porch Three_season_porch 1.091252e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-64">## Foundation                 Foundation 1.039571e-02</div><div class="crayon-line" id="crayon-60ed86a824330924260763-65">## Low_Qual_Fin_SF       Low_Qual_Fin_SF 8.975948e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-66">## BsmtFin_SF_2             BsmtFin_SF_2 8.747153e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-67">## Fence                           Fence 7.868905e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-68">## Lot_Shape                   Lot_Shape 5.645516e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-69">## Electrical                 Electrical 4.850525e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-70">## Heating                       Heating 4.405392e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-71">## Garage_Qual               Garage_Qual 3.845332e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-72">## BsmtFin_SF_1             BsmtFin_SF_1 2.902816e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-73">## Misc_Val                     Misc_Val 2.321802e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-74">## Bsmt_Half_Bath         Bsmt_Half_Bath 2.263392e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-75">## Street                         Street 1.157860e-03</div><div class="crayon-line" id="crayon-60ed86a824330924260763-76">## Bldg_Type                   Bldg_Type 4.970819e-04</div><div class="crayon-line" id="crayon-60ed86a824330924260763-77">## Misc_Feature             Misc_Feature 4.236315e-04</div><div class="crayon-line" id="crayon-60ed86a824330924260763-78">## Pool_QC                       Pool_QC 1.575743e-04</div><div class="crayon-line" id="crayon-60ed86a824330924260763-79">## Pool_Area                   Pool_Area 9.720817e-05</div><div class="crayon-line" id="crayon-60ed86a824330924260763-80">## Utilities                   Utilities 0.000000e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-81">## Kitchen_AbvGr           Kitchen_AbvGr 0.000000e+00</div><div class="crayon-line" id="crayon-60ed86a824330924260763-82"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>另外一個方式，就是使用vip套件(variable importance plot)的vip函式，會回傳ggplot形式的重要變數圖表。 為兩個解釋集成樹的兩大重要解釋指標)，是許多機器學習模型常用的變數重要性繪圖框架。</p>

		<div id="crayon-60ed86a824332202559284" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# install.packages('vip')
vip::vip(gbm.fit.final)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824332202559284-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824332202559284-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824332202559284-1"># install.packages('vip')</div><div class="crayon-line" id="crayon-60ed86a824332202559284-2">vip::vip(gbm.fit.final)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h5><img loading="lazy" class="alignnone size-full wp-image-2879" src="/wp-content/uploads/2019/04/Rplot01.png" alt="gradient boosting machines, GBM" width="631" height="441" srcset="/wp-content/uploads/2019/04/Rplot01.png 631w,/wp-content/uploads/2019/04/Rplot01-300x210.png 300w,/wp-content/uploads/2019/04/Rplot01-230x161.png 230w,/wp-content/uploads/2019/04/Rplot01-350x245.png 350w,/wp-content/uploads/2019/04/Rplot01-480x335.png 480w" sizes="(max-width: 631px) 100vw, 631px"></h5>
<h5>Partial dependence plots</h5>
<p>一旦識別出最重要的幾個變數後，下一步就是去了解當解釋變數變動時，目標變數是如何變動的(即marginal effects，邊際效果，每變動一單位解釋變數時，對目標變數的影響)。我們可以使用partial dependence plots(PDPs)和individual conditional expectation(ICE)曲線。</p>
<ul>
<li>PDPs: 繪製特定變數邊際變動造成的平均目標預測值的變動。比如說，下圖繪製了預測變數Gr_Liv_Area邊際變動(控制其他變數不變的情況下)對平均目標預測銷售金額(avg. sale price_的影響。下圖PDPs描述隨著房屋基底的面積邊際增加，平均銷售價格增加的變化。</li>
</ul>
<p></p>

		<div id="crayon-60ed86a824336917106421" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
gbm.fit.final %>%
  partial(object = .,# A fitted model object of appropriate class (e.g., "gbm", "lm", "randomForest", "train", etc.).
          pred.var = "Gr_Liv_Area", 
          n.trees = gbm.fit.final$n.trees, # 如果是gbm的話，需指定模型所使用樹個數
          grid.resolution = 100) %>%
  # The autplot function can be used to produce graphics based on ggplot2
  autoplot(rug = TRUE, train = ames_train) + # plotPartial()不支援gbm
  scale_y_continuous(labels = scales::dollar) # 因為是使用ggplot基礎繪圖，故可以使用ggplot相關圖層來調整</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824336917106421-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824336917106421-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824336917106421-1">gbm.fit.final %>%</div><div class="crayon-line" id="crayon-60ed86a824336917106421-2">  partial(object = .,# A fitted model object of appropriate class (e.g., "gbm", "lm", "randomForest", "train", etc.).</div><div class="crayon-line" id="crayon-60ed86a824336917106421-3">          pred.var = "Gr_Liv_Area", </div><div class="crayon-line" id="crayon-60ed86a824336917106421-4">          n.trees = gbm.fit.final$n.trees, # 如果是gbm的話，需指定模型所使用樹個數</div><div class="crayon-line" id="crayon-60ed86a824336917106421-5">          grid.resolution = 100) %>%</div><div class="crayon-line" id="crayon-60ed86a824336917106421-6">  # The autplot function can be used to produce graphics based on ggplot2</div><div class="crayon-line" id="crayon-60ed86a824336917106421-7">  autoplot(rug = TRUE, train = ames_train) + # plotPartial()不支援gbm</div><div class="crayon-line" id="crayon-60ed86a824336917106421-8">  scale_y_continuous(labels = scales::dollar) # 因為是使用ggplot基礎繪圖，故可以使用ggplot相關圖層來調整</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img loading="lazy" class="alignnone size-full wp-image-2880" src="/wp-content/uploads/2019/04/Rplot02.png" alt="gradient boosting machines, GBM" width="606" height="439" srcset="/wp-content/uploads/2019/04/Rplot02.png 606w,/wp-content/uploads/2019/04/Rplot02-300x217.png 300w,/wp-content/uploads/2019/04/Rplot02-230x167.png 230w,/wp-content/uploads/2019/04/Rplot02-350x254.png 350w,/wp-content/uploads/2019/04/Rplot02-480x348.png 480w" sizes="(max-width: 606px) 100vw, 606px"></p>
<p>拆解步驟1: 先檢視沒有繪圖(plot = FALSE)的所回傳的data.frame。在一些例子中，使用partial根據object來擷取training data是困難的，此時便會出現錯誤訊息要求使用者透過train參數提供訓練資料集。但絕大部分的時候，partial會預設擷取當下環境下訓練object所使用的訓練資料集，所以很重要的事，在執行partial之前不行改變到訓練資料集的變數內容，而此問題可透過明確指定train參數所對應的訓練資料集而解決。</p>

		<div id="crayon-60ed86a824337984161963" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
partialDf <-partial(
        object = gbm.fit.final,pred.var = "Gr_Liv_Area", 
        n.trees = gbm.fit.final$n.trees, 
        grid.resolution = 100,
        train = ames_train)
partialDf</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824337984161963-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824337984161963-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824337984161963-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824337984161963-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824337984161963-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824337984161963-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824337984161963-1">partialDf <div class="crayon-line" id="crayon-60ed86a824337984161963-2">        object = gbm.fit.final,pred.var = "Gr_Liv_Area", </div><div class="crayon-line" id="crayon-60ed86a824337984161963-3">        n.trees = gbm.fit.final$n.trees, </div><div class="crayon-line" id="crayon-60ed86a824337984161963-4">        grid.resolution = 100,</div><div class="crayon-line" id="crayon-60ed86a824337984161963-5">        train = ames_train)</div><div class="crayon-line" id="crayon-60ed86a824337984161963-6">partialDf</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824339720414994" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##     Gr_Liv_Area     yhat
## 1           334 156956.9
## 2           387 156956.9
## 3           441 156956.9
## 4           494 156956.9
## 5           548 156956.9
## 6           602 156956.9
## 7           655 156956.9
## 8           709 156660.6
## 9           762 156755.5
## 10          816 156871.1
## 11          870 156871.1
## 12          923 158251.7
## 13          977 161056.8
## 14         1031 163112.1
## 15         1084 163138.2
## 16         1138 163214.8
## 17         1191 166534.4
## 18         1245 166987.2
## 19         1299 169077.6
## 20         1352 170758.6
## 21         1406 172776.0
## 22         1459 174681.8
## 23         1513 181046.8
## 24         1567 182290.3
## 25         1620 185044.8
## 26         1674 185035.8
## 27         1728 186329.2
## 28         1781 189560.9
## 29         1835 192374.4
## 30         1888 193609.3
## 31         1942 194775.0
## 32         1996 200759.0
## 33         2049 202826.8
## 34         2103 206586.7
## 35         2156 207502.2
## 36         2210 207502.2
## 37         2264 209486.0
## 38         2317 212637.8
## 39         2371 214445.4
## 40         2425 214863.0
## 41         2478 215367.1
## 42         2532 215404.3
## 43         2585 215404.3
## 44         2639 215571.6
## 45         2693 226433.3
## 46         2746 225632.2
## 47         2800 225849.6
## 48         2853 223628.9
## 49         2907 219924.6
## 50         2961 218770.4
## 51         3014 218770.4
## 52         3068 218770.4
## 53         3122 227327.1
## 54         3175 229537.3
## 55         3229 235917.9
## 56         3282 241038.0
## 57         3336 240301.2
## 58         3390 243415.0
## 59         3443 243127.7
## 60         3497 246930.9
## 61         3550 246930.9
## 62         3604 246930.9
## 63         3658 246930.9
## 64         3711 246930.9
## 65         3765 246930.9
## 66         3819 246930.9
## 67         3872 246930.9
## 68         3926 246930.9
## 69         3979 246930.9
## 70         4033 246930.9
## 71         4087 246930.9
## 72         4140 246930.9
## 73         4194 246930.9
## 74         4247 246930.9
## 75         4301 246930.9
## 76         4355 246930.9
## 77         4408 246930.9
## 78         4462 246930.9
## 79         4516 246930.9
## 80         4569 246930.9
## 81         4623 246930.9
## 82         4676 246930.9
## 83         4730 246930.9
## 84         4784 246930.9
## 85         4837 246930.9
## 86         4891 246930.9
## 87         4944 246930.9
## 88         4998 246930.9
## 89         5052 246930.9
## 90         5105 246930.9
## 91         5159 246930.9
## 92         5213 246930.9
## 93         5266 246930.9
## 94         5320 246930.9
## 95         5373 246930.9
## 96         5427 246930.9
## 97         5481 246930.9
## 98         5534 246930.9
## 99         5588 246930.9
## 100        5642 246930.9
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824339720414994-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-23">23</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-24">24</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-25">25</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-26">26</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-27">27</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-28">28</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-29">29</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-30">30</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-31">31</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-32">32</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-33">33</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-34">34</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-35">35</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-36">36</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-37">37</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-38">38</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-39">39</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-40">40</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-41">41</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-42">42</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-43">43</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-44">44</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-45">45</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-46">46</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-47">47</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-48">48</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-49">49</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-50">50</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-51">51</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-52">52</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-53">53</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-54">54</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-55">55</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-56">56</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-57">57</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-58">58</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-59">59</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-60">60</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-61">61</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-62">62</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-63">63</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-64">64</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-65">65</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-66">66</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-67">67</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-68">68</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-69">69</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-70">70</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-71">71</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-72">72</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-73">73</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-74">74</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-75">75</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-76">76</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-77">77</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-78">78</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-79">79</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-80">80</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-81">81</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-82">82</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-83">83</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-84">84</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-85">85</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-86">86</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-87">87</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-88">88</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-89">89</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-90">90</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-91">91</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-92">92</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-93">93</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-94">94</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-95">95</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-96">96</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-97">97</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-98">98</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-99">99</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-100">100</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-101">101</div><div class="crayon-num" data-line="crayon-60ed86a824339720414994-102">102</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824339720414994-1">##     Gr_Liv_Area     yhat</div><div class="crayon-line" id="crayon-60ed86a824339720414994-2">## 1           334 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-3">## 2           387 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-4">## 3           441 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-5">## 4           494 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-6">## 5           548 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-7">## 6           602 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-8">## 7           655 156956.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-9">## 8           709 156660.6</div><div class="crayon-line" id="crayon-60ed86a824339720414994-10">## 9           762 156755.5</div><div class="crayon-line" id="crayon-60ed86a824339720414994-11">## 10          816 156871.1</div><div class="crayon-line" id="crayon-60ed86a824339720414994-12">## 11          870 156871.1</div><div class="crayon-line" id="crayon-60ed86a824339720414994-13">## 12          923 158251.7</div><div class="crayon-line" id="crayon-60ed86a824339720414994-14">## 13          977 161056.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-15">## 14         1031 163112.1</div><div class="crayon-line" id="crayon-60ed86a824339720414994-16">## 15         1084 163138.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-17">## 16         1138 163214.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-18">## 17         1191 166534.4</div><div class="crayon-line" id="crayon-60ed86a824339720414994-19">## 18         1245 166987.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-20">## 19         1299 169077.6</div><div class="crayon-line" id="crayon-60ed86a824339720414994-21">## 20         1352 170758.6</div><div class="crayon-line" id="crayon-60ed86a824339720414994-22">## 21         1406 172776.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-23">## 22         1459 174681.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-24">## 23         1513 181046.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-25">## 24         1567 182290.3</div><div class="crayon-line" id="crayon-60ed86a824339720414994-26">## 25         1620 185044.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-27">## 26         1674 185035.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-28">## 27         1728 186329.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-29">## 28         1781 189560.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-30">## 29         1835 192374.4</div><div class="crayon-line" id="crayon-60ed86a824339720414994-31">## 30         1888 193609.3</div><div class="crayon-line" id="crayon-60ed86a824339720414994-32">## 31         1942 194775.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-33">## 32         1996 200759.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-34">## 33         2049 202826.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-35">## 34         2103 206586.7</div><div class="crayon-line" id="crayon-60ed86a824339720414994-36">## 35         2156 207502.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-37">## 36         2210 207502.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-38">## 37         2264 209486.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-39">## 38         2317 212637.8</div><div class="crayon-line" id="crayon-60ed86a824339720414994-40">## 39         2371 214445.4</div><div class="crayon-line" id="crayon-60ed86a824339720414994-41">## 40         2425 214863.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-42">## 41         2478 215367.1</div><div class="crayon-line" id="crayon-60ed86a824339720414994-43">## 42         2532 215404.3</div><div class="crayon-line" id="crayon-60ed86a824339720414994-44">## 43         2585 215404.3</div><div class="crayon-line" id="crayon-60ed86a824339720414994-45">## 44         2639 215571.6</div><div class="crayon-line" id="crayon-60ed86a824339720414994-46">## 45         2693 226433.3</div><div class="crayon-line" id="crayon-60ed86a824339720414994-47">## 46         2746 225632.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-48">## 47         2800 225849.6</div><div class="crayon-line" id="crayon-60ed86a824339720414994-49">## 48         2853 223628.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-50">## 49         2907 219924.6</div><div class="crayon-line" id="crayon-60ed86a824339720414994-51">## 50         2961 218770.4</div><div class="crayon-line" id="crayon-60ed86a824339720414994-52">## 51         3014 218770.4</div><div class="crayon-line" id="crayon-60ed86a824339720414994-53">## 52         3068 218770.4</div><div class="crayon-line" id="crayon-60ed86a824339720414994-54">## 53         3122 227327.1</div><div class="crayon-line" id="crayon-60ed86a824339720414994-55">## 54         3175 229537.3</div><div class="crayon-line" id="crayon-60ed86a824339720414994-56">## 55         3229 235917.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-57">## 56         3282 241038.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-58">## 57         3336 240301.2</div><div class="crayon-line" id="crayon-60ed86a824339720414994-59">## 58         3390 243415.0</div><div class="crayon-line" id="crayon-60ed86a824339720414994-60">## 59         3443 243127.7</div><div class="crayon-line" id="crayon-60ed86a824339720414994-61">## 60         3497 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-62">## 61         3550 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-63">## 62         3604 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-64">## 63         3658 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-65">## 64         3711 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-66">## 65         3765 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-67">## 66         3819 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-68">## 67         3872 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-69">## 68         3926 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-70">## 69         3979 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-71">## 70         4033 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-72">## 71         4087 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-73">## 72         4140 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-74">## 73         4194 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-75">## 74         4247 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-76">## 75         4301 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-77">## 76         4355 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-78">## 77         4408 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-79">## 78         4462 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-80">## 79         4516 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-81">## 80         4569 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-82">## 81         4623 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-83">## 82         4676 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-84">## 83         4730 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-85">## 84         4784 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-86">## 85         4837 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-87">## 86         4891 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-88">## 87         4944 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-89">## 88         4998 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-90">## 89         5052 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-91">## 90         5105 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-92">## 91         5159 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-93">## 92         5213 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-94">## 93         5266 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-95">## 94         5320 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-96">## 95         5373 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-97">## 96         5427 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-98">## 97         5481 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-99">## 98         5534 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-100">## 99         5588 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-101">## 100        5642 246930.9</div><div class="crayon-line" id="crayon-60ed86a824339720414994-102"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>亦可使用plot = TRUE將以上結果繪出。(不是ggplot2)<br>
但其實比較推薦保留plot = FALSE，將partial回傳結果先儲存。這樣的好處在於繪圖上會更有彈性，當預設繪圖結果不足夠時，不需要重新執行partial()。</p>

		<div id="crayon-60ed86a82433a019788318" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
partial(gbm.fit.final, train = ames_train, pred.var = 'Gr_Liv_Area',n.trees = gbm.fit.final$n.trees, plot = TRUE)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82433a019788318-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82433a019788318-1">partial(gbm.fit.final, train = ames_train, pred.var = 'Gr_Liv_Area',n.trees = gbm.fit.final$n.trees, plot = TRUE)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-23-1-1.png" alt="gradient boosting machines, GBM"></p>
<ul>
<li>ICE curves: 是PDPs圖的延伸。與PDPs圖不同的地方在於，PDPs是繪製每個解釋變數邊際變動所造成的「平均」目標數值的變化(平均所有觀測值)，而ICE curves則是繪製「每個」解釋變數邊際變動對所有觀測值的目標數值的變動。下面分別呈現了regular ICE曲線圖(左)和centered ICE曲線圖(右)。當曲線有很寬廣的截距且彼此疊在一起，很難辨別感興趣的預測變數邊際變動所造成的回應變數變動量的異質性。而centered ICE曲線，則能強調結果中的異質性。以下regular ICE圖顯示，當Gr_Liv_Area增加時，大部分的觀測值的目標變數變化具有共通趨勢，而centered ICE圖則凸顯部分與共通趨勢不一致的觀察值變化圖。</li>
</ul>
<p></p>

		<div id="crayon-60ed86a82433c089567023" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
ice1 <- gbm.fit.final %>%
  partial(
    pred.var = "Gr_Liv_Area", 
    n.trees = gbm.fit.final$n.trees, 
    grid.resolution = 100,
    ice = TRUE # 當ice = TRUE或給定pred.fun參數，會回傳使用newdata替每個觀測值預測的結果
    ) %>%
  autoplot(rug = TRUE, train = ames_train, alpha = .1) + # alpha參數只在ICE curves繪製上有效
  ggtitle("Non-centered") +
  scale_y_continuous(labels = scales::dollar)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82433c089567023-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82433c089567023-1">ice1 %</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-2">  partial(</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-3">    pred.var = "Gr_Liv_Area", </div><div class="crayon-line" id="crayon-60ed86a82433c089567023-4">    n.trees = gbm.fit.final$n.trees, </div><div class="crayon-line" id="crayon-60ed86a82433c089567023-5">    grid.resolution = 100,</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-6">    ice = TRUE # 當ice = TRUE或給定pred.fun參數，會回傳使用newdata替每個觀測值預測的結果</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-7">    ) %>%</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-8">  autoplot(rug = TRUE, train = ames_train, alpha = .1) + # alpha參數只在ICE curves繪製上有效</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-9">  ggtitle("Non-centered") +</div><div class="crayon-line" id="crayon-60ed86a82433c089567023-10">  scale_y_continuous(labels = scales::dollar)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82433d751887796" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
ice2 <- gbm.fit.final %>%
  partial(
    pred.var = "Gr_Liv_Area", 
    n.trees = gbm.fit.final$n.trees, 
    grid.resolution = 100,
    ice = TRUE
    ) %>%
  autoplot(rug = TRUE, train = ames_train, alpha = .1, center = TRUE) +
  ggtitle("Centered") +
  scale_y_continuous(labels = scales::dollar)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82433d751887796-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82433d751887796-1">ice2 %</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-2">  partial(</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-3">    pred.var = "Gr_Liv_Area", </div><div class="crayon-line" id="crayon-60ed86a82433d751887796-4">    n.trees = gbm.fit.final$n.trees, </div><div class="crayon-line" id="crayon-60ed86a82433d751887796-5">    grid.resolution = 100,</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-6">    ice = TRUE</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-7">    ) %>%</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-8">  autoplot(rug = TRUE, train = ames_train, alpha = .1, center = TRUE) +</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-9">  ggtitle("Centered") +</div><div class="crayon-line" id="crayon-60ed86a82433d751887796-10">  scale_y_continuous(labels = scales::dollar)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82433e653464782" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
gridExtra::grid.arrange(ice1, ice2, nrow = 1)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82433e653464782-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82433e653464782-1">gridExtra::grid.arrange(ice1, ice2, nrow = 1)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img loading="lazy" class="alignnone size-full wp-image-2881" src="/wp-content/uploads/2019/04/Rplot03.png" alt="gradient boosting machines, GBM" width="1042" height="530" srcset="/wp-content/uploads/2019/04/Rplot03.png 1042w,/wp-content/uploads/2019/04/Rplot03-300x153.png 300w,/wp-content/uploads/2019/04/Rplot03-768x391.png 768w,/wp-content/uploads/2019/04/Rplot03-1024x521.png 1024w,/wp-content/uploads/2019/04/Rplot03-830x422.png 830w,/wp-content/uploads/2019/04/Rplot03-230x117.png 230w,/wp-content/uploads/2019/04/Rplot03-350x178.png 350w,/wp-content/uploads/2019/04/Rplot03-480x244.png 480w" sizes="(max-width: 1042px) 100vw, 1042px"></p>
<h5>LIME</h5>
<p>LIME是一種新程序幫助我們了解，單一觀察值的預測目標值是如何產生的。對gbm物件使用lime套件，我們需要定義模型類型model type和預測方法prediction methods。</p>

		<div id="crayon-60ed86a82433f229038381" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
model_type.gbm <- function(x, ...) {
  return("regression")
}

predict_model.gbm <- function(x, newdata, ...) {
  pred <- predict(x, newdata, n.trees = x$n.trees)
  return(as.data.frame(pred))
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82433f229038381-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82433f229038381-1">model_type.gbm <div class="crayon-line" id="crayon-60ed86a82433f229038381-2">  return("regression")</div><div class="crayon-line" id="crayon-60ed86a82433f229038381-3">}</div><div class="crayon-line" id="crayon-60ed86a82433f229038381-4"> </div><div class="crayon-line" id="crayon-60ed86a82433f229038381-5">predict_model.gbm <div class="crayon-line" id="crayon-60ed86a82433f229038381-6">  pred <div class="crayon-line" id="crayon-60ed86a82433f229038381-7">  return(as.data.frame(pred))</div><div class="crayon-line" id="crayon-60ed86a82433f229038381-8">}</div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>以下我們便挑選兩個觀測值來檢視其預測目標值是如何產生的。<br>
結果包括預測目標值（分別為case1: 127K case2: 159K）、局部模型配適（兩者的局部配飾都太好）、以及對不同觀測值來說，對目標變數最具影響力的特徵變數。</p>

		<div id="crayon-60ed86a824346171600742" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# get a few observations to perform local interpretation on
local_obs <- ames_test[1:2, ]

# apply LIME
explainer <- lime(
  x=ames_train, # The training data used for training the model that should be explained.
  model = gbm.fit.final # The model whose output should be explained
  )
# 一旦使用lime()創建好了explainer，則可將explainer用作解釋模型作用在新觀察值的結果
explanation <- explain(x = local_obs, # New observations to explain
                       explainer = explainer,
                       n_features = 5 # The number of features to use for each explanation.
                       )</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824346171600742-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824346171600742-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824346171600742-1"># get a few observations to perform local interpretation on</div><div class="crayon-line" id="crayon-60ed86a824346171600742-2">local_obs <div class="crayon-line" id="crayon-60ed86a824346171600742-3"> </div><div class="crayon-line" id="crayon-60ed86a824346171600742-4"># apply LIME</div><div class="crayon-line" id="crayon-60ed86a824346171600742-5">explainer <div class="crayon-line" id="crayon-60ed86a824346171600742-6">  x=ames_train, # The training data used for training the model that should be explained.</div><div class="crayon-line" id="crayon-60ed86a824346171600742-7">  model = gbm.fit.final # The model whose output should be explained</div><div class="crayon-line" id="crayon-60ed86a824346171600742-8">  )</div><div class="crayon-line" id="crayon-60ed86a824346171600742-9"># 一旦使用lime()創建好了explainer，則可將explainer用作解釋模型作用在新觀察值的結果</div><div class="crayon-line" id="crayon-60ed86a824346171600742-10">explanation <div class="crayon-line" id="crayon-60ed86a824346171600742-11">                       explainer = explainer,</div><div class="crayon-line" id="crayon-60ed86a824346171600742-12">                       n_features = 5 # The number of features to use for each explanation.</div><div class="crayon-line" id="crayon-60ed86a824346171600742-13">                       )</div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824348998306108" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
plot_features(explanation = explanation)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824348998306108-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824348998306108-1">plot_features(explanation = explanation)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img loading="lazy" class="alignnone size-full wp-image-2882" src="/wp-content/uploads/2019/04/Rplot04.png" alt="gradient boosting machines, GBM" width="1033" height="525" srcset="/wp-content/uploads/2019/04/Rplot04.png 1033w,/wp-content/uploads/2019/04/Rplot04-300x152.png 300w,/wp-content/uploads/2019/04/Rplot04-768x390.png 768w,/wp-content/uploads/2019/04/Rplot04-1024x520.png 1024w,/wp-content/uploads/2019/04/Rplot04-830x422.png 830w,/wp-content/uploads/2019/04/Rplot04-230x117.png 230w,/wp-content/uploads/2019/04/Rplot04-350x178.png 350w,/wp-content/uploads/2019/04/Rplot04-480x244.png 480w" sizes="(max-width: 1033px) 100vw, 1033px"></p>
<h4>Predicting</h4>
<p>一旦決定好最佳的模型後，便使用模型來預測新的資料集(ames_test)。跟大部分模型一樣，我們可以使用predict()函數，只不過我們需要指定所需要的樹模型個數(可參考?predict.gbm之說明)。我們可以觀察到，測試資料集所得到的RMSE跟我們得到的最佳gbm模型的RMSE(22K)是差不多的。</p>

		<div id="crayon-60ed86a824349850708827" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# predict values for test data
pred <- predict(gbm.fit.final, n.trees = gbm.fit.final$n.trees, ames_test)

# results
caret::RMSE(pred, ames_test$Sale_Price)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824349850708827-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824349850708827-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824349850708827-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824349850708827-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824349850708827-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824349850708827-1"># predict values for test data</div><div class="crayon-line" id="crayon-60ed86a824349850708827-2">pred <div class="crayon-line" id="crayon-60ed86a824349850708827-3"> </div><div class="crayon-line" id="crayon-60ed86a824349850708827-4"># results</div><div class="crayon-line" id="crayon-60ed86a824349850708827-5">caret::RMSE(pred, ames_test$Sale_Price)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82434a772436604" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 19686.42
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82434a772436604-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82434a772436604-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82434a772436604-1">## [1] 19686.42</div><div class="crayon-line" id="crayon-60ed86a82434a772436604-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h3>xgboost</h3>
<p>xgboost套件提供一個Extreme Gradient Boosting的R API，可以具效率地去執行gradient boosting framework(約比gbm套件快上10倍)。<a href="https://github.com/dmlc/xgboost/tree/master/demo" target="_blank" rel="noopener noreferrer">xgboost</a>文件的知識庫有豐富的資訊。亦可參考非常完整的參數tuning<a href="https://www.analyticsvidhya.com/blog/2016/03/complete-guide-parameter-tuning-xgboost-with-codes-python/" target="_blank" rel="noopener noreferrer">教學文章</a>。xgboost套件一直以來在kaggle data mining競賽上是滿受歡迎且成功的演算法套件。</p>
<p>xgboost幾個特色包括：</p>
<ul>
<li>提供內建的k-fold cross validation</li>
<li>隨機GBM，兼具column和row的抽樣(per split and per tree)，以達到更好的一般性(避免過度擬合)。</li>
<li>包括高效的線性模型求解器和樹學習演算法。</li>
<li>單一機器上的平行運算。</li>
<li>支援多個目標函數，包括回歸regression，分類classification，和排序ranking。</li>
<li>該套件被設計為有延展性的(extensible)，因此使用者可以自己定義自己的目標函式(objectives)。</li>
<li>Apache 2.0 License</li>
</ul>
<h4>基本的xgboost實作</h4>
<p>xgboost 只能在都是「數值變數的矩陣」下運作(由於在空間中表示點的位置，所有特徵值須為數值)。因此，我們必須先將數據進行編碼轉換。</p>
<p>一般來說編碼類別變數有兩種方式，分別為Label Encoding和one-hot encoding，通常前者會衍伸出編碼後的數值變成有順序意義在的問題，以及在空間維度中代表不同距離的意義之問題，故通常最常使用one-hot encoding法是最適合的，來使類別變數中三個屬性在空間中距離原點的距離是相同的(*但必須注意的是，one-hot encoding只適用在類別種類少的情況，如果種類過多，過多展開的維度會衍伸出其他問題)。</p>
<p>在R中有幾個執行one-hot encoding的方式，包括Matrix::sparse.model.matrix， caret::dummyVars，但我們這邊會使用vtreat套件。vtreat是一個強大的資料前處理套件，且有助於處理因遺失值、或新資料中才新冒出的類別資料級別（原本不為訓練資料類別變數中的選項）等因素而造成的問題。然而vtreat在使用上不是很直覺。本篇學習筆記在此不會說明太多vtreat的功能，如需要了解可先參考<a href="https://arxiv.org/abs/1611.09477" target="_blank" rel="noopener noreferrer">連結1</a>，<a href="https://www.r-bloggers.com/a-demonstration-of-vtreat-data-preparation/" target="_blank" rel="noopener noreferrer">連結2</a>和<a href="https://github.com/WinVector/vtreat" target="_blank" rel="noopener noreferrer">連結3</a>。</p>
<p>以下使用vtreat將training & testing資料即重新one-hot encoding編碼。</p>

		<div id="crayon-60ed86a82434c289924650" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# variable names
features <- setdiff(names(ames_train), "Sale_Price")

# Create the treatment plan from the training data
treatplan <- vtreat::designTreatmentsZ(ames_train, features, verbose = FALSE)

# Get the "clean" variable names from the scoreFrame
new_vars <- treatplan %>%
  magrittr::use_series(scoreFrame) %>%        
  dplyr::filter(code %in% c("clean", "lev")) %>% 
  magrittr::use_series(varName)     

# Prepare the training data
features_train <- vtreat::prepare(treatplan, ames_train, varRestriction = new_vars) %>% as.matrix()
response_train <- ames_train$Sale_Price

# Prepare the test data
features_test <- vtreat::prepare(treatplan, ames_test, varRestriction = new_vars) %>% as.matrix()
response_test <- ames_test$Sale_Price</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82434c289924650-19">19</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82434c289924650-1"># variable names</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-2">features <div class="crayon-line" id="crayon-60ed86a82434c289924650-3"> </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-4"># Create the treatment plan from the training data</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-5">treatplan <div class="crayon-line" id="crayon-60ed86a82434c289924650-6"> </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-7"># Get the "clean" variable names from the scoreFrame</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-8">new_vars %</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-9">  magrittr::use_series(scoreFrame) %>%        </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-10">  dplyr::filter(code %in% c("clean", "lev")) %>% </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-11">  magrittr::use_series(varName)     </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-12"> </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-13"># Prepare the training data</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-14">features_train % as.matrix()</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-15">response_train <div class="crayon-line" id="crayon-60ed86a82434c289924650-16"> </div><div class="crayon-line" id="crayon-60ed86a82434c289924650-17"># Prepare the test data</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-18">features_test % as.matrix()</div><div class="crayon-line" id="crayon-60ed86a82434c289924650-19">response_test </div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>編碼後的維度個數</p>

		<div id="crayon-60ed86a82434d265226142" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
dim(features_train)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82434d265226142-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82434d265226142-1">dim(features_train)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82434e505668225" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 2051  348
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82434e505668225-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82434e505668225-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82434e505668225-1">## [1] 2051  348</div><div class="crayon-line" id="crayon-60ed86a82434e505668225-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824350500930449" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
dim(features_test)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824350500930449-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824350500930449-1">dim(features_test)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824351082202724" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 879 348
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824351082202724-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824351082202724-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824351082202724-1">## [1] 879 348</div><div class="crayon-line" id="crayon-60ed86a824351082202724-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>xgboost提供不同的訓練函數(像是xgb.train,xgb.cv)。而我們這邊會使用能夠進行cross-validation的xgb.cv。以下我們訓練一個使用5-fold cv且使用1000棵樹的xgb模型。xgb.cv中有許多可調整的參數(基本的參數都跟xgb.train是一樣的)，幾個比較常出現的參數（與其預設值）分別為以下：</p>
<ul>
<li>data: 只允許數值型矩陣，如xgb.DMatrix, matrix, dgCMartirx類型。</li>
<li>nrounds: 模型所使用的樹個數(迭代數)。</li>
<li>nfold: 將投入的data參數值（在此處為訓練資料集），隨機切割(partition)為n等分的子樣本。</li>
<li>params: list()，參數list。常用的參數包括：
<ul>
<li>objective : 目標函數(亦可使用params = list()進行參數指定)。常用的目標函數包括：</li>
<li>reg:linear : 線性迴歸</li>
<li>binary:logistic : 分類用的羅吉斯迴歸</li>
<li>eta: learning rate,學習步伐(default為0.3)</li>
<li>max_depth: tree depth, 樹模型的深度(default為6)</li>
<li>min_child_weight: minimum node size,最小節點個數值(default為1)</li>
<li>subsample: percentage of training data to sample for each tree (就如同gbm套件中的bag.fraction參數),每棵樹模型將抽樣使用多少比例的訓練資料集(default: 100% -> 沒有OOB sample)，用來避免overfitting，亦可加快運算(分析較少的資料)。</li>
</ul>
</li>
</ul>
<p>其中cross-validation會執行nrounds次，每次迭代中，nfold個子樣本都會輪流作為驗證資料集，來驗證nfold-1子集合所訓練出的模型。</p>

		<div id="crayon-60ed86a824352326017700" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# reproducibility
set.seed(123)

system.time(
  xgb.fit1 <- xgb.cv(
  data = features_train,
  label = response_train,
  nrounds = 1000,
  nfold = 5,
  objective = "reg:linear",  # for regression models
  verbose = 0               # silent,不要顯示詳細資訊
)
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824352326017700-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824352326017700-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824352326017700-1"># reproducibility</div><div class="crayon-line" id="crayon-60ed86a824352326017700-2">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824352326017700-3"> </div><div class="crayon-line" id="crayon-60ed86a824352326017700-4">system.time(</div><div class="crayon-line" id="crayon-60ed86a824352326017700-5">  xgb.fit1 <div class="crayon-line" id="crayon-60ed86a824352326017700-6">  data = features_train,</div><div class="crayon-line" id="crayon-60ed86a824352326017700-7">  label = response_train,</div><div class="crayon-line" id="crayon-60ed86a824352326017700-8">  nrounds = 1000,</div><div class="crayon-line" id="crayon-60ed86a824352326017700-9">  nfold = 5,</div><div class="crayon-line" id="crayon-60ed86a824352326017700-10">  objective = "reg:linear",  # for regression models</div><div class="crayon-line" id="crayon-60ed86a824352326017700-11">  verbose = 0               # silent,不要顯示詳細資訊</div><div class="crayon-line" id="crayon-60ed86a824352326017700-12">)</div><div class="crayon-line" id="crayon-60ed86a824352326017700-13">)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824353777978382" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    user  system elapsed 
## 234.376   2.540 244.823
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824353777978382-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824353777978382-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824353777978382-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824353777978382-1">##    user  system elapsed </div><div class="crayon-line" id="crayon-60ed86a824353777978382-2">## 234.376   2.540 244.823</div><div class="crayon-line" id="crayon-60ed86a824353777978382-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>檢視每次迭代的cross-validation的結果。分別會有訓練資料集的平均RMSE，和測試資料集的平均RMSE，希望兩者越接近越好。</p>

		<div id="crayon-60ed86a824355213246098" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
print(xgb.fit1,verbose = TRUE)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824355213246098-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824355213246098-1">print(xgb.fit1,verbose = TRUE)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824356385586501" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## ##### xgb.cv 5-folds
## call:
##   xgb.cv(data = features_train, nrounds = 1000, nfold = 5, label = response_train, 
##     verbose = 0, objective = "reg:linear")
## params (as set within xgb.cv):
##   objective = "reg:linear", silent = "1"
## callbacks:
##   cb.evaluation.log()
## niter: 1000
## evaluation_log:
##     iter train_rmse_mean train_rmse_std test_rmse_mean test_rmse_std
##        1    1.420236e+05   850.15595494      142612.98      4504.553
##        2    1.023304e+05   645.18845214      104198.60      4628.932
##        3    7.443451e+04   535.78249514       77533.40      4635.993
##        4    5.484559e+04   468.37246662       59185.94      4420.339
##        5    4.118994e+04   386.94999310       47545.03      4452.632
## ---                                                                 
##      996    4.831320e-02     0.01131165       27373.21      3243.812
##      997    4.831320e-02     0.01131165       27373.21      3243.812
##      998    4.831320e-02     0.01131165       27373.21      3243.812
##      999    4.831320e-02     0.01131165       27373.21      3243.811
##     1000    4.831320e-02     0.01131165       27373.21      3243.812
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824356385586501-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824356385586501-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824356385586501-1">## ##### xgb.cv 5-folds</div><div class="crayon-line" id="crayon-60ed86a824356385586501-2">## call:</div><div class="crayon-line" id="crayon-60ed86a824356385586501-3">##   xgb.cv(data = features_train, nrounds = 1000, nfold = 5, label = response_train, </div><div class="crayon-line" id="crayon-60ed86a824356385586501-4">##     verbose = 0, objective = "reg:linear")</div><div class="crayon-line" id="crayon-60ed86a824356385586501-5">## params (as set within xgb.cv):</div><div class="crayon-line" id="crayon-60ed86a824356385586501-6">##   objective = "reg:linear", silent = "1"</div><div class="crayon-line" id="crayon-60ed86a824356385586501-7">## callbacks:</div><div class="crayon-line" id="crayon-60ed86a824356385586501-8">##   cb.evaluation.log()</div><div class="crayon-line" id="crayon-60ed86a824356385586501-9">## niter: 1000</div><div class="crayon-line" id="crayon-60ed86a824356385586501-10">## evaluation_log:</div><div class="crayon-line" id="crayon-60ed86a824356385586501-11">##     iter train_rmse_mean train_rmse_std test_rmse_mean test_rmse_std</div><div class="crayon-line" id="crayon-60ed86a824356385586501-12">##        1    1.420236e+05   850.15595494      142612.98      4504.553</div><div class="crayon-line" id="crayon-60ed86a824356385586501-13">##        2    1.023304e+05   645.18845214      104198.60      4628.932</div><div class="crayon-line" id="crayon-60ed86a824356385586501-14">##        3    7.443451e+04   535.78249514       77533.40      4635.993</div><div class="crayon-line" id="crayon-60ed86a824356385586501-15">##        4    5.484559e+04   468.37246662       59185.94      4420.339</div><div class="crayon-line" id="crayon-60ed86a824356385586501-16">##        5    4.118994e+04   386.94999310       47545.03      4452.632</div><div class="crayon-line" id="crayon-60ed86a824356385586501-17">## ---                                                                 </div><div class="crayon-line" id="crayon-60ed86a824356385586501-18">##      996    4.831320e-02     0.01131165       27373.21      3243.812</div><div class="crayon-line" id="crayon-60ed86a824356385586501-19">##      997    4.831320e-02     0.01131165       27373.21      3243.812</div><div class="crayon-line" id="crayon-60ed86a824356385586501-20">##      998    4.831320e-02     0.01131165       27373.21      3243.812</div><div class="crayon-line" id="crayon-60ed86a824356385586501-21">##      999    4.831320e-02     0.01131165       27373.21      3243.811</div><div class="crayon-line" id="crayon-60ed86a824356385586501-22">##     1000    4.831320e-02     0.01131165       27373.21      3243.812</div><div class="crayon-line" id="crayon-60ed86a824356385586501-23"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>檢視回傳xbg.fit1物件的屬性(attributes)。</p>

		<div id="crayon-60ed86a824357060349871" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
attributes(xgb.fit1)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824357060349871-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824357060349871-1">attributes(xgb.fit1)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824358478586287" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## $names
## [1] "call"           "params"         "callbacks"     
## [4] "evaluation_log" "niter"          "nfeatures"     
## [7] "folds"         
## 
## $class
## [1] "xgb.cv.synchronous"
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824358478586287-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824358478586287-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824358478586287-1">## $names</div><div class="crayon-line" id="crayon-60ed86a824358478586287-2">## [1] "call"           "params"         "callbacks"     </div><div class="crayon-line" id="crayon-60ed86a824358478586287-3">## [4] "evaluation_log" "niter"          "nfeatures"     </div><div class="crayon-line" id="crayon-60ed86a824358478586287-4">## [7] "folds"         </div><div class="crayon-line" id="crayon-60ed86a824358478586287-5">## </div><div class="crayon-line" id="crayon-60ed86a824358478586287-6">## $class</div><div class="crayon-line" id="crayon-60ed86a824358478586287-7">## [1] "xgb.cv.synchronous"</div><div class="crayon-line" id="crayon-60ed86a824358478586287-8"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>回傳的xgb.fit1物件包含很多重要資訊。特別像是我們可以擷取xgb.fit1$evaluation_log來觀察發生在訓練資料集和測試資料集的最小的RMSE和最適的樹數量(跟print(xgb.fit1)效果一樣)，以及cross-validation error。</p>

		<div id="crayon-60ed86a82435a834315947" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
xgb.fit1$evaluation_log</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82435a834315947-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82435a834315947-1">xgb.fit1$evaluation_log</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82435b957043359" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##       iter train_rmse_mean train_rmse_std test_rmse_mean
##    1:    1    1.420236e+05   850.15595494      142612.98
##    2:    2    1.023304e+05   645.18845214      104198.60
##    3:    3    7.443451e+04   535.78249514       77533.40
##    4:    4    5.484559e+04   468.37246662       59185.94
##    5:    5    4.118994e+04   386.94999310       47545.03
##   ---                                                   
##  996:  996    4.831320e-02     0.01131165       27373.21
##  997:  997    4.831320e-02     0.01131165       27373.21
##  998:  998    4.831320e-02     0.01131165       27373.21
##  999:  999    4.831320e-02     0.01131165       27373.21
## 1000: 1000    4.831320e-02     0.01131165       27373.21
##       test_rmse_std
##    1:      4504.553
##    2:      4628.932
##    3:      4635.993
##    4:      4420.339
##    5:      4452.632
##   ---              
##  996:      3243.812
##  997:      3243.812
##  998:      3243.812
##  999:      3243.811
## 1000:      3243.812
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-21">21</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-22">22</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-23">23</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-24">24</div><div class="crayon-num" data-line="crayon-60ed86a82435b957043359-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82435b957043359-1">##       iter train_rmse_mean train_rmse_std test_rmse_mean</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-2">##    1:    1    1.420236e+05   850.15595494      142612.98</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-3">##    2:    2    1.023304e+05   645.18845214      104198.60</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-4">##    3:    3    7.443451e+04   535.78249514       77533.40</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-5">##    4:    4    5.484559e+04   468.37246662       59185.94</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-6">##    5:    5    4.118994e+04   386.94999310       47545.03</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-7">##   ---                                                   </div><div class="crayon-line" id="crayon-60ed86a82435b957043359-8">##  996:  996    4.831320e-02     0.01131165       27373.21</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-9">##  997:  997    4.831320e-02     0.01131165       27373.21</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-10">##  998:  998    4.831320e-02     0.01131165       27373.21</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-11">##  999:  999    4.831320e-02     0.01131165       27373.21</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-12">## 1000: 1000    4.831320e-02     0.01131165       27373.21</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-13">##       test_rmse_std</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-14">##    1:      4504.553</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-15">##    2:      4628.932</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-16">##    3:      4635.993</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-17">##    4:      4420.339</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-18">##    5:      4452.632</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-19">##   ---              </div><div class="crayon-line" id="crayon-60ed86a82435b957043359-20">##  996:      3243.812</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-21">##  997:      3243.812</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-22">##  998:      3243.812</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-23">##  999:      3243.811</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-24">## 1000:      3243.812</div><div class="crayon-line" id="crayon-60ed86a82435b957043359-25"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>我們找出使得訓練和測試誤差最小的迭代數(模型所使用的樹個數)，以及所對應的RMSE。由下表所示，訓練誤差持續下降，並約在924棵樹時逼近為零(0.048)。然而，交叉驗證誤差約在60棵樹左右達到最小RMSE(約27K)。</p>

		<div id="crayon-60ed86a82435c896858031" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# get number of trees that minimize error
xgb.fit1$evaluation_log %>%
  dplyr::summarise(
    ntrees.train = which(train_rmse_mean == min(train_rmse_mean))[1],
    rmse.train   = min(train_rmse_mean),
    ntrees.test  = which(test_rmse_mean == min(test_rmse_mean))[1],
    rmse.test   = min(test_rmse_mean)
  )</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82435c896858031-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82435c896858031-1"># get number of trees that minimize error</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-2">xgb.fit1$evaluation_log %>%</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-3">  dplyr::summarise(</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-4">    ntrees.train = which(train_rmse_mean == min(train_rmse_mean))[1],</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-5">    rmse.train   = min(train_rmse_mean),</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-6">    ntrees.test  = which(test_rmse_mean == min(test_rmse_mean))[1],</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-7">    rmse.test   = min(test_rmse_mean)</div><div class="crayon-line" id="crayon-60ed86a82435c896858031-8">  )</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82435e166844889" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##   ntrees.train rmse.train ntrees.test rmse.test
## 1          924  0.0483002          60  27337.79
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82435e166844889-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82435e166844889-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82435e166844889-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82435e166844889-1">##   ntrees.train rmse.train ntrees.test rmse.test</div><div class="crayon-line" id="crayon-60ed86a82435e166844889-2">## 1          924  0.0483002          60  27337.79</div><div class="crayon-line" id="crayon-60ed86a82435e166844889-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82435f020096844" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##   ntrees.train rmse.train ntrees.test rmse.test
## 1          965  0.5022836          60  27572.31</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82435f020096844-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82435f020096844-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82435f020096844-1">##   ntrees.train rmse.train ntrees.test rmse.test</div><div class="crayon-line" id="crayon-60ed86a82435f020096844-2">## 1          965  0.5022836          60  27572.31</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>將詳細xgboost模型迭代資訊繪出如下，紅色線代表訓練誤差，藍色線表示交叉驗證誤差。</p>

		<div id="crayon-60ed86a824360920488685" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# plot error vs number trees
ggplot(xgb.fit1$evaluation_log) +
  geom_line(aes(iter, train_rmse_mean), color = "red") +
  geom_line(aes(iter, test_rmse_mean), color = "blue")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824360920488685-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824360920488685-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824360920488685-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824360920488685-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824360920488685-1"># plot error vs number trees</div><div class="crayon-line" id="crayon-60ed86a824360920488685-2">ggplot(xgb.fit1$evaluation_log) +</div><div class="crayon-line" id="crayon-60ed86a824360920488685-3">  geom_line(aes(iter, train_rmse_mean), color = "red") +</div><div class="crayon-line" id="crayon-60ed86a824360920488685-4">  geom_line(aes(iter, test_rmse_mean), color = "blue")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-36-1-1.png" alt="gradient boosting machines, GBM"></p>
<p>一個xbm.cv滿不錯的功能就是early stopping。該功能讓我們可在cross validation error在連續第n棵樹不再下降的情況下，告訴函式該停止。以上面的例子來說，我們可以設定當cv error在連續10個樹模型(迭代)沒有下降時停止迭代(early_stopping_rounds = 10)。該功能有助於加速下一個tuning校正過程。</p>

		<div id="crayon-60ed86a824361642564528" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# reproducibility
set.seed(123)

xgb.fit2 <- xgb.cv(
  data = features_train,
  label = response_train,
  nrounds = 1000,
  nfold = 5,
  objective = "reg:linear",  # for regression models
  verbose = 0,               # silent,
  early_stopping_rounds = 10 # stop if no improvement for 10 consecutive trees
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824361642564528-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824361642564528-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824361642564528-1"># reproducibility</div><div class="crayon-line" id="crayon-60ed86a824361642564528-2">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824361642564528-3"> </div><div class="crayon-line" id="crayon-60ed86a824361642564528-4">xgb.fit2 <div class="crayon-line" id="crayon-60ed86a824361642564528-5">  data = features_train,</div><div class="crayon-line" id="crayon-60ed86a824361642564528-6">  label = response_train,</div><div class="crayon-line" id="crayon-60ed86a824361642564528-7">  nrounds = 1000,</div><div class="crayon-line" id="crayon-60ed86a824361642564528-8">  nfold = 5,</div><div class="crayon-line" id="crayon-60ed86a824361642564528-9">  objective = "reg:linear",  # for regression models</div><div class="crayon-line" id="crayon-60ed86a824361642564528-10">  verbose = 0,               # silent,</div><div class="crayon-line" id="crayon-60ed86a824361642564528-11">  early_stopping_rounds = 10 # stop if no improvement for 10 consecutive trees</div><div class="crayon-line" id="crayon-60ed86a824361642564528-12">)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>將迭代的過程細節繪出：</p>

		<div id="crayon-60ed86a824362837715746" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# plot error vs number trees
ggplot(xgb.fit2$evaluation_log) +
  geom_line(aes(iter, train_rmse_mean), color = "red") +
  geom_line(aes(iter, test_rmse_mean), color = "blue")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824362837715746-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824362837715746-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824362837715746-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824362837715746-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824362837715746-1"># plot error vs number trees</div><div class="crayon-line" id="crayon-60ed86a824362837715746-2">ggplot(xgb.fit2$evaluation_log) +</div><div class="crayon-line" id="crayon-60ed86a824362837715746-3">  geom_line(aes(iter, train_rmse_mean), color = "red") +</div><div class="crayon-line" id="crayon-60ed86a824362837715746-4">  geom_line(aes(iter, test_rmse_mean), color = "blue")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-38-1-1.png" alt="gradient boosting machines, GBM"></p>
<h4>Tuning</h4>
<p>要tune XGBoost模型，我們會傳入一個parameters的list物件給params參數。幾個最常見的參數如下：</p>
<ul>
<li>eta : 控制學習步伐</li>
<li>max_depth: 樹的深度</li>
<li>min_child_weight: 末梢節點的最小觀測值個數</li>
<li>subsample: 每棵樹模型所抽樣訓練資料集的比例</li>
<li>colsample_bytrees: 每棵樹模型所抽樣的欄位數目</li>
</ul>
<p>舉例來說，如果想要指定特定參數值，我們可以將上面的模型設定重新編輯如下：</p>

		<div id="crayon-60ed86a824364638041940" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# create parameter list
  params <- list(
    eta = .1,
    max_depth = 5,
    min_child_weight = 2,
    subsample = .8,
    colsample_bytree = .9
  )

# reproducibility
set.seed(123)

# train model
system.time(
xgb.fit3 <- xgb.cv(
  params = params,
  data = features_train,
  label = response_train,
  nrounds = 1000,
  nfold = 5,
  objective = "reg:linear",  # for regression models
  verbose = 0,               # silent,
  early_stopping_rounds = 10 # stop if no improvement for 10 consecutive trees
)
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824364638041940-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-23">23</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-24">24</div><div class="crayon-num" data-line="crayon-60ed86a824364638041940-25">25</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824364638041940-1"># create parameter list</div><div class="crayon-line" id="crayon-60ed86a824364638041940-2">  params <div class="crayon-line" id="crayon-60ed86a824364638041940-3">    eta = .1,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-4">    max_depth = 5,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-5">    min_child_weight = 2,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-6">    subsample = .8,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-7">    colsample_bytree = .9</div><div class="crayon-line" id="crayon-60ed86a824364638041940-8">  )</div><div class="crayon-line" id="crayon-60ed86a824364638041940-9"> </div><div class="crayon-line" id="crayon-60ed86a824364638041940-10"># reproducibility</div><div class="crayon-line" id="crayon-60ed86a824364638041940-11">set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a824364638041940-12"> </div><div class="crayon-line" id="crayon-60ed86a824364638041940-13"># train model</div><div class="crayon-line" id="crayon-60ed86a824364638041940-14">system.time(</div><div class="crayon-line" id="crayon-60ed86a824364638041940-15">xgb.fit3 <div class="crayon-line" id="crayon-60ed86a824364638041940-16">  params = params,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-17">  data = features_train,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-18">  label = response_train,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-19">  nrounds = 1000,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-20">  nfold = 5,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-21">  objective = "reg:linear",  # for regression models</div><div class="crayon-line" id="crayon-60ed86a824364638041940-22">  verbose = 0,               # silent,</div><div class="crayon-line" id="crayon-60ed86a824364638041940-23">  early_stopping_rounds = 10 # stop if no improvement for 10 consecutive trees</div><div class="crayon-line" id="crayon-60ed86a824364638041940-24">)</div><div class="crayon-line" id="crayon-60ed86a824364638041940-25">)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824365873183518" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    user  system elapsed 
##  39.185   0.124  39.446
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824365873183518-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824365873183518-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824365873183518-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824365873183518-1">##    user  system elapsed </div><div class="crayon-line" id="crayon-60ed86a824365873183518-2">##  39.185   0.124  39.446</div><div class="crayon-line" id="crayon-60ed86a824365873183518-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824366982567947" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# assess results
xgb.fit3$evaluation_log %>%
  dplyr::summarise(
    ntrees.train = which(train_rmse_mean == min(train_rmse_mean))[1],
    rmse.train   = min(train_rmse_mean),
    ntrees.test  = which(test_rmse_mean == min(test_rmse_mean))[1],
    rmse.test   = min(test_rmse_mean)
  )</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824366982567947-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824366982567947-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824366982567947-1"># assess results</div><div class="crayon-line" id="crayon-60ed86a824366982567947-2">xgb.fit3$evaluation_log %>%</div><div class="crayon-line" id="crayon-60ed86a824366982567947-3">  dplyr::summarise(</div><div class="crayon-line" id="crayon-60ed86a824366982567947-4">    ntrees.train = which(train_rmse_mean == min(train_rmse_mean))[1],</div><div class="crayon-line" id="crayon-60ed86a824366982567947-5">    rmse.train   = min(train_rmse_mean),</div><div class="crayon-line" id="crayon-60ed86a824366982567947-6">    ntrees.test  = which(test_rmse_mean == min(test_rmse_mean))[1],</div><div class="crayon-line" id="crayon-60ed86a824366982567947-7">    rmse.test   = min(test_rmse_mean)</div><div class="crayon-line" id="crayon-60ed86a824366982567947-8">  )</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824367615613542" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##   ntrees.train rmse.train ntrees.test rmse.test
## 1          220   5054.546         210  24159.13
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824367615613542-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824367615613542-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824367615613542-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824367615613542-1">##   ntrees.train rmse.train ntrees.test rmse.test</div><div class="crayon-line" id="crayon-60ed86a824367615613542-2">## 1          220   5054.546         210  24159.13</div><div class="crayon-line" id="crayon-60ed86a824367615613542-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>想要執行更大型的search grid，我們可以使用和gbm相同的程序。先產生一個超參數hyperparameter search grid和儲存結果的欄位(最適樹模型個數與最小RMSE)。</p>
<p>以下我們創立一個4*4*4*3*3 = 576個參數排列組合的hyper grid。</p>

		<div id="crayon-60ed86a824368292735716" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# create hyperparameter grid
hyper_grid <- expand.grid(
  eta = c(.01, .05, .1, .3),
  max_depth = c(1, 3, 5, 7),
  min_child_weight = c(1, 3, 5, 7),
  subsample = c(.65, .8, 1), 
  colsample_bytree = c(.8, .9, 1),
  optimal_trees = 0,               # a place to dump results
  min_RMSE = 0                     # a place to dump results
)

nrow(hyper_grid)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824368292735716-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824368292735716-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824368292735716-1"># create hyperparameter grid</div><div class="crayon-line" id="crayon-60ed86a824368292735716-2">hyper_grid <div class="crayon-line" id="crayon-60ed86a824368292735716-3">  eta = c(.01, .05, .1, .3),</div><div class="crayon-line" id="crayon-60ed86a824368292735716-4">  max_depth = c(1, 3, 5, 7),</div><div class="crayon-line" id="crayon-60ed86a824368292735716-5">  min_child_weight = c(1, 3, 5, 7),</div><div class="crayon-line" id="crayon-60ed86a824368292735716-6">  subsample = c(.65, .8, 1), </div><div class="crayon-line" id="crayon-60ed86a824368292735716-7">  colsample_bytree = c(.8, .9, 1),</div><div class="crayon-line" id="crayon-60ed86a824368292735716-8">  optimal_trees = 0,               # a place to dump results</div><div class="crayon-line" id="crayon-60ed86a824368292735716-9">  min_RMSE = 0                     # a place to dump results</div><div class="crayon-line" id="crayon-60ed86a824368292735716-10">)</div><div class="crayon-line" id="crayon-60ed86a824368292735716-11"> </div><div class="crayon-line" id="crayon-60ed86a824368292735716-12">nrow(hyper_grid)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82436a557023113" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 576
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82436a557023113-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82436a557023113-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82436a557023113-1">## [1] 576</div><div class="crayon-line" id="crayon-60ed86a82436a557023113-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>接著，我們使用迴圈一一去執行XGBoost模型套用不同參數組合的結果，並將結果指標儲存。（*這段程序耗時，約6小時以上）</p>

		<div id="crayon-60ed86a82436b286555612" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# grid search 
for(i in 1:nrow(hyper_grid)) {

  # create parameter list
  params <- list(
    eta = hyper_grid$eta[i],
    max_depth = hyper_grid$max_depth[i],
    min_child_weight = hyper_grid$min_child_weight[i],
    subsample = hyper_grid$subsample[i],
    colsample_bytree = hyper_grid$colsample_bytree[i]
  )

  # reproducibility
  set.seed(123)

  # train model
  xgb.tune <- xgb.cv(
    params = params,
    data = features_train,
    label = response_train,
    nrounds = 5000,
    nfold = 5,
    objective = "reg:linear",  # for regression models
    verbose = 0,               # silent,
    early_stopping_rounds = 10 # stop if no improvement for 10 consecutive trees
  )

  # add min training error and trees to grid
  hyper_grid$optimal_trees[i] <- which.min(xgb.tune$evaluation_log$test_rmse_mean)
  hyper_grid$min_RMSE[i] <- min(xgb.tune$evaluation_log$test_rmse_mean)
}

hyper_grid %>%
  dplyr::arrange(min_RMSE) %>%
  head(10)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-21">21</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-22">22</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-23">23</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-24">24</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-25">25</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-26">26</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-27">27</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-28">28</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-29">29</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-30">30</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-31">31</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-32">32</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-33">33</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-34">34</div><div class="crayon-num" data-line="crayon-60ed86a82436b286555612-35">35</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82436b286555612-1"># grid search </div><div class="crayon-line" id="crayon-60ed86a82436b286555612-2">for(i in 1:nrow(hyper_grid)) {</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-3"> </div><div class="crayon-line" id="crayon-60ed86a82436b286555612-4">  # create parameter list</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-5">  params <div class="crayon-line" id="crayon-60ed86a82436b286555612-6">    eta = hyper_grid$eta[i],</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-7">    max_depth = hyper_grid$max_depth[i],</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-8">    min_child_weight = hyper_grid$min_child_weight[i],</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-9">    subsample = hyper_grid$subsample[i],</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-10">    colsample_bytree = hyper_grid$colsample_bytree[i]</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-11">  )</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-12"> </div><div class="crayon-line" id="crayon-60ed86a82436b286555612-13">  # reproducibility</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-14">  set.seed(123)</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-15"> </div><div class="crayon-line" id="crayon-60ed86a82436b286555612-16">  # train model</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-17">  xgb.tune <div class="crayon-line" id="crayon-60ed86a82436b286555612-18">    params = params,</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-19">    data = features_train,</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-20">    label = response_train,</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-21">    nrounds = 5000,</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-22">    nfold = 5,</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-23">    objective = "reg:linear",  # for regression models</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-24">    verbose = 0,               # silent,</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-25">    early_stopping_rounds = 10 # stop if no improvement for 10 consecutive trees</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-26">  )</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-27"> </div><div class="crayon-line" id="crayon-60ed86a82436b286555612-28">  # add min training error and trees to grid</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-29">  hyper_grid$optimal_trees[i] <div class="crayon-line" id="crayon-60ed86a82436b286555612-30">  hyper_grid$min_RMSE[i] <div class="crayon-line" id="crayon-60ed86a82436b286555612-31">}</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-32"> </div><div class="crayon-line" id="crayon-60ed86a82436b286555612-33">hyper_grid %>%</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-34">  dplyr::arrange(min_RMSE) %>%</div><div class="crayon-line" id="crayon-60ed86a82436b286555612-35">  head(10)</div></div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82436d922825462" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##     eta max_depth min_child_weight subsample colsample_bytree optimal_trees min_RMSE
## 1  0.01         5                3      0.65              0.8          1501 23255.95
## 2  0.05         5                5      0.80              0.9           486 23269.22
## 3  0.01         5                3      0.65              0.9          1325 23373.22
## 4  0.01         5                1      0.65              0.8          1257 23396.13
## 5  0.05         5                7      0.65              1.0           508 23437.00
## 6  0.01         3                3      0.65              1.0          2301 23457.89
## 7  0.01         5                3      0.80              0.8          1488 23499.83
## 8  0.01         7                3      0.65              0.8          1178 23519.53
## 9  0.01         3                5      0.65              0.9          2274 23526.33
## 10 0.05         5                7      0.80              0.8           401 23555.05
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82436d922825462-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82436d922825462-1">##     eta max_depth min_child_weight subsample colsample_bytree optimal_trees min_RMSE</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-2">## 1  0.01         5                3      0.65              0.8          1501 23255.95</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-3">## 2  0.05         5                5      0.80              0.9           486 23269.22</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-4">## 3  0.01         5                3      0.65              0.9          1325 23373.22</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-5">## 4  0.01         5                1      0.65              0.8          1257 23396.13</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-6">## 5  0.05         5                7      0.65              1.0           508 23437.00</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-7">## 6  0.01         3                3      0.65              1.0          2301 23457.89</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-8">## 7  0.01         5                3      0.80              0.8          1488 23499.83</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-9">## 8  0.01         7                3      0.65              0.8          1178 23519.53</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-10">## 9  0.01         3                5      0.65              0.9          2274 23526.33</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-11">## 10 0.05         5                7      0.80              0.8           401 23555.05</div><div class="crayon-line" id="crayon-60ed86a82436d922825462-12"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>經過評估後，可能還會繼續測是幾個不同的參數組合，去找到最能影響模型成效的參數。這邊有<a href="https://www.analyticsvidhya.com/blog/2016/03/complete-guide-parameter-tuning-xgboost-with-codes-python/">一篇很棒的文章</a>在討論tuning XGBoost的策略法。但為了簡短，在此我們即假設上述結果為globally最適的模型，並使用xgb.train()來配飾最終模型。(*xgboost)</p>

		<div id="crayon-60ed86a82436e622056353" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# parameter list
params <- list(
  eta = 0.01,
  max_depth = 5,
  min_child_weight = 5,
  subsample = 0.65,
  colsample_bytree = 1
)

# train final model
xgb.fit.final <- xgboost(
  params = params,
  data = features_train,
  label = response_train,
  nrounds = 1576,
  objective = "reg:linear",
  verbose = 0
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82436e622056353-18">18</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82436e622056353-1"># parameter list</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-2">params <div class="crayon-line" id="crayon-60ed86a82436e622056353-3">  eta = 0.01,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-4">  max_depth = 5,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-5">  min_child_weight = 5,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-6">  subsample = 0.65,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-7">  colsample_bytree = 1</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-8">)</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-9"> </div><div class="crayon-line" id="crayon-60ed86a82436e622056353-10"># train final model</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-11">xgb.fit.final <div class="crayon-line" id="crayon-60ed86a82436e622056353-12">  params = params,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-13">  data = features_train,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-14">  label = response_train,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-15">  nrounds = 1576,</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-16">  objective = "reg:linear",</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-17">  verbose = 0</div><div class="crayon-line" id="crayon-60ed86a82436e622056353-18">)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h4>Visualization</h4>
<h5>Variable importance</h5>
<p>xgboost提供內建的變數重要性繪圖功能。首先，可以使用xgb.importance()函數建立一個重要矩陣(importance matrix)的data.table，然後再將這個重要矩陣(importance matrix)投入xgb.plot.importance()函數進行繪圖。</p>
<p>在重要性矩陣中，Gain, Cover, Frequency欄位分別代表三種不同的變數重要性衡量的方法（此為tree model的衡量指標，如果是linear mode，衡量指標則會是Weight(模型中的線性係數)和Class）：</p>
<ol>
<li>Gain(貢獻度): 相應特徵對模型的相對貢獻度，計算特徵在模型中每棵樹的貢獻。其與gbm套件中的relative.influence是同意的。</li>
<li>Cover(觀測值個數涵蓋率): 與該特徵相關的相對觀察值個數(%)。比如說，你有100個觀察值，4個特徵變數3棵樹，並假設feature 1是用來區分葉節點並在樹tree1, tree2, tree3有各有10,5,2個觀察值；於是feature 1的cover會被計算為10+5+2=17個觀察值。feature2 ~ feature4亦會計算各自的cover，並以該特徵涵蓋變數個數相對於所有特徵總涵蓋變數個數計算百分比。</li>
<li>Frequency(出現在模型所有樹的相對次數):代表某特徵出現在模型中樹的相對次數百分比(%)。就上面的範例來說，假設feature 1分別在tree1, tree2,tree3的分割樹(splits)分別是2, 1, 3，那麼feature 1的權重將是2+1+3 = 6。feature 1的frequency則是計算該特徵的權重相對於其他features的權重加總。</li>
</ol>
<p></p>

		<div id="crayon-60ed86a82436f611924351" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# create importance matrix
importance_matrix <- xgb.importance(model = xgb.fit.final)

importance_matrix</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82436f611924351-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82436f611924351-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82436f611924351-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82436f611924351-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82436f611924351-1"># create importance matrix</div><div class="crayon-line" id="crayon-60ed86a82436f611924351-2">importance_matrix <div class="crayon-line" id="crayon-60ed86a82436f611924351-3"> </div><div class="crayon-line" id="crayon-60ed86a82436f611924351-4">importance_matrix</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824370301434782" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##                                                          Feature         Gain        Cover    Frequency
##   1:                                                 Garage_Cars 2.508517e-01 1.780750e-02 8.503913e-03
##   2:                                                 Gr_Liv_Area 1.629517e-01 7.008097e-02 6.596177e-02
##   3:                                   Bsmt_Qual_lev_x_Excellent 1.249057e-01 1.408468e-02 7.111680e-03
##   4:                                               Total_Bsmt_SF 6.487028e-02 5.422924e-02 5.535069e-02
##   5:                                                  Year_Built 5.279356e-02 2.547546e-02 2.697923e-02
##  ---                                                                                                   
## 238:                                   Garage_Type_lev_x_Basment 9.872921e-07 1.100922e-04 3.762793e-05
## 239:                                   Lot_Shape_lev_x_Irregular 8.863554e-07 9.469465e-05 3.762793e-05
## 240:                                       Functional_lev_x_Maj2 8.741157e-07 1.330922e-04 3.762793e-05
## 241: MS_SubClass_lev_x_Two_Family_conversion_All_Styles_and_Ages 7.552052e-07 3.820506e-05 3.762793e-05
## 242:    MS_SubClass_lev_x_One_and_Half_Story_Unfinished_All_Ages 1.986944e-07 1.443516e-06 3.762793e-05
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824370301434782-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824370301434782-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824370301434782-1">##                                                          Feature         Gain        Cover    Frequency</div><div class="crayon-line" id="crayon-60ed86a824370301434782-2">##   1:                                                 Garage_Cars 2.508517e-01 1.780750e-02 8.503913e-03</div><div class="crayon-line" id="crayon-60ed86a824370301434782-3">##   2:                                                 Gr_Liv_Area 1.629517e-01 7.008097e-02 6.596177e-02</div><div class="crayon-line" id="crayon-60ed86a824370301434782-4">##   3:                                   Bsmt_Qual_lev_x_Excellent 1.249057e-01 1.408468e-02 7.111680e-03</div><div class="crayon-line" id="crayon-60ed86a824370301434782-5">##   4:                                               Total_Bsmt_SF 6.487028e-02 5.422924e-02 5.535069e-02</div><div class="crayon-line" id="crayon-60ed86a824370301434782-6">##   5:                                                  Year_Built 5.279356e-02 2.547546e-02 2.697923e-02</div><div class="crayon-line" id="crayon-60ed86a824370301434782-7">##  ---                                                                                                   </div><div class="crayon-line" id="crayon-60ed86a824370301434782-8">## 238:                                   Garage_Type_lev_x_Basment 9.872921e-07 1.100922e-04 3.762793e-05</div><div class="crayon-line" id="crayon-60ed86a824370301434782-9">## 239:                                   Lot_Shape_lev_x_Irregular 8.863554e-07 9.469465e-05 3.762793e-05</div><div class="crayon-line" id="crayon-60ed86a824370301434782-10">## 240:                                       Functional_lev_x_Maj2 8.741157e-07 1.330922e-04 3.762793e-05</div><div class="crayon-line" id="crayon-60ed86a824370301434782-11">## 241: MS_SubClass_lev_x_Two_Family_conversion_All_Styles_and_Ages 7.552052e-07 3.820506e-05 3.762793e-05</div><div class="crayon-line" id="crayon-60ed86a824370301434782-12">## 242:    MS_SubClass_lev_x_One_and_Half_Story_Unfinished_All_Ages 1.986944e-07 1.443516e-06 3.762793e-05</div><div class="crayon-line" id="crayon-60ed86a824370301434782-13"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>將剛剛得到的data.table放入xgb.plot.importance()，繪製指定的”Gain”變數重要性圖表。</p>

		<div id="crayon-60ed86a824372671500616" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# variable importance plot
xgb.plot.importance(importance_matrix, top_n = 10, measure = "Gain")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824372671500616-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824372671500616-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824372671500616-1"># variable importance plot</div><div class="crayon-line" id="crayon-60ed86a824372671500616-2">xgb.plot.importance(importance_matrix, top_n = 10, measure = "Gain")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-45-1-1.png" alt="gradient boosting machines, GBM"></p>
<p>改使用’Cover’當作變數重要衡量法的結果與上面差很多。</p>

		<div id="crayon-60ed86a824373865518361" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# variable importance plot using 'cover'
xgb.plot.importance(importance_matrix, top_n = 10, measure = "Cover")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824373865518361-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824373865518361-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824373865518361-1"># variable importance plot using 'cover'</div><div class="crayon-line" id="crayon-60ed86a824373865518361-2">xgb.plot.importance(importance_matrix, top_n = 10, measure = "Cover")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-46-1-1.png" alt="gradient boosting machines, GBM"></p>
<h5>Partial dependence plots</h5>
<p>PDPs和ICE的運作與之前gbm套件是相似的。唯一差別在於你必須在partial()函數中加入訓練資料(train = features_train)(因為在此case中，partial無法自動擷取object所使用的training data)。我們以Garage_Cars為範例。</p>

		<div id="crayon-60ed86a824374677378346" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
pdp <- xgb.fit.final %>%
  partial(pred.var = "Garage_Cars", n.trees = 1576, grid.resolution = 100, train = features_train) %>%
  autoplot(rug = TRUE, train = features_train) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("PDP")

ice <- xgb.fit.final %>%
  partial(pred.var = "Garage_Cars", n.trees = 1576, grid.resolution = 100, train = features_train, ice = TRUE) %>%
  autoplot(rug = TRUE, train = features_train, alpha = .1, center = TRUE) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("ICE")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824374677378346-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824374677378346-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824374677378346-1">pdp %</div><div class="crayon-line" id="crayon-60ed86a824374677378346-2">  partial(pred.var = "Garage_Cars", n.trees = 1576, grid.resolution = 100, train = features_train) %>%</div><div class="crayon-line" id="crayon-60ed86a824374677378346-3">  autoplot(rug = TRUE, train = features_train) +</div><div class="crayon-line" id="crayon-60ed86a824374677378346-4">  scale_y_continuous(labels = scales::dollar) +</div><div class="crayon-line" id="crayon-60ed86a824374677378346-5">  ggtitle("PDP")</div><div class="crayon-line" id="crayon-60ed86a824374677378346-6"> </div><div class="crayon-line" id="crayon-60ed86a824374677378346-7">ice %</div><div class="crayon-line" id="crayon-60ed86a824374677378346-8">  partial(pred.var = "Garage_Cars", n.trees = 1576, grid.resolution = 100, train = features_train, ice = TRUE) %>%</div><div class="crayon-line" id="crayon-60ed86a824374677378346-9">  autoplot(rug = TRUE, train = features_train, alpha = .1, center = TRUE) +</div><div class="crayon-line" id="crayon-60ed86a824374677378346-10">  scale_y_continuous(labels = scales::dollar) +</div><div class="crayon-line" id="crayon-60ed86a824374677378346-11">  ggtitle("ICE")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824375675299108" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
gridExtra::grid.arrange(pdp, ice, nrow = 1)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824375675299108-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824375675299108-1">gridExtra::grid.arrange(pdp, ice, nrow = 1)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-47-1-1.png" alt="gradient boosting machines, GBM"></p>
<h5>LIME</h5>
<p>LIME內建提供給xgboost物件的功能(可以使用?model.type)。然而需要注意的是，要分析的局部觀察值需要採用與train, test相同的編碼處理程序(one-hot encoded)。並且當將資料投入lime::lime函式時，必須將其從matrix轉換成dataframe。</p>

		<div id="crayon-60ed86a824377117456671" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# one-hot encode the local observations to be assessed.
local_obs_onehot <- vtreat::prepare(treatplan, local_obs, varRestriction = new_vars)

# apply LIME
explainer <- lime(data.frame(features_train), xgb.fit.final)
explanation <- explain(local_obs_onehot, explainer, n_features = 5)
plot_features(explanation)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824377117456671-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824377117456671-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824377117456671-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824377117456671-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824377117456671-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824377117456671-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824377117456671-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824377117456671-1"># one-hot encode the local observations to be assessed.</div><div class="crayon-line" id="crayon-60ed86a824377117456671-2">local_obs_onehot <div class="crayon-line" id="crayon-60ed86a824377117456671-3"> </div><div class="crayon-line" id="crayon-60ed86a824377117456671-4"># apply LIME</div><div class="crayon-line" id="crayon-60ed86a824377117456671-5">explainer <div class="crayon-line" id="crayon-60ed86a824377117456671-6">explanation <div class="crayon-line" id="crayon-60ed86a824377117456671-7">plot_features(explanation)</div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-48-1-1.png" alt="gradient boosting machines, GBM"></p>
<h4>Predicting</h4>
<p>最後，我們使用predict()函數來對新資料集進行預測。然而，不像gbm，我們並不需要提供樹模型的個數。<br>
由下的結果可知，我們測試資料集的RMSE與先前gbm模型的RMSE(22K)是較低的(只差了$600左右，差距很小)。</p>

		<div id="crayon-60ed86a824378085354088" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# predict values for test data
pred <- predict(xgb.fit.final, features_test)

# results
caret::RMSE(pred, response_test)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824378085354088-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824378085354088-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824378085354088-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824378085354088-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824378085354088-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824378085354088-1"># predict values for test data</div><div class="crayon-line" id="crayon-60ed86a824378085354088-2">pred <div class="crayon-line" id="crayon-60ed86a824378085354088-3"> </div><div class="crayon-line" id="crayon-60ed86a824378085354088-4"># results</div><div class="crayon-line" id="crayon-60ed86a824378085354088-5">caret::RMSE(pred, response_test)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824379105202721" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 21433.41
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824379105202721-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824379105202721-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824379105202721-1">## [1] 21433.41</div><div class="crayon-line" id="crayon-60ed86a824379105202721-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h3>h2o</h3>
<p>R的h2O套件是一個強大高效能的java-based介面，允許基於local和cluster-based的佈署。該套件有相當完整的<a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/index.html" target="_blank" rel="noopener noreferrer">線上資源</a>，包括方法、code文件與教學。</p>
<p>h2o的幾個特色包括：</p>
<ul>
<li>在單一節點或多節點群集上進行分散式或平行式運算。</li>
<li>根據用戶指定的指標和使用者指定的相對容忍度收斂時，自動提前停止。</li>
<li>隨機GBM同時對欄位跟資料列進行抽樣(每次分割與每棵樹)以利得到廣義的解。</li>
<li>除了二項式binomial(Bernoulli)、高斯和多項式分佈函式外，亦支援指數型系列(Poisson, Gamma, Tweedie)和損失函數。</li>
<li>Grid Search超參數優化和模型挑選。</li>
<li>數據分散(data-distributed) – 代表整個資料集不必侷限在單一節點的記憶體，能夠擴展到任意大小的訓練資料集。</li>
<li>使用直方圖(histogram)來近似連續變數來加速。</li>
<li>使用動態分箱法(dynamic binning)，分箱的標準會依照每一顆樹模型切割時的最大最小值來動態調整。</li>
<li>使用平方誤差(squared error)來決定最適的切割點。</li>
<li>factor levels沒有限制。</li>
</ul>
<h4>基本的h2o實作</h4>
<p></p>

		<div id="crayon-60ed86a82437a872315408" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
h2o.no_progress()
h2o.init(max_mem_size = "5g")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82437a872315408-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82437a872315408-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82437a872315408-1">h2o.no_progress()</div><div class="crayon-line" id="crayon-60ed86a82437a872315408-2">h2o.init(max_mem_size = "5g")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82437c091611821" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##  Connection successful!
## 
## R is connected to the H2O cluster: 
##     H2O cluster uptime:         1 days 10 hours 
##     H2O cluster timezone:       Asia/Taipei 
##     H2O data parsing timezone:  UTC 
##     H2O cluster version:        3.22.1.1 
##     H2O cluster version age:    3 months and 12 days !!! 
##     H2O cluster name:           H2O_started_from_R_peihsuan_hxs725 
##     H2O cluster total nodes:    1 
##     H2O cluster total memory:   2.54 GB 
##     H2O cluster total cores:    4 
##     H2O cluster allowed cores:  4 
##     H2O cluster healthy:        TRUE 
##     H2O Connection ip:          localhost 
##     H2O Connection port:        54321 
##     H2O Connection proxy:       NA 
##     H2O Internal Security:      FALSE 
##     H2O API Extensions:         XGBoost, Algos, AutoML, Core V3, Core V4 
##     R Version:                  R version 3.5.2 (2018-12-20)
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82437c091611821-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82437c091611821-1">##  Connection successful!</div><div class="crayon-line" id="crayon-60ed86a82437c091611821-2">## </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-3">## R is connected to the H2O cluster: </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-4">##     H2O cluster uptime:         1 days 10 hours </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-5">##     H2O cluster timezone:       Asia/Taipei </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-6">##     H2O data parsing timezone:  UTC </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-7">##     H2O cluster version:        3.22.1.1 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-8">##     H2O cluster version age:    3 months and 12 days !!! </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-9">##     H2O cluster name:           H2O_started_from_R_peihsuan_hxs725 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-10">##     H2O cluster total nodes:    1 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-11">##     H2O cluster total memory:   2.54 GB </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-12">##     H2O cluster total cores:    4 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-13">##     H2O cluster allowed cores:  4 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-14">##     H2O cluster healthy:        TRUE </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-15">##     H2O Connection ip:          localhost </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-16">##     H2O Connection port:        54321 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-17">##     H2O Connection proxy:       NA </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-18">##     H2O Internal Security:      FALSE </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-19">##     H2O API Extensions:         XGBoost, Algos, AutoML, Core V3, Core V4 </div><div class="crayon-line" id="crayon-60ed86a82437c091611821-20">##     R Version:                  R version 3.5.2 (2018-12-20)</div><div class="crayon-line" id="crayon-60ed86a82437c091611821-21"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>gbm.h2o函數可允許我們透過H2O套件來執行GBM。然而，在我們開始執行初始模型時，我們需要將訓練資料轉換成h2o物件。h2o.gbm預設會採用以下參數來建立GBM模型：</p>
<ul>
<li>number of tree (ntrees): 50</li>
<li>learning rate (learning_rate): 0.1</li>
<li>tree depth(max_depth): 5</li>
<li>末梢節點的最小觀測值個數 (min_rows): 10</li>
<li>對資料列和資料欄位沒有抽樣</li>
</ul>
<p></p>

		<div id="crayon-60ed86a82437d675393978" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# create feature names
y <- "Sale_Price"
x <- setdiff(names(ames_train), y)

# turn training set into h2o object
train.h2o <- as.h2o(ames_train)

# training basic GBM model with defaults
h2o.fit1 <- h2o.gbm(
  x = x,
  y = y,
  training_frame = train.h2o,
  nfolds = 5
)

# assess model results
h2o.fit1</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82437d675393978-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82437d675393978-1"># create feature names</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-2">y <div class="crayon-line" id="crayon-60ed86a82437d675393978-3">x <div class="crayon-line" id="crayon-60ed86a82437d675393978-4"> </div><div class="crayon-line" id="crayon-60ed86a82437d675393978-5"># turn training set into h2o object</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-6">train.h2o <div class="crayon-line" id="crayon-60ed86a82437d675393978-7"> </div><div class="crayon-line" id="crayon-60ed86a82437d675393978-8"># training basic GBM model with defaults</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-9">h2o.fit1 <div class="crayon-line" id="crayon-60ed86a82437d675393978-10">  x = x,</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-11">  y = y,</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-12">  training_frame = train.h2o,</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-13">  nfolds = 5</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-14">)</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-15"> </div><div class="crayon-line" id="crayon-60ed86a82437d675393978-16"># assess model results</div><div class="crayon-line" id="crayon-60ed86a82437d675393978-17">h2o.fit1</div></div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82437e582945061" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## Model Details:
## ==============
## 
## H2ORegressionModel: gbm
## Model ID:  GBM_model_R_1554713367949_3 
## Model Summary: 
##   number_of_trees number_of_internal_trees model_size_in_bytes min_depth max_depth mean_depth min_leaves max_leaves mean_leaves
## 1              50                       50               17160         5         5    5.00000         10         31    22.60000
## 
## 
## H2ORegressionMetrics: gbm
## ** Reported on training data. **
## 
## MSE:  165078993
## RMSE:  12848.31
## MAE:  9243.007
## RMSLE:  0.08504509
## Mean Residual Deviance :  165078993
## 
## 
## 
## H2ORegressionMetrics: gbm
## ** Reported on cross-validation data. **
## ** 5-fold cross-validation on training data (Metrics computed for combined holdout predictions) **
## 
## MSE:  707783149
## RMSE:  26604.19
## MAE:  15570.2
## RMSLE:  0.1404869
## Mean Residual Deviance :  707783149
## 
## 
## Cross-Validation Metrics Summary: 
##                               mean           sd  cv_1_valid   cv_2_valid   cv_3_valid  cv_4_valid  cv_5_valid
## mae                      15547.765     721.0162   16325.277    16366.696    13728.291    15117.01   16201.549
## mean_residual_deviance 7.0412026E8 1.68594576E8 6.8916365E8 1.12267443E9 3.96582368E8 5.8667603E8 7.2550477E8
## mse                    7.0412026E8 1.68594576E8 6.8916365E8 1.12267443E9 3.96582368E8 5.8667603E8 7.2550477E8
## r2                       0.8918067   0.02474849   0.8868936    0.8282497   0.92912257  0.91696167  0.89780617
## residual_deviance      7.0412026E8 1.68594576E8 6.8916365E8 1.12267443E9 3.96582368E8 5.8667603E8 7.2550477E8
## rmse                     26165.846    3119.9976   26251.926    33506.336    19914.377   24221.396   26935.195
## rmsle                   0.13949537  0.010692091  0.13955544   0.16392557   0.14536715  0.11926634  0.12936236
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-21">21</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-22">22</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-23">23</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-24">24</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-25">25</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-26">26</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-27">27</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-28">28</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-29">29</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-30">30</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-31">31</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-32">32</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-33">33</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-34">34</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-35">35</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-36">36</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-37">37</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-38">38</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-39">39</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-40">40</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-41">41</div><div class="crayon-num" data-line="crayon-60ed86a82437e582945061-42">42</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82437e582945061-1">## Model Details:</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-2">## ==============</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-3">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-4">## H2ORegressionModel: gbm</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-5">## Model ID:  GBM_model_R_1554713367949_3 </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-6">## Model Summary: </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-7">##   number_of_trees number_of_internal_trees model_size_in_bytes min_depth max_depth mean_depth min_leaves max_leaves mean_leaves</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-8">## 1              50                       50               17160         5         5    5.00000         10         31    22.60000</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-9">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-10">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-11">## H2ORegressionMetrics: gbm</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-12">## ** Reported on training data. **</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-13">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-14">## MSE:  165078993</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-15">## RMSE:  12848.31</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-16">## MAE:  9243.007</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-17">## RMSLE:  0.08504509</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-18">## Mean Residual Deviance :  165078993</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-19">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-20">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-21">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-22">## H2ORegressionMetrics: gbm</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-23">## ** Reported on cross-validation data. **</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-24">## ** 5-fold cross-validation on training data (Metrics computed for combined holdout predictions) **</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-25">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-26">## MSE:  707783149</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-27">## RMSE:  26604.19</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-28">## MAE:  15570.2</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-29">## RMSLE:  0.1404869</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-30">## Mean Residual Deviance :  707783149</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-31">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-32">## </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-33">## Cross-Validation Metrics Summary: </div><div class="crayon-line" id="crayon-60ed86a82437e582945061-34">##                               mean           sd  cv_1_valid   cv_2_valid   cv_3_valid  cv_4_valid  cv_5_valid</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-35">## mae                      15547.765     721.0162   16325.277    16366.696    13728.291    15117.01   16201.549</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-36">## mean_residual_deviance 7.0412026E8 1.68594576E8 6.8916365E8 1.12267443E9 3.96582368E8 5.8667603E8 7.2550477E8</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-37">## mse                    7.0412026E8 1.68594576E8 6.8916365E8 1.12267443E9 3.96582368E8 5.8667603E8 7.2550477E8</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-38">## r2                       0.8918067   0.02474849   0.8868936    0.8282497   0.92912257  0.91696167  0.89780617</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-39">## residual_deviance      7.0412026E8 1.68594576E8 6.8916365E8 1.12267443E9 3.96582368E8 5.8667603E8 7.2550477E8</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-40">## rmse                     26165.846    3119.9976   26251.926    33506.336    19914.377   24221.396   26935.195</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-41">## rmsle                   0.13949537  0.010692091  0.13955544   0.16392557   0.14536715  0.11926634  0.12936236</div><div class="crayon-line" id="crayon-60ed86a82437e582945061-42"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>跟XGBoost類似，我們可以使用自動停止功能，這樣就可以提高樹模型的個數，直到模型改善幅度減少或停止在終止訓練程序。亦可設定當執行時間超過一定水準後停止程序(參考max_runtime_secs)。</p>
<p>舉例來說，我們使用5000棵樹訓練一個預設參數的模型，但是設定當連續十棵樹模型在交叉驗證誤差上沒有進步就停止的指令。而在此例可以看到，模型在約使用3743棵樹模型後停止訓練過程，對應的交叉驗證誤差RMSE為$24,684。</p>

		<div id="crayon-60ed86a824380020949475" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# training basic GBM model with defaults
h2o.fit2 <- h2o.gbm(
  x = x,
  y = y,
  training_frame = train.h2o,
  nfolds = 5,
  ntrees = 5000,
  stopping_rounds = 10,
  stopping_tolerance = 0,
  seed = 123
)

# model stopped after xx trees
h2o.fit2@parameters$ntrees</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824380020949475-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824380020949475-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824380020949475-1"># training basic GBM model with defaults</div><div class="crayon-line" id="crayon-60ed86a824380020949475-2">h2o.fit2 <div class="crayon-line" id="crayon-60ed86a824380020949475-3">  x = x,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-4">  y = y,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-5">  training_frame = train.h2o,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-6">  nfolds = 5,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-7">  ntrees = 5000,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-8">  stopping_rounds = 10,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-9">  stopping_tolerance = 0,</div><div class="crayon-line" id="crayon-60ed86a824380020949475-10">  seed = 123</div><div class="crayon-line" id="crayon-60ed86a824380020949475-11">)</div><div class="crayon-line" id="crayon-60ed86a824380020949475-12"> </div><div class="crayon-line" id="crayon-60ed86a824380020949475-13"># model stopped after xx trees</div><div class="crayon-line" id="crayon-60ed86a824380020949475-14">h2o.fit2@parameters$ntrees</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824381745718371" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 3712
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824381745718371-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824381745718371-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824381745718371-1">## [1] 3712</div><div class="crayon-line" id="crayon-60ed86a824381745718371-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824382377743712" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# cross validated RMSE
h2o.rmse(h2o.fit2, xval = TRUE)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824382377743712-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824382377743712-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824382377743712-1"># cross validated RMSE</div><div class="crayon-line" id="crayon-60ed86a824382377743712-2">h2o.rmse(h2o.fit2, xval = TRUE)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824383157325452" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 24683.95
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824383157325452-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824383157325452-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824383157325452-1">## [1] 24683.95</div><div class="crayon-line" id="crayon-60ed86a824383157325452-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h4>Tuning</h4>
<p>H2O套件提供需多可調整的參數。這部分值得你花時間閱讀相關的文件<a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/gbm.html#gbm-tuning-guide" target="_blank" rel="noopener noreferrer">H2O.ai</a>。在本筆記中，只會先專注在幾個較長使用的超參數組合。包括：</p>
<ul>
<li>樹的複雜度
<ul>
<li>ntrees: 使用樹模型個數</li>
<li>max_depth: 每棵樹的深度</li>
<li>min_rows: 末梢節點中所允許的最少觀測值個數</li>
</ul>
</li>
<li>學習步伐
<ul>
<li>learn_rate: 損失函數梯度下降的步伐</li>
<li>learn_rate_annealing: 允許使用高的學習步伐當作初始值，但隨著樹個數的增加而降低。</li>
</ul>
</li>
<li>加入隨機的特性
<ul>
<li>sample_rate: 建置每棵數所抽樣的訓練資料列數。</li>
<li>col_sample_rate: 建置每棵樹所抽樣的欄位數(跟xgboost套件中的colsample_bytree是一樣的)。</li>
</ul>
</li>
</ul>
<p>值得注意的是，還有能夠控制類別變數和連續變數如何編碼、分箱、切割的參數。預設的參數可以得到相當不錯的結果，但在特定情境中仍能透過調整這些小地方來微提高模型的效果。</p>
<p>執行h2o模型的grid search tuning有兩種選擇：full 或 random discrete grid search。</p>
<h5>Full grid search</h5>
<p>在full cartesian grid search法中，會完整依序執行grid中指定的所有超參數組合。這就是我們先前在gbm和xgboost手動撰寫for迴圈執行的參數校正過程。然而為了加快H2O訓練的過程，可以使用驗證資料集(validation set)來取代k-fold cross validation。</p>
<p>以下我們製造一個參數的grid，包含468(=3*3*3*2*3*3)種超參數排列組合。我們使用h2o.grid()來執行full grid search並同時設定停止參數來節省訓練的時間。</p>

		<div id="crayon-60ed86a824385845688720" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# create training & validation sets
split <- h2o.splitFrame(train.h2o, ratios = 0.75)
train <- split[[1]]
valid <- split[[2]]

# create hyperparameter grid
hyper_grid <- list(
  max_depth = c(1, 3, 5),
  min_rows = c(1, 5, 10),
  learn_rate = c(0.01, 0.05, 0.1),
  learn_rate_annealing = c(.99, 1),
  sample_rate = c(.5, .75, 1),
  col_sample_rate = c(.8, .9, 1)
)

# perform grid search 
system.time(
grid <- h2o.grid(
  algorithm = "gbm",
  grid_id = "gbm_grid1",
  x = x, 
  y = y, 
  training_frame = train,
  validation_frame = valid,
  hyper_params = hyper_grid,
  ntrees = 5000,
  stopping_rounds = 10,
  stopping_tolerance = 0,
  seed = 123
  )
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824385845688720-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-23">23</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-24">24</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-25">25</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-26">26</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-27">27</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-28">28</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-29">29</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-30">30</div><div class="crayon-num" data-line="crayon-60ed86a824385845688720-31">31</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824385845688720-1"># create training & validation sets</div><div class="crayon-line" id="crayon-60ed86a824385845688720-2">split <div class="crayon-line" id="crayon-60ed86a824385845688720-3">train <div class="crayon-line" id="crayon-60ed86a824385845688720-4">valid <div class="crayon-line" id="crayon-60ed86a824385845688720-5"> </div><div class="crayon-line" id="crayon-60ed86a824385845688720-6"># create hyperparameter grid</div><div class="crayon-line" id="crayon-60ed86a824385845688720-7">hyper_grid <div class="crayon-line" id="crayon-60ed86a824385845688720-8">  max_depth = c(1, 3, 5),</div><div class="crayon-line" id="crayon-60ed86a824385845688720-9">  min_rows = c(1, 5, 10),</div><div class="crayon-line" id="crayon-60ed86a824385845688720-10">  learn_rate = c(0.01, 0.05, 0.1),</div><div class="crayon-line" id="crayon-60ed86a824385845688720-11">  learn_rate_annealing = c(.99, 1),</div><div class="crayon-line" id="crayon-60ed86a824385845688720-12">  sample_rate = c(.5, .75, 1),</div><div class="crayon-line" id="crayon-60ed86a824385845688720-13">  col_sample_rate = c(.8, .9, 1)</div><div class="crayon-line" id="crayon-60ed86a824385845688720-14">)</div><div class="crayon-line" id="crayon-60ed86a824385845688720-15"> </div><div class="crayon-line" id="crayon-60ed86a824385845688720-16"># perform grid search </div><div class="crayon-line" id="crayon-60ed86a824385845688720-17">system.time(</div><div class="crayon-line" id="crayon-60ed86a824385845688720-18">grid <div class="crayon-line" id="crayon-60ed86a824385845688720-19">  algorithm = "gbm",</div><div class="crayon-line" id="crayon-60ed86a824385845688720-20">  grid_id = "gbm_grid1",</div><div class="crayon-line" id="crayon-60ed86a824385845688720-21">  x = x, </div><div class="crayon-line" id="crayon-60ed86a824385845688720-22">  y = y, </div><div class="crayon-line" id="crayon-60ed86a824385845688720-23">  training_frame = train,</div><div class="crayon-line" id="crayon-60ed86a824385845688720-24">  validation_frame = valid,</div><div class="crayon-line" id="crayon-60ed86a824385845688720-25">  hyper_params = hyper_grid,</div><div class="crayon-line" id="crayon-60ed86a824385845688720-26">  ntrees = 5000,</div><div class="crayon-line" id="crayon-60ed86a824385845688720-27">  stopping_rounds = 10,</div><div class="crayon-line" id="crayon-60ed86a824385845688720-28">  stopping_tolerance = 0,</div><div class="crayon-line" id="crayon-60ed86a824385845688720-29">  seed = 123</div><div class="crayon-line" id="crayon-60ed86a824385845688720-30">  )</div><div class="crayon-line" id="crayon-60ed86a824385845688720-31">)</div></div></div></div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>full grid search所花的時間約為31分鐘。</p>

		<div id="crayon-60ed86a824386621341521" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# collect the results and sort by our model performance metric of choice
grid_perf <- h2o.getGrid(
  grid_id = "gbm_grid1", 
  sort_by = "mse", 
  decreasing = FALSE
  )
grid_perf</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824386621341521-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824386621341521-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824386621341521-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824386621341521-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824386621341521-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824386621341521-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824386621341521-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824386621341521-1"># collect the results and sort by our model performance metric of choice</div><div class="crayon-line" id="crayon-60ed86a824386621341521-2">grid_perf <div class="crayon-line" id="crayon-60ed86a824386621341521-3">  grid_id = "gbm_grid1", </div><div class="crayon-line" id="crayon-60ed86a824386621341521-4">  sort_by = "mse", </div><div class="crayon-line" id="crayon-60ed86a824386621341521-5">  decreasing = FALSE</div><div class="crayon-line" id="crayon-60ed86a824386621341521-6">  )</div><div class="crayon-line" id="crayon-60ed86a824386621341521-7">grid_perf</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824388915165372" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## H2O Grid Details
## ================
## 
## Grid ID: gbm_grid1 
## Used hyper parameters: 
##   -  col_sample_rate 
##   -  learn_rate 
##   -  learn_rate_annealing 
##   -  max_depth 
##   -  min_rows 
##   -  sample_rate 
## Number of models: 486 
## Number of failed models: 0 
## 
## Hyper-Parameter Search Summary: ordered by increasing mse
##   col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse
## 1             1.0       0.05                  1.0         5      1.0        0.75 gbm_grid1_model_213   4.64582634567234E8
## 2             0.8       0.01                  1.0         5      1.0         0.5  gbm_grid1_model_46  4.748883474543088E8
## 3             0.8       0.01                  1.0         5      1.0        0.75 gbm_grid1_model_208 4.7571620498865277E8
## 4             0.9       0.01                  1.0         5      1.0        0.75 gbm_grid1_model_209  4.775898758772956E8
## 5             1.0       0.01                  1.0         5      1.0         0.5  gbm_grid1_model_48 4.7783819706988806E8
## 
## ---
##     col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse
## 481             1.0       0.01                 0.99         1      5.0         1.0 gbm_grid1_model_381 2.9511012504833984E9
## 482             1.0       0.01                 0.99         1      1.0         1.0 gbm_grid1_model_327 2.9511012504833984E9
## 483             1.0       0.01                 0.99         1     10.0         1.0 gbm_grid1_model_435 2.9511012504833984E9
## 484             1.0       0.01                 0.99         1      1.0        0.75 gbm_grid1_model_165  2.951772702040925E9
## 485             1.0       0.01                 0.99         1      5.0        0.75 gbm_grid1_model_219  2.951772702040925E9
## 486             1.0       0.01                 0.99         1     10.0        0.75 gbm_grid1_model_273  2.951772702040925E9</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824388915165372-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-17">17</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-18">18</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-19">19</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-20">20</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-21">21</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-22">22</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-23">23</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-24">24</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-25">25</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-26">26</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-27">27</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-28">28</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-29">29</div><div class="crayon-num" data-line="crayon-60ed86a824388915165372-30">30</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824388915165372-1">## H2O Grid Details</div><div class="crayon-line" id="crayon-60ed86a824388915165372-2">## ================</div><div class="crayon-line" id="crayon-60ed86a824388915165372-3">## </div><div class="crayon-line" id="crayon-60ed86a824388915165372-4">## Grid ID: gbm_grid1 </div><div class="crayon-line" id="crayon-60ed86a824388915165372-5">## Used hyper parameters: </div><div class="crayon-line" id="crayon-60ed86a824388915165372-6">##   -  col_sample_rate </div><div class="crayon-line" id="crayon-60ed86a824388915165372-7">##   -  learn_rate </div><div class="crayon-line" id="crayon-60ed86a824388915165372-8">##   -  learn_rate_annealing </div><div class="crayon-line" id="crayon-60ed86a824388915165372-9">##   -  max_depth </div><div class="crayon-line" id="crayon-60ed86a824388915165372-10">##   -  min_rows </div><div class="crayon-line" id="crayon-60ed86a824388915165372-11">##   -  sample_rate </div><div class="crayon-line" id="crayon-60ed86a824388915165372-12">## Number of models: 486 </div><div class="crayon-line" id="crayon-60ed86a824388915165372-13">## Number of failed models: 0 </div><div class="crayon-line" id="crayon-60ed86a824388915165372-14">## </div><div class="crayon-line" id="crayon-60ed86a824388915165372-15">## Hyper-Parameter Search Summary: ordered by increasing mse</div><div class="crayon-line" id="crayon-60ed86a824388915165372-16">##   col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse</div><div class="crayon-line" id="crayon-60ed86a824388915165372-17">## 1             1.0       0.05                  1.0         5      1.0        0.75 gbm_grid1_model_213   4.64582634567234E8</div><div class="crayon-line" id="crayon-60ed86a824388915165372-18">## 2             0.8       0.01                  1.0         5      1.0         0.5  gbm_grid1_model_46  4.748883474543088E8</div><div class="crayon-line" id="crayon-60ed86a824388915165372-19">## 3             0.8       0.01                  1.0         5      1.0        0.75 gbm_grid1_model_208 4.7571620498865277E8</div><div class="crayon-line" id="crayon-60ed86a824388915165372-20">## 4             0.9       0.01                  1.0         5      1.0        0.75 gbm_grid1_model_209  4.775898758772956E8</div><div class="crayon-line" id="crayon-60ed86a824388915165372-21">## 5             1.0       0.01                  1.0         5      1.0         0.5  gbm_grid1_model_48 4.7783819706988806E8</div><div class="crayon-line" id="crayon-60ed86a824388915165372-22">## </div><div class="crayon-line" id="crayon-60ed86a824388915165372-23">## ---</div><div class="crayon-line" id="crayon-60ed86a824388915165372-24">##     col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse</div><div class="crayon-line" id="crayon-60ed86a824388915165372-25">## 481             1.0       0.01                 0.99         1      5.0         1.0 gbm_grid1_model_381 2.9511012504833984E9</div><div class="crayon-line" id="crayon-60ed86a824388915165372-26">## 482             1.0       0.01                 0.99         1      1.0         1.0 gbm_grid1_model_327 2.9511012504833984E9</div><div class="crayon-line" id="crayon-60ed86a824388915165372-27">## 483             1.0       0.01                 0.99         1     10.0         1.0 gbm_grid1_model_435 2.9511012504833984E9</div><div class="crayon-line" id="crayon-60ed86a824388915165372-28">## 484             1.0       0.01                 0.99         1      1.0        0.75 gbm_grid1_model_165  2.951772702040925E9</div><div class="crayon-line" id="crayon-60ed86a824388915165372-29">## 485             1.0       0.01                 0.99         1      5.0        0.75 gbm_grid1_model_219  2.951772702040925E9</div><div class="crayon-line" id="crayon-60ed86a824388915165372-30">## 486             1.0       0.01                 0.99         1     10.0        0.75 gbm_grid1_model_273  2.951772702040925E9</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>由以上資訊可知，模型切割數超過1次的深度、慢的學習步伐和隨機觀測值抽樣是表現的最不錯的組合類型。<br>
我們亦可查看更多有關最佳模型的詳細資訊。最佳模型可達到的驗證誤差RMSE為$21,554。</p>

		<div id="crayon-60ed86a824389759942197" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# Grab the model_id for the top model, chosen by validation error
best_model_id <- grid_perf@model_ids[[1]]
best_model <- h2o.getModel(best_model_id)

# Now let’s get performance metrics on the best model
h2o.performance(model = best_model, valid = TRUE)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824389759942197-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824389759942197-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824389759942197-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824389759942197-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824389759942197-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824389759942197-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824389759942197-1"># Grab the model_id for the top model, chosen by validation error</div><div class="crayon-line" id="crayon-60ed86a824389759942197-2">best_model_id <div class="crayon-line" id="crayon-60ed86a824389759942197-3">best_model <div class="crayon-line" id="crayon-60ed86a824389759942197-4"> </div><div class="crayon-line" id="crayon-60ed86a824389759942197-5"># Now let’s get performance metrics on the best model</div><div class="crayon-line" id="crayon-60ed86a824389759942197-6">h2o.performance(model = best_model, valid = TRUE)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82438a612160468" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## H2ORegressionMetrics: gbm
## ** Reported on validation data. **
## 
## MSE:  464582635
## RMSE:  21554.18
## MAE:  14389.8
## RMSLE:  0.1268479
## Mean Residual Deviance :  464582635
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82438a612160468-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82438a612160468-1">## H2ORegressionMetrics: gbm</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-2">## ** Reported on validation data. **</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-3">## </div><div class="crayon-line" id="crayon-60ed86a82438a612160468-4">## MSE:  464582635</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-5">## RMSE:  21554.18</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-6">## MAE:  14389.8</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-7">## RMSLE:  0.1268479</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-8">## Mean Residual Deviance :  464582635</div><div class="crayon-line" id="crayon-60ed86a82438a612160468-9"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h5>Random discrete grid search</h5>
<p>當想要測試的超參數排列組合非常多時，每增加一個參數都對grid search所需完成的時間有巨大的影響。因此，h2o亦有提供Random discrete的grid search path法，採取隨機挑選超參數組合來執行，直到指定程度的改善幅度被達成或超過一定的執行時間或只執行過一定的模型數量時（或以上條件的組合）則停止。雖然說Random discrete path不一定會找到最適的模型，但在一定程度上可以找到相當不錯的模型。</p>
<p>以下便採用Random Discrete Path法來執行和剛剛一模一樣的hyperparameter grid。不過，在此我們會加入新的search條件：當連續有10個模型效果都無法超越目前最佳的模型獲得0.5%的MSE改善時，則停止。如果持續有在獲得改善，但超過360秒(60分鐘)時，也停止程序。</p>

		<div id="crayon-60ed86a82438c513646449" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# random grid search criteria
search_criteria <- list(
  strategy = "RandomDiscrete",
  stopping_metric = "mse",
  stopping_tolerance = 0.005,
  stopping_rounds = 10,
  max_runtime_secs = 60*60
  )

# perform grid search 
system.time(
grid <- h2o.grid(
  algorithm = "gbm",
  grid_id = "gbm_grid2",
  x = x, 
  y = y, 
  training_frame = train,
  validation_frame = valid,
  hyper_params = hyper_grid,
  search_criteria = search_criteria, # add search criteria
  ntrees = 5000,
  stopping_rounds = 10,
  stopping_tolerance = 0,
  seed = 123
  )
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-21">21</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-22">22</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-23">23</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-24">24</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-25">25</div><div class="crayon-num" data-line="crayon-60ed86a82438c513646449-26">26</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82438c513646449-1"># random grid search criteria</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-2">search_criteria <div class="crayon-line" id="crayon-60ed86a82438c513646449-3">  strategy = "RandomDiscrete",</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-4">  stopping_metric = "mse",</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-5">  stopping_tolerance = 0.005,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-6">  stopping_rounds = 10,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-7">  max_runtime_secs = 60*60</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-8">  )</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-9"> </div><div class="crayon-line" id="crayon-60ed86a82438c513646449-10"># perform grid search </div><div class="crayon-line" id="crayon-60ed86a82438c513646449-11">system.time(</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-12">grid <div class="crayon-line" id="crayon-60ed86a82438c513646449-13">  algorithm = "gbm",</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-14">  grid_id = "gbm_grid2",</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-15">  x = x, </div><div class="crayon-line" id="crayon-60ed86a82438c513646449-16">  y = y, </div><div class="crayon-line" id="crayon-60ed86a82438c513646449-17">  training_frame = train,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-18">  validation_frame = valid,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-19">  hyper_params = hyper_grid,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-20">  search_criteria = search_criteria, # add search criteria</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-21">  ntrees = 5000,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-22">  stopping_rounds = 10,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-23">  stopping_tolerance = 0,</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-24">  seed = 123</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-25">  )</div><div class="crayon-line" id="crayon-60ed86a82438c513646449-26">)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82438d389571595" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##     user   system  elapsed 
##   38.949   11.738 3602.198
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82438d389571595-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82438d389571595-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82438d389571595-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82438d389571595-1">##     user   system  elapsed </div><div class="crayon-line" id="crayon-60ed86a82438d389571595-2">##   38.949   11.738 3602.198</div><div class="crayon-line" id="crayon-60ed86a82438d389571595-3"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>在此例子中，Random Grid Search花了約60分鐘(=3600/60)，評估了154/486個模型(32%)。</p>

		<div id="crayon-60ed86a82438e411994213" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# collect the results and sort by our model performance metric of choice
grid_perf <- h2o.getGrid(
  grid_id = "gbm_grid2", 
  sort_by = "mse", 
  decreasing = FALSE
  )
grid_perf</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82438e411994213-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82438e411994213-1"># collect the results and sort by our model performance metric of choice</div><div class="crayon-line" id="crayon-60ed86a82438e411994213-2">grid_perf <div class="crayon-line" id="crayon-60ed86a82438e411994213-3">  grid_id = "gbm_grid2", </div><div class="crayon-line" id="crayon-60ed86a82438e411994213-4">  sort_by = "mse", </div><div class="crayon-line" id="crayon-60ed86a82438e411994213-5">  decreasing = FALSE</div><div class="crayon-line" id="crayon-60ed86a82438e411994213-6">  )</div><div class="crayon-line" id="crayon-60ed86a82438e411994213-7">grid_perf</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82438f681437152" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## H2O Grid Details
## ================
## 
## Grid ID: gbm_grid2 
## Used hyper parameters: 
##   -  col_sample_rate 
##   -  learn_rate 
##   -  learn_rate_annealing 
##   -  max_depth 
##   -  min_rows 
##   -  sample_rate 
## Number of models: 154 
## Number of failed models: 0 
## 
## Hyper-Parameter Search Summary: ordered by increasing mse
##   col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse
## 1             0.9       0.01                  1.0         3      1.0        0.75  gbm_grid2_model_45  4.748951758832882E8
## 2             1.0       0.01                  1.0         3      1.0         0.5  gbm_grid2_model_80  4.803434026601322E8
## 3             1.0        0.1                  1.0         3      1.0        0.75  gbm_grid2_model_17  4.926287246284121E8
## 4             0.9       0.01                  1.0         3      1.0         0.5 gbm_grid2_model_115 5.0211786533732516E8
## 5             0.9       0.05                  1.0         5      1.0         0.5 gbm_grid2_model_107  5.069315439854374E8
## 
## ---
##     col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse
## 149             1.0       0.01                 0.99         1     10.0        0.75 gbm_grid2_model_146 3.4271307547685847E9
## 150             1.0       0.01                 0.99         1      5.0        0.75  gbm_grid2_model_24 3.4271307547685847E9
## 151             0.8       0.01                 0.99         1     10.0        0.75  gbm_grid2_model_41  3.427939673958527E9
## 152             0.8       0.01                 0.99         1     10.0         1.0  gbm_grid2_model_27 3.4288680514316573E9
## 153             1.0       0.01                 0.99         1      5.0         1.0 gbm_grid2_model_131 3.4293746592550063E9
## 154             1.0       0.01                  1.0         3      1.0        0.75 gbm_grid2_model_154  5.038339642534549E9
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-14">14</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-15">15</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-16">16</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-17">17</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-18">18</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-19">19</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-20">20</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-21">21</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-22">22</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-23">23</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-24">24</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-25">25</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-26">26</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-27">27</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-28">28</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-29">29</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-30">30</div><div class="crayon-num" data-line="crayon-60ed86a82438f681437152-31">31</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82438f681437152-1">## H2O Grid Details</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-2">## ================</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-3">## </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-4">## Grid ID: gbm_grid2 </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-5">## Used hyper parameters: </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-6">##   -  col_sample_rate </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-7">##   -  learn_rate </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-8">##   -  learn_rate_annealing </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-9">##   -  max_depth </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-10">##   -  min_rows </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-11">##   -  sample_rate </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-12">## Number of models: 154 </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-13">## Number of failed models: 0 </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-14">## </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-15">## Hyper-Parameter Search Summary: ordered by increasing mse</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-16">##   col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-17">## 1             0.9       0.01                  1.0         3      1.0        0.75  gbm_grid2_model_45  4.748951758832882E8</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-18">## 2             1.0       0.01                  1.0         3      1.0         0.5  gbm_grid2_model_80  4.803434026601322E8</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-19">## 3             1.0        0.1                  1.0         3      1.0        0.75  gbm_grid2_model_17  4.926287246284121E8</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-20">## 4             0.9       0.01                  1.0         3      1.0         0.5 gbm_grid2_model_115 5.0211786533732516E8</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-21">## 5             0.9       0.05                  1.0         5      1.0         0.5 gbm_grid2_model_107  5.069315439854374E8</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-22">## </div><div class="crayon-line" id="crayon-60ed86a82438f681437152-23">## ---</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-24">##     col_sample_rate learn_rate learn_rate_annealing max_depth min_rows sample_rate           model_ids                  mse</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-25">## 149             1.0       0.01                 0.99         1     10.0        0.75 gbm_grid2_model_146 3.4271307547685847E9</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-26">## 150             1.0       0.01                 0.99         1      5.0        0.75  gbm_grid2_model_24 3.4271307547685847E9</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-27">## 151             0.8       0.01                 0.99         1     10.0        0.75  gbm_grid2_model_41  3.427939673958527E9</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-28">## 152             0.8       0.01                 0.99         1     10.0         1.0  gbm_grid2_model_27 3.4288680514316573E9</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-29">## 153             1.0       0.01                 0.99         1      5.0         1.0 gbm_grid2_model_131 3.4293746592550063E9</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-30">## 154             1.0       0.01                  1.0         3      1.0        0.75 gbm_grid2_model_154  5.038339642534549E9</div><div class="crayon-line" id="crayon-60ed86a82438f681437152-31"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>透過Random Grid Search所得到的最佳模型的交叉驗證RMSE為$21,792。雖然沒有full grid search找到的好($21,554)，但通常兩者所找到模型的效果已是差不多的。</p>

		<div id="crayon-60ed86a824391601207022" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# Grab the model_id for the top model, chosen by validation error
best_model_id <- grid_perf@model_ids[[1]]
best_model <- h2o.getModel(best_model_id)

# Now let’s get performance metrics on the best model
h2o.performance(model = best_model, valid = TRUE)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824391601207022-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824391601207022-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824391601207022-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824391601207022-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824391601207022-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824391601207022-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824391601207022-1"># Grab the model_id for the top model, chosen by validation error</div><div class="crayon-line" id="crayon-60ed86a824391601207022-2">best_model_id <div class="crayon-line" id="crayon-60ed86a824391601207022-3">best_model <div class="crayon-line" id="crayon-60ed86a824391601207022-4"> </div><div class="crayon-line" id="crayon-60ed86a824391601207022-5"># Now let’s get performance metrics on the best model</div><div class="crayon-line" id="crayon-60ed86a824391601207022-6">h2o.performance(model = best_model, valid = TRUE)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824392404412105" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## H2ORegressionMetrics: gbm
## ** Reported on validation data. **
## 
## MSE:  474895176
## RMSE:  21792.09
## MAE:  13738.25
## RMSLE:  0.1245287
## Mean Residual Deviance :  474895176
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824392404412105-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824392404412105-9">9</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824392404412105-1">## H2ORegressionMetrics: gbm</div><div class="crayon-line" id="crayon-60ed86a824392404412105-2">## ** Reported on validation data. **</div><div class="crayon-line" id="crayon-60ed86a824392404412105-3">## </div><div class="crayon-line" id="crayon-60ed86a824392404412105-4">## MSE:  474895176</div><div class="crayon-line" id="crayon-60ed86a824392404412105-5">## RMSE:  21792.09</div><div class="crayon-line" id="crayon-60ed86a824392404412105-6">## MAE:  13738.25</div><div class="crayon-line" id="crayon-60ed86a824392404412105-7">## RMSLE:  0.1245287</div><div class="crayon-line" id="crayon-60ed86a824392404412105-8">## Mean Residual Deviance :  474895176</div><div class="crayon-line" id="crayon-60ed86a824392404412105-9"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>一旦我們找到了最佳模型後，就可以用所有的訓練資料再重新訓練一個模型。我們使用從full grid search所得到的最佳模型的參數組合並使用5-fold cross validation來估計穩健的誤差。</p>

		<div id="crayon-60ed86a824393776247379" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# train final model
h2o.final <- h2o.gbm(
  x = x,
  y = y,
  training_frame = train.h2o,
  nfolds = 5,
  ntrees = 10000,
  learn_rate = 0.01,
  learn_rate_annealing = 1,
  max_depth = 3,
  min_rows = 10,
  sample_rate = 0.75,
  col_sample_rate = 1,
  stopping_rounds = 10,
  stopping_tolerance = 0,
  seed = 123
)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824393776247379-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-2">2</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-3">3</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-4">4</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-5">5</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-6">6</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-7">7</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-8">8</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-9">9</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-10">10</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-11">11</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-12">12</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-13">13</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-14">14</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-15">15</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-16">16</div><div class="crayon-num" data-line="crayon-60ed86a824393776247379-17">17</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824393776247379-1"># train final model</div><div class="crayon-line" id="crayon-60ed86a824393776247379-2">h2o.final <div class="crayon-line" id="crayon-60ed86a824393776247379-3">  x = x,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-4">  y = y,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-5">  training_frame = train.h2o,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-6">  nfolds = 5,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-7">  ntrees = 10000,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-8">  learn_rate = 0.01,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-9">  learn_rate_annealing = 1,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-10">  max_depth = 3,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-11">  min_rows = 10,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-12">  sample_rate = 0.75,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-13">  col_sample_rate = 1,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-14">  stopping_rounds = 10,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-15">  stopping_tolerance = 0,</div><div class="crayon-line" id="crayon-60ed86a824393776247379-16">  seed = 123</div><div class="crayon-line" id="crayon-60ed86a824393776247379-17">)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824394087383672" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# model stopped after xx trees
h2o.final@parameters$ntrees</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824394087383672-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824394087383672-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824394087383672-1"># model stopped after xx trees</div><div class="crayon-line" id="crayon-60ed86a824394087383672-2">h2o.final@parameters$ntrees</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824396997882218" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 8660
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824396997882218-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824396997882218-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824396997882218-1">## [1] 8660</div><div class="crayon-line" id="crayon-60ed86a824396997882218-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824397982710789" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# cross validated RMSE
h2o.rmse(h2o.final, xval = TRUE)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824397982710789-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824397982710789-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824397982710789-1"># cross validated RMSE</div><div class="crayon-line" id="crayon-60ed86a824397982710789-2">h2o.rmse(h2o.final, xval = TRUE)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a824398765888309" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## [1] 23214.71
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824398765888309-1">1</div><div class="crayon-num" data-line="crayon-60ed86a824398765888309-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824398765888309-1">## [1] 23214.71</div><div class="crayon-line" id="crayon-60ed86a824398765888309-2"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h4>Visualization</h4>
<h5>Variable importance</h5>
<p>h2o套件有提供內建的變數重要性繪圖功能。該函式只有一個衡量變數重要性的方法-relative importance，一種衡量每一個變數在每一個模型中，平均能對loss function造成多少影響。能對損失函數帶來最大平均影響者的變數被當作最重要的變數，且其他變數的重要性也是相對於最重要變數所計算而得的數值。另外，vip套件亦可繪製h2o物件的變數重要性圖。</p>

		<div id="crayon-60ed86a824399213805676" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
h2o.varimp_plot(h2o.final, num_of_features = 10)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a824399213805676-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a824399213805676-1">h2o.varimp_plot(h2o.final, num_of_features = 10)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-63-1.png" alt="gradient boosting machines, GBM"></p>
<h5>Partial dependence plots</h5>
<p>我們亦可像之前一樣使用vip套件繪製PDP和ICE圖型來了解不同解釋變數邊際變動下對目標變數造成的影響。我們只需要透過一段專用函數，將投入的資料(newdata)轉換成h2o物件(as.h2o)，並將預測的結果在轉換為data frame型態，在當成pred.fun的參數投入。</p>

		<div id="crayon-60ed86a82439a053589742" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
pfun <- function(object, newdata) {
  as.data.frame(predict(object, newdata = as.h2o(newdata)))[[1L]]
}

pdp <- h2o.final %>%
  partial(
    pred.var = "Gr_Liv_Area", 
    pred.fun = pfun, # 研究一下
    grid.resolution = 20, 
    train = ames_train
    ) %>%
  autoplot(rug = TRUE, train = ames_train, alpha = .1) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("PDP")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-13">13</div><div class="crayon-num" data-line="crayon-60ed86a82439a053589742-14">14</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82439a053589742-1">pfun <div class="crayon-line" id="crayon-60ed86a82439a053589742-2">  as.data.frame(predict(object, newdata = as.h2o(newdata)))[[1L]]</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-3">}</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-4"> </div><div class="crayon-line" id="crayon-60ed86a82439a053589742-5">pdp %</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-6">  partial(</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-7">    pred.var = "Gr_Liv_Area", </div><div class="crayon-line" id="crayon-60ed86a82439a053589742-8">    pred.fun = pfun, # 研究一下</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-9">    grid.resolution = 20, </div><div class="crayon-line" id="crayon-60ed86a82439a053589742-10">    train = ames_train</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-11">    ) %>%</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-12">  autoplot(rug = TRUE, train = ames_train, alpha = .1) +</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-13">  scale_y_continuous(labels = scales::dollar) +</div><div class="crayon-line" id="crayon-60ed86a82439a053589742-14">  ggtitle("PDP")</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82439c735123918" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
ice <- h2o.final %>%
  partial(
    pred.var = "Gr_Liv_Area", 
    pred.fun = pfun,
    grid.resolution = 20, 
    train = ames_train,
    ice = TRUE
    ) %>%
  autoplot(rug = TRUE, train = ames_train, alpha = .1, center = TRUE) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("ICE")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82439c735123918-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82439c735123918-1">ice %</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-2">  partial(</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-3">    pred.var = "Gr_Liv_Area", </div><div class="crayon-line" id="crayon-60ed86a82439c735123918-4">    pred.fun = pfun,</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-5">    grid.resolution = 20, </div><div class="crayon-line" id="crayon-60ed86a82439c735123918-6">    train = ames_train,</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-7">    ice = TRUE</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-8">    ) %>%</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-9">  autoplot(rug = TRUE, train = ames_train, alpha = .1, center = TRUE) +</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-10">  scale_y_continuous(labels = scales::dollar) +</div><div class="crayon-line" id="crayon-60ed86a82439c735123918-11">  ggtitle("ICE")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a82439d551297775" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
gridExtra::grid.arrange(pdp, ice, nrow = 1)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82439d551297775-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82439d551297775-1">gridExtra::grid.arrange(pdp, ice, nrow = 1)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-64-1.png" alt="gradient boosting machines, GBM"></p>
<p>h2o並沒有提供內建的ICE曲線繪圖功能，但是他可以繪製平均邊際效益(標準的PDP圖)外加衡量不確定性的一個標準誤差的PDP圖。</p>

		<div id="crayon-60ed86a82439e890346895" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
h2o.partialPlot(h2o.final, data = train.h2o, cols = "Overall_Qual")</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82439e890346895-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82439e890346895-1">h2o.partialPlot(h2o.final, data = train.h2o, cols = "Overall_Qual")</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-65-1.png" alt="gradient boosting machines, GBM"></p>

		<div id="crayon-60ed86a82439f626030278" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## PartialDependence: Partial Dependence Plot of model GBM_model_R_1554713367949_5 on column 'Overall_Qual'
##      Overall_Qual mean_response stddev_response std_error_mean_response
## 1   Above_Average 173439.744454    59206.888258             1307.342580
## 2         Average 169032.396430    58675.968674             1295.619387
## 3   Below_Average 165991.718878    61198.281190             1351.314368
## 4       Excellent 227862.381764    66306.055141             1464.098718
## 5            Fair 161119.245285    62126.019654             1371.799687
## 6            Good 185468.115459    62195.668588             1373.337600
## 7            Poor 156505.758628    63260.388765             1396.847601
## 8  Very_Excellent 228227.228142    66731.640843             1473.496042
## 9       Very_Good 206801.916781    64639.301392             1427.295261
## 10      Very_Poor 151217.679576    64366.405585             1421.269471
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-1">1</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-2">2</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-3">3</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-4">4</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-5">5</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-6">6</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-7">7</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-8">8</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-9">9</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-10">10</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-11">11</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-12">12</div><div class="crayon-num" data-line="crayon-60ed86a82439f626030278-13">13</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a82439f626030278-1">## PartialDependence: Partial Dependence Plot of model GBM_model_R_1554713367949_5 on column 'Overall_Qual'</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-2">##      Overall_Qual mean_response stddev_response std_error_mean_response</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-3">## 1   Above_Average 173439.744454    59206.888258             1307.342580</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-4">## 2         Average 169032.396430    58675.968674             1295.619387</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-5">## 3   Below_Average 165991.718878    61198.281190             1351.314368</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-6">## 4       Excellent 227862.381764    66306.055141             1464.098718</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-7">## 5            Fair 161119.245285    62126.019654             1371.799687</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-8">## 6            Good 185468.115459    62195.668588             1373.337600</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-9">## 7            Poor 156505.758628    63260.388765             1396.847601</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-10">## 8  Very_Excellent 228227.228142    66731.640843             1473.496042</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-11">## 9       Very_Good 206801.916781    64639.301392             1427.295261</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-12">## 10      Very_Poor 151217.679576    64366.405585             1421.269471</div><div class="crayon-line" id="crayon-60ed86a82439f626030278-13"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p>但不幸的事，h2o的函數會把類別變數的levels以字母排序的方式繪出，而pdp()函式則是以他們所指定的level順序繪出，使推理更加直觀。</p>

		<div id="crayon-60ed86a8243a1937617812" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
pdp <- h2o.final %>%
  partial(
    pred.var = "Overall_Qual", 
    pred.fun = pfun,
    grid.resolution = 20, 
    train = as.data.frame(ames_train)
    ) %>%
  autoplot(rug = TRUE, train = ames_train, alpha = .1) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("PDP")

ice <- h2o.final %>%
  partial(
    pred.var = "Overall_Qual", 
    pred.fun = pfun,
    grid.resolution = 20, 
    train = as.data.frame(ames_train),
    ice = TRUE
    ) %>%
  autoplot(rug = TRUE, train = ames_train, alpha = .1, center = TRUE) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("ICE")

gridExtra::grid.arrange(pdp, ice, nrow = 1)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-2">2</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-3">3</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-4">4</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-5">5</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-6">6</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-7">7</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-8">8</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-9">9</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-10">10</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-11">11</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-12">12</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-13">13</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-14">14</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-15">15</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-16">16</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-17">17</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-18">18</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-19">19</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-20">20</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-21">21</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-22">22</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-23">23</div><div class="crayon-num" data-line="crayon-60ed86a8243a1937617812-24">24</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a1937617812-1">pdp %</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-2">  partial(</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-3">    pred.var = "Overall_Qual", </div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-4">    pred.fun = pfun,</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-5">    grid.resolution = 20, </div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-6">    train = as.data.frame(ames_train)</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-7">    ) %>%</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-8">  autoplot(rug = TRUE, train = ames_train, alpha = .1) +</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-9">  scale_y_continuous(labels = scales::dollar) +</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-10">  ggtitle("PDP")</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-11"> </div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-12">ice %</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-13">  partial(</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-14">    pred.var = "Overall_Qual", </div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-15">    pred.fun = pfun,</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-16">    grid.resolution = 20, </div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-17">    train = as.data.frame(ames_train),</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-18">    ice = TRUE</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-19">    ) %>%</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-20">  autoplot(rug = TRUE, train = ames_train, alpha = .1, center = TRUE) +</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-21">  scale_y_continuous(labels = scales::dollar) +</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-22">  ggtitle("ICE")</div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-23"> </div><div class="crayon-line" id="crayon-60ed86a8243a1937617812-24">gridExtra::grid.arrange(pdp, ice, nrow = 1)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-66-1.png" alt="gradient boosting machines, GBM"></p>
<h5>LIME</h5>
<p>LIME套件亦有提供內建的函數來處理h2o物件。</p>

		<div id="crayon-60ed86a8243a2949568447" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# apply LIME
explainer <- lime(ames_train, h2o.final)
explanation <- explain(local_obs, explainer, n_features = 5)
plot_features(explanation)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a2949568447-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a2949568447-2">2</div><div class="crayon-num" data-line="crayon-60ed86a8243a2949568447-3">3</div><div class="crayon-num" data-line="crayon-60ed86a8243a2949568447-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a2949568447-1"># apply LIME</div><div class="crayon-line" id="crayon-60ed86a8243a2949568447-2">explainer <div class="crayon-line" id="crayon-60ed86a8243a2949568447-3">explanation <div class="crayon-line" id="crayon-60ed86a8243a2949568447-4">plot_features(explanation)</div></div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p><img src="/wp-content/uploads/2019/04/unnamed-chunk-67-1.png" alt="gradient boosting machines, GBM"></p>
<h4>Predicting</h4>
<p>最後，我們可以使用h2o.predict()或predict()兩種方式來進行模型對新資料的預測，並使用h2o.performance()來衡量模型模型套用在測試資料集的成效。驗證結果的RMSE為$20,198，跟gbm和xgboost是類似的($21~22K)。</p>

		<div id="crayon-60ed86a8243a3854887845" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# convert test set to h2o object
test.h2o <- as.h2o(ames_test)

# evaluate performance on new data
h2o.performance(model = h2o.final, newdata = test.h2o)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a3854887845-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a3854887845-2">2</div><div class="crayon-num" data-line="crayon-60ed86a8243a3854887845-3">3</div><div class="crayon-num" data-line="crayon-60ed86a8243a3854887845-4">4</div><div class="crayon-num" data-line="crayon-60ed86a8243a3854887845-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a3854887845-1"># convert test set to h2o object</div><div class="crayon-line" id="crayon-60ed86a8243a3854887845-2">test.h2o <div class="crayon-line" id="crayon-60ed86a8243a3854887845-3"> </div><div class="crayon-line" id="crayon-60ed86a8243a3854887845-4"># evaluate performance on new data</div><div class="crayon-line" id="crayon-60ed86a8243a3854887845-5">h2o.performance(model = h2o.final, newdata = test.h2o)</div></div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a8243a4036407471" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
## H2ORegressionMetrics: gbm
## 
## MSE:  407897003
## RMSE:  20196.46
## MAE:  12679.15
## RMSLE:  0.1008391
## Mean Residual Deviance :  407897003
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-2">2</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-3">3</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-4">4</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-5">5</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-6">6</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-7">7</div><div class="crayon-num" data-line="crayon-60ed86a8243a4036407471-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a4036407471-1">## H2ORegressionMetrics: gbm</div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-2">## </div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-3">## MSE:  407897003</div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-4">## RMSE:  20196.46</div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-5">## MAE:  12679.15</div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-6">## RMSLE:  0.1008391</div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-7">## Mean Residual Deviance :  407897003</div><div class="crayon-line" id="crayon-60ed86a8243a4036407471-8"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a8243a6000389954" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# predict with h2o.predict
h2o.predict(h2o.final, newdata = test.h2o)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a6000389954-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a6000389954-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a6000389954-1"># predict with h2o.predict</div><div class="crayon-line" id="crayon-60ed86a8243a6000389954-2">h2o.predict(h2o.final, newdata = test.h2o)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a8243a7583828057" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    predict
## 1 129814.6
## 2 161987.0
## 3 262990.7
## 4 484455.6
## 5 218094.0
## 6 209430.8
## 
## [879 rows x 1 column]
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-2">2</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-3">3</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-4">4</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-5">5</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-6">6</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-7">7</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-8">8</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-9">9</div><div class="crayon-num" data-line="crayon-60ed86a8243a7583828057-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a7583828057-1">##    predict</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-2">## 1 129814.6</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-3">## 2 161987.0</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-4">## 3 262990.7</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-5">## 4 484455.6</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-6">## 5 218094.0</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-7">## 6 209430.8</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-8">## </div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-9">## [879 rows x 1 column]</div><div class="crayon-line" id="crayon-60ed86a8243a7583828057-10"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a8243a8409079072" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
# predict values with predict
predict(h2o.final, test.h2o)</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a8409079072-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a8409079072-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a8409079072-1"># predict values with predict</div><div class="crayon-line" id="crayon-60ed86a8243a8409079072-2">predict(h2o.final, test.h2o)</div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>

		<div id="crayon-60ed86a8243a9033963660" class="crayon-syntax crayon-theme-hwj-based-on-monokai crayon-font-monospace crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 14px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 20px !important;">
##    predict
## 1 129814.6
## 2 161987.0
## 3 262990.7
## 4 484455.6
## 5 218094.0
## 6 209430.8
## 
## [879 rows x 1 column]
</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 14px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-1">1</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-2">2</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-3">3</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-4">4</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-5">5</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-6">6</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-7">7</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-8">8</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-9">9</div><div class="crayon-num" data-line="crayon-60ed86a8243a9033963660-10">10</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 14px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-60ed86a8243a9033963660-1">##    predict</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-2">## 1 129814.6</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-3">## 2 161987.0</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-4">## 3 262990.7</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-5">## 4 484455.6</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-6">## 5 218094.0</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-7">## 6 209430.8</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-8">## </div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-9">## [879 rows x 1 column]</div><div class="crayon-line" id="crayon-60ed86a8243a9033963660-10"> </div></div></td>
					</tr>
				</table>
			</div>
		</div>

<p></p>
<h3>小結</h3>
<ul>
<li>Gradient Boosting Machines (GBM)是一個強大的集成學習演算法，通常具有一流的預測能力。雖然相較於其他演算法它比較不直覺且需要大型運算，但絕對是機器學習工具箱的必備款！</li>
</ul>
<hr>
<p>參考連結：</p>
<ol>
<li><a href="http://uc-r.github.io/gbm_regression" target="_blank" rel="noopener noreferrer">Gradient Boosting Machines (GBM)</a></li>
<li><a href="https://medium.com/jameslearningnote/%E8%B3%87%E6%96%99%E5%88%86%E6%9E%90-%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92-%E7%AC%AC2-4%E8%AC%9B-%E8%B3%87%E6%96%99%E5%89%8D%E8%99%95%E7%90%86-missing-data-one-hot-encoding-feature-scaling-3b70a7839b4a" target="_blank" rel="noopener noreferrer">類別資料的處理(有序、無序):one-hot encoding</a></li>
<li><a href="https://towardsdatascience.com/choosing-the-right-encoding-method-label-vs-onehot-encoder-a4434493149b" target="_blank" rel="noopener noreferrer">Choosing the right Encoding method-Label vs OneHot Encoder</a></li>
</ol>
<hr>
<p>更多Decision Tree相關的統計學習筆記：</p>
<p><a href="/random-forests-%e9%9a%a8%e6%a9%9f%e6%a3%ae%e6%9e%97/" target="_blank" rel="noopener noreferrer">Random Forests 隨機森林 | randomForest, ranger, h2o | R語言</a></p>
<p><a href="/decision-tree-cart-%e6%b1%ba%e7%ad%96%e6%a8%b9/" target="_blank" rel="noopener noreferrer">Decision Tree 決策樹 | CART, Conditional Inference Tree, RandomForest</a></p>
<p><a href="/regression-tree-%e8%bf%b4%e6%ad%b8%e6%a8%b9-bagging-bootstrap-aggrgation-r%e8%aa%9e%e8%a8%80/" target="_blank" rel="noopener noreferrer">Regression Tree | 迴歸樹, Bagging, Bootstrap Aggregation | R語言</a></p>
<p><a href="/decision-tree-surrogate-in-cart/" target="_blank" rel="noopener noreferrer">Tree Surrogate | Tree Surrogate Variables in CART | R 統計</a></p>
<p>更多Regression相關統計學習筆記：</p>
<p><a href="/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/" target="_blank" rel="noopener noreferrer">Linear Regression | 線性迴歸模型 | using AirQuality Dataset</a></p>
<p><a href="/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/" target="_blank" rel="noopener noreferrer">Logistic Regression 羅吉斯迴歸 | part1 – 資料探勘與處理 | 統計 R語言</a></p>
<p><a href="/logistic-regression-part2-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/" target="_blank" rel="noopener noreferrer">Logistic Regression 羅吉斯迴歸 | part2 – 模型建置、診斷與比較 | R語言</a></p>
<p><a href="/regularized-regression-ridge-lasso-elastic/" target="_blank" rel="noopener noreferrer">Regularized Regression | 正規化迴歸 – Ridge, Lasso, Elastic Net | R語言</a></p>
<p>更多Clustering集群分析統計學習筆記：</p>
<p><a href="/partitional-clustering-kmeans-kmedoid/" target="_blank" rel="noopener noreferrer">Partitional Clustering 切割式分群 | Kmeans, Kmedoid | Clustering 資料分群</a></p>
<p><a href="/hierarchical-clustering-%e9%9a%8e%e5%b1%a4%e5%bc%8f%e5%88%86%e7%be%a4/" target="_blank" rel="noopener noreferrer">Hierarchical Clustering 階層式分群 | Clustering 資料分群 | R 統計</a></p>
<p>其他統計學習筆記：</p>
<p><a href="/principal-components-analysis-pca-%e4%b8%bb%e6%88%90%e4%bb%bd%e5%88%86%e6%9e%90/" target="_blank" rel="noopener noreferrer">Principal Components Analysis (PCA) | 主成份分析 | R 統計</a></p>
			</div>

	<footer class="entry-footer">
			</footer>

	
</article>

				<nav class="navigation post-navigation" role="navigation">
		<h2 class="screen-reader-text">文章導覽列</h2>
		<div class="nav-links clearfix">
			<div class="nav-previous"><span>⟵</span><a href="/random-forests-%e9%9a%a8%e6%a9%9f%e6%a3%ae%e6%9e%97/" rel="prev">Random Forests 隨機森林 | randomForest, ranger, h2o | R語言</a></div><div class="nav-next"><a href="/%e5%b0%8f%e9%bc%8e%e8%86%be/" rel="next">小鼎膾 | 新鮮美味的高品質日式丼飯、海鮮料理 | 台北信義 Bellavita B2</a><span>⟶</span></div>		</div>
	</nav>
	
			
<div id="comments" class="comments-area">

	
			<h4 class="comment-title">
			在《<span>Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言</span>》中有 1 則留言		</h4>

		
		<ol class="comments-list">
					<li id="comment-3290" class="comment even thread-even depth-1">
			<article id="div-comment-3290" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt="" src="http://1.gravatar.com/avatar/18eb8566fc2e74494fe5d95d1bc0be7d?s=60&d=mm&r=g" srcset="http://1.gravatar.com/avatar/18eb8566fc2e74494fe5d95d1bc0be7d?s=120&d=mm&r=g 2x" class="avatar avatar-60 photo" height="60" width="60" loading="lazy">						<b class="fn">Jay</b><span class="says">表示:</span>					</div>

					<div class="comment-metadata">
						<a href="/gradient-boosting-machines-gbm/#comment-3290"><time datetime="2019-12-04T14:57:52+08:00">2019-12-0414:57:52</time></a>					</div>

									</footer>

				<div class="comment-content">
					<p>發現您的網頁資料，實在是太強大了，很難想像一個漂亮的女生，可以同時兼顧美學(美食、旅遊)與程式，而已敘述的很明白。獲益良多，謝謝！</p>
				</div>

				<div class="reply"><a rel="nofollow" class="comment-reply-link" href="#comment-3290" data-commentid="3290" data-postid="2875" data-belowelement="div-comment-3290" data-respondelement="respond" data-replyto="回覆給「Jay」" aria-label="回覆給「Jay」">回覆</a></div>			</article>
		</li>
		</ol>

		
	
	
		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">發佈留言 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/gradient-boosting-machines-gbm/#respond" style="display:none;">取消回覆</a></small></h3><form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-notes"><span id="email-notes">發佈留言必須填寫的電子郵件地址不會公開。</span> 必填欄位標示為 <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">留言</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" required="required"></textarea></p><p class="comment-form-author"><label for="author">顯示名稱 <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required="required"></p>
<p class="comment-form-email"><label for="email">電子郵件地址 <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required="required"></p>
<p class="comment-form-url"><label for="url">個人網站網址</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200"></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="發佈留言"> <input type="hidden" name="comment_post_ID" value="2875" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
</p><div class="wantispam-required-fields"><input type="hidden" name="wantispam_t" class="wantispam-control wantispam-control-t" value="1626179241"><div class="wantispam-group wantispam-group-q" style="clear: both;">
					<label>Current ye@r <span class="required">*</span></label>
					<input type="hidden" name="wantispam_a" class="wantispam-control wantispam-control-a" value="2021">
					<input type="text" name="wantispam_q" class="wantispam-control wantispam-control-q" value="7.2.0" autocomplete="off">
				  </div>
<div class="wantispam-group wantispam-group-e" style="display: none;">
					<label>Leave this field empty</label>
					<input type="text" name="wantispam_e_email_url_website" class="wantispam-control wantispam-control-e" value="" autocomplete="off">
				  </div>
</div></form>	</div>
	
</div>

		
		</main>
	</div>

	

<div id="secondary" class="widget-area col-md-3" role="complementary">
	<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="/">
				<label>
					<span class="screen-reader-text">搜尋關鍵字:</span>
					<input type="search" class="search-field" placeholder="搜尋..." value="" name="s">
				</label>
				<input type="submit" class="search-submit" value="搜尋">
			</form></aside>
		<aside id="recent-posts-2" class="widget widget_recent_entries">
		<h3 class="widget-title">近期文章</h3>
		<ul>
											<li>
					<a href="/jbs-diner/">JB’s Diner | 陽光、綠意、自然度假風美式早午餐 | 台北 天母</a>
									</li>
											<li>
					<a href="/%e9%82%80%e6%9c%88%e5%85%92/">邀月兒 | 適合放鬆小酌的迷人高級餐酒館 | 台北 民生社區 富錦街</a>
									</li>
											<li>
					<a href="/eslite-cafe-%e4%bf%a1%e7%be%a9%e8%aa%a0%e5%93%81%e5%92%96%e5%95%a1/">信義誠品咖啡 Eslite Café | 美美的 優雅的 文青咖啡廳 | 台北 信義區</a>
									</li>
											<li>
					<a href="/%e5%b0%8f%e9%bc%8e%e8%86%be/">小鼎膾 | 新鮮美味的高品質日式丼飯、海鮮料理 | 台北信義 Bellavita B2</a>
									</li>
											<li>
					<a href="/gradient-boosting-machines-gbm/" aria-current="page">Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言</a>
									</li>
					</ul>

		</aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">彙整</h3>
			<ul>
					<li><a href="/2019/08/">2019 年 8 月</a></li>
	<li><a href="/2019/04/">2019 年 4 月</a></li>
	<li><a href="/2019/03/">2019 年 3 月</a></li>
	<li><a href="/2019/02/">2019 年 2 月</a></li>
	<li><a href="/2019/01/">2019 年 1 月</a></li>
	<li><a href="/2018/12/">2018 年 12 月</a></li>
	<li><a href="/2018/10/">2018 年 10 月</a></li>
	<li><a href="/2018/09/">2018 年 9 月</a></li>
	<li><a href="/2018/08/">2018 年 8 月</a></li>
	<li><a href="/2018/07/">2018 年 7 月</a></li>
	<li><a href="/2018/05/">2018 年 5 月</a></li>
			</ul>

			</aside></div>
			</div>
		</div>
	</div>

	
	
    <a class="go-top"><i class="fa fa-angle-up"></i></a>
		
	<footer id="colophon" class="site-footer" role="contentinfo">
		<div class="site-info container">
			<a href="https://tw.wordpress.org/">本站採用 WordPress 建置</a>
			<span class="sep"> | </span>
			佈景主題採用由 aThemes 所設計的 <a href="https://athemes.com/theme/sydney" rel="designer">Sydney</a>。		</div>
	</footer>

	
</div>


<script type="text/javascript">
var sbiajaxurl = "/wp-admin/admin-ajax.php";
</script>
<script type="text/javascript" src="/wp-content/plugins/anti-spam/assets/js/anti-spam.js" id="anti-spam-script-js"></script>
<script type="text/javascript" src="/wp-content/themes/hwj-based-on-sydney/js/scripts.js" id="sydney-scripts-js"></script>
<script type="text/javascript" src="/wp-content/themes/hwj-based-on-sydney/js/main.min.js" id="sydney-main-js"></script>
<script type="text/javascript" src="/wp-content/themes/hwj-based-on-sydney/js/skip-link-focus-fix.js" id="sydney-skip-link-focus-fix-js"></script>


</body></html>
