<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>eda &#8211; 果醬珍珍•JamJam</title>
	<atom:link href="/tag/eda/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>健忘女孩Jam的學習筆記和生活雜記</description>
	<lastBuildDate>Fri, 03 Jul 2020 02:33:23 +0000</lastBuildDate>
	<language>zh-TW</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.7.2</generator>
	<item>
		<title>Logistic Regression 羅吉斯迴歸 &#124; part1 &#8211; 資料探勘與處理 &#124; 統計 R語言</title>
		<link>/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/</link>
					<comments>/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/#comments</comments>
		
		<dc:creator><![CDATA[jamleecute]]></dc:creator>
		<pubDate>Tue, 28 Aug 2018 06:24:19 +0000</pubDate>
				<category><![CDATA[ 程式與統計]]></category>
		<category><![CDATA[統計模型]]></category>
		<category><![CDATA[data pre processing]]></category>
		<category><![CDATA[eda]]></category>
		<category><![CDATA[exploratory data analysis]]></category>
		<category><![CDATA[glm]]></category>
		<category><![CDATA[information value]]></category>
		<category><![CDATA[IV]]></category>
		<category><![CDATA[logistic regression]]></category>
		<category><![CDATA[羅吉斯回歸]]></category>
		<category><![CDATA[資料探索]]></category>
		<category><![CDATA[資料預處理]]></category>
		<guid isPermaLink="false">/?p=846</guid>

					<description><![CDATA[<p>Logistic Regression, 羅吉斯回歸模型，適用於預測二元類別目標變數的發生機率(p)，和線性回歸模型類似，與線性回歸主要不同之處在於：(1) 目 [&#8230;]</p>
<p>這篇文章 <a rel="nofollow" href="/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/">Logistic Regression 羅吉斯迴歸 | part1 &#8211; 資料探勘與處理 | 統計 R語言</a> 最早出現於 <a rel="nofollow" href="/">果醬珍珍•JamJam</a>。</p>
]]></description>
										<content:encoded><![CDATA[<p class=""></p>
<p>Logistic Regression, 羅吉斯回歸模型，適用於<span style="color: #9f6ad4;">預測<span style="text-decoration: underline;">二元類別目標變數</span>的發生機率(p)</span>，和線性回歸模型類似，與線性回歸主要不同之處在於：(1) 目標變數是目標事件發生機率P經過log函數轉換成log odds值才進行線性預測，且(2)羅吉斯回歸的各項參數是透過最大概似法(MLE)進行估計的。</p>
<h3>Logistic Regression 羅吉斯回歸模型簡介</h3>
<p>線性迴歸模型是用來預測連續型變數，而羅吉斯回歸則是用來預測類別型變數。<br />
羅吉斯回歸和線性回歸模型類似，只不過<span style="color: #9d6ad4;">預測類別目標變數是經過log函數轉換才投入線性模型中的</span>。羅吉斯回歸方程式<span style="color: #9d6ad4;">將類別目標變數轉換為事件的log odds值，也就是\(\log\lgroup\frac{P_{i}}{1-P_{i}}\rgroup\)</span>，來預測Z與預測變數間(X1~Xn)的線性關係。</p>
<p><strong>羅吉斯回歸方程式：</strong></p>
<p><span id="MathJax-Span-15" class="mrow"><span id="MathJax-Span-43" class="mo">$$Z_{i}=\log\lgroup\frac{P_{i}}{1-P_{i}}\rgroup=\beta_{0}+\beta_{1}*x_{1}+&#8230;+\beta_{n}*x_{n}$$</span></span></p>
<p>其中：</p>
<p>(1) \(P_{i}\)為事件發生的機率值。</p>
<p>(2) \(\lgroup\frac{P_{i}}{1-P_{i}}\rgroup\)為勝算比(Odds Ratio)。</p>
<p>在R語言中，上述模型可透過<span style="color: #9d6ad4;">glm()函式</span>，將參數設定為<span style="color: #0000ff;"><span style="color: #9d6ad4;">family=&#8221;binomial&#8221;</span><span style="color: #000000;">來執行</span></span>。</p>
<p>但因為我們真正關心的是模型預測的事件發生機率值Pi。所以，預測結果則透過plogis()函數將事件的log odds轉換為Pi。轉換公式如下：</p>
<p>$$P_{i}=1-\lgroup\frac{1}{1+e_{i}^z}\rgroup$$</p>
<p>羅吉斯回歸透過log函數轉換，產生了一個臨界遞增的S型函數，<span style="color: #9d6ad4;">適用於分析機率模型</span>。<br />
而不同於線性迴歸，羅吉斯回歸分析的各項參數係數，是透過最大概似法(MLE)進行估計。</p>
<h3>分析資料與問題</h3>
<p>Problem: 預測薪資大於50K(ABOVE50K)的影響特徵因素有哪些？</p>
<p>Data: <a href="https://archive.ics.uci.edu/ml/datasets/adult">adult dataset</a> (snapshot)</p>
<p>目標變數(1)：ABOVE50K</p>
<p>預測變數(13)：AGE, WORKCLASS, EDUCATION, EDUCATIONNUM, MARITALSTATUS, OCCUPATION, RELATIONSHIP, RACE, SEX, CAPITALGAIN, CAPITALLOSS, HOURSPERWEEK, NATIVECOUNTRY</p>
<h3>分析步驟</h3>
<p>(part 1 篇會說明步驟1~5的部分)</p>
<ol>
<li><span style="color: #9d6ad4;">資料載入與檢視</span></li>
<li><span style="color: #9d6ad4;">資料探勘</span></li>
<li><span style="color: #9d6ad4;">資料前處理</span></li>
<li><span style="color: #9d6ad4;">產生訓練資料集與測試資料集</span></li>
<li><span style="color: #9d6ad4;">計算特徵變數IV值(Information Value)，篩選變數</span></li>
<li>訓練模型與預測</li>
<li>模型診斷與調整</li>
<li> 模型比較(v.s. Machine Learning Methods)</li>
</ol>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<h3>1. 資料載入與檢視</h3>
<p></p><pre class="crayon-plain-tag"># download from google drive's shareable link:
# https://drive.google.com/file/d/1L71tumU33xmVa2EtxjTyrZ2F6CaXn9iR/view?usp=sharing
id &lt;- "1L71tumU33xmVa2EtxjTyrZ2F6CaXn9iR" # google file ID
inputData &lt;- read.csv(sprintf("https://docs.google.com/uc?id=%s&amp;export=download", id))
# 摘要資料集
summary(inputData)

# AGE                    WORKCLASS         FNLWGT                EDUCATION    
# Min.   :17.00    Private         :22696   Min.   :  12285    HS-grad     :10501  
# 1st Qu.:28.00    Self-emp-not-inc: 2541   1st Qu.: 117827    Some-college: 7291  
# Median :37.00    Local-gov       : 2093   Median : 178356    Bachelors   : 5355  
# Mean   :38.58    ?               : 1836   Mean   : 189778    Masters     : 1723  
# 3rd Qu.:48.00    State-gov       : 1298   3rd Qu.: 237051    Assoc-voc   : 1382  
# Max.   :90.00    Self-emp-inc    : 1116   Max.   :1484705    11th        : 1175  
#                 (Other)          :  981                     (Other)      : 5134  
# EDUCATIONNUM                  MARITALSTATUS              OCCUPATION  
# Min.   : 1.00    Divorced             : 4443    Prof-specialty :4140  
# 1st Qu.: 9.00    Married-AF-spouse    :   23    Craft-repair   :4099  
# Median :10.00    Married-civ-spouse   :14976    Exec-managerial:4066  
# Mean   :10.08    Married-spouse-absent:  418    Adm-clerical   :3770  
# 3rd Qu.:12.00    Never-married        :10683    Sales          :3650  
# Max.   :16.00    Separated            : 1025    Other-service  :3295  
#                  Widowed              :  993   (Other)         :9541  
# RELATIONSHIP                    RACE            SEX       
# Husband       :13193    Amer-Indian-Eskimo:  311    Female:10771  
# Not-in-family : 8305    Asian-Pac-Islander: 1039    Male  :21790  
# Other-relative:  981    Black             : 3124                  
# Own-child     : 5068    Other             :  271                  
# Unmarried     : 3446    White             :27816                  
# Wife          : 1568                                              
# 
# CAPITALGAIN     CAPITALLOSS      HOURSPERWEEK          NATIVECOUNTRY  
# Min.   :    0   Min.   :   0.0   Min.   : 1.00    United-States:29170  
# 1st Qu.:    0   1st Qu.:   0.0   1st Qu.:40.00    Mexico       :  643  
# Median :    0   Median :   0.0   Median :40.00    ?            :  583  
# Mean   : 1078   Mean   :  87.3   Mean   :40.44    Philippines  :  198  
# 3rd Qu.:    0   3rd Qu.:   0.0   3rd Qu.:45.00    Germany      :  137  
# Max.   :99999   Max.   :4356.0   Max.   :99.00    Canada       :  121  
#                                                  (Other)       : 1709  
# ABOVE50K     
# Min.   :0.0000  
# 1st Qu.:0.0000  
# Median :0.0000  
# Mean   :0.2408  
# 3rd Qu.:0.0000  
# Max.   :1.0000</pre><p>由於我們的目標變數目前是數值0,1，為了後續分析，我們決定(1)ABOVE50K轉變成(&lt;=50K, &gt;50K)的factor變數，並(2)另外新增ABOVE50K_y(0,1)的factor變數。</p><pre class="crayon-plain-tag"># 將ABOVE50K原始0,1轉換成&lt;=50K, &gt; 50K的factor資料類型
inputData$ABOVE50K &lt;- factor(x = inputData$ABOVE50K, levels = c(0,1), labels = c('&lt;=50K', '&gt;50K'))
# 產生新factor變數ABOVE50K_y：
library(dplyr)
inputData$ABOVE50K_y &lt;- as.factor(case_when(inputData$ABOVE50K == "&lt;=50K" ~ 0,
                                             inputData$ABOVE50K == "&gt;50K" ~ 1))
# 確認轉換後的變數沒有問題
summary(inputData$ABOVE50K)
# &lt;=50K  &gt;50K 
# 24720  7841 
summary(inputData$ABOVE50K_y)
# 0     1 
# 24720  7841</pre><p>最後再確認一次資料集所有變數型態。</p><pre class="crayon-plain-tag"># 查看資料結構:資料變數、型態
str(inputData)

# 'data.frame':	32561 obs. of  16 variables:
# $ AGE          : int  39 50 38 53 28 37 49 52 31 42 ...
# $ WORKCLASS    : Factor w/ 9 levels " ?"," Federal-gov",..: 8 7 5 5 5 5 5 7 5 5 ...
# $ FNLWGT       : int  77516 83311 215646 234721 338409 284582 160187 209642 45781 159449 ...
# $ EDUCATION    : Factor w/ 16 levels " 10th"," 11th",..: 10 10 12 2 10 13 7 12 13 10 ...
# $ EDUCATIONNUM : int  13 13 9 7 13 14 5 9 14 13 ...
# $ MARITALSTATUS: Factor w/ 7 levels " Divorced"," Married-AF-spouse",..: 5 3 1 3 3 3 4 3 5 3 ...
# $ OCCUPATION   : Factor w/ 15 levels " ?"," Adm-clerical",..: 2 5 7 7 11 5 9 5 11 5 ...
# $ RELATIONSHIP : Factor w/ 6 levels " Husband"," Not-in-family",..: 2 1 2 1 6 6 2 1 2 1 ...
# $ RACE         : Factor w/ 5 levels " Amer-Indian-Eskimo",..: 5 5 5 3 3 5 3 5 5 5 ...
# $ SEX          : Factor w/ 2 levels " Female"," Male": 2 2 2 2 1 1 1 2 1 2 ...
# $ CAPITALGAIN  : int  2174 0 0 0 0 0 0 0 14084 5178 ...
# $ CAPITALLOSS  : int  0 0 0 0 0 0 0 0 0 0 ...
# $ HOURSPERWEEK : int  40 13 40 40 40 40 16 45 50 40 ...
# $ NATIVECOUNTRY: Factor w/ 42 levels " ?"," Cambodia",..: 40 40 40 40 6 40 24 40 40 40 ...
# $ ABOVE50K     : Factor w/ 2 levels "&lt;=50K","&gt;50K": 1 1 1 1 1 1 1 2 2 2 ...
# $ ABOVE50K_y   : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 2 2 2 ...</pre><p>幾個光看變數名稱不足以了解的變數說明如下：<br />
(1) fnlwgt : 代表final weight，即該代表個體在母體所佔比例<br />
(2) educatoin_num：代表受教育的時間(年份)<br />
<span style="color: #9d6ad4;">為了簡化分析，我們將忽略fnlwgt每個代表個體在母體中所佔比重。</span></p>
<h3>2. 資料探勘(Exploratory Data Analysis)</h3>
<p></p><pre class="crayon-plain-tag"># 載入繪圖所需套件
library(ggplot2)
library(scales) # needed for labels=percent</pre><p>2-1. Age</p>
<p>查看年齡變數(AGE)各區間次數分佈與每區間薪資水準組成比例。</p><pre class="crayon-plain-tag"># 2-1. age
summary(inputData$AGE)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 17.00   28.00   37.00   38.58   48.00   90.00 

gg &lt;- 
  ggplot(data = inputData, aes(x = as.numeric(AGE))) +
  geom_histogram(color = "black",binwidth = 1, aes(group=ABOVE50K, fill = ABOVE50K)) +
  geom_vline(xintercept = mean(inputData$AGE[inputData$ABOVE50K == 1]), col = "blue", lty = 5, lwd = 0.8) +
  geom_vline(xintercept = mean(inputData$AGE[inputData$ABOVE50K == 0]), col = "black", lty = 5, lwd = 0.8)
gg</pre><p>可以發現薪資水平高於50K的年齡偏高，平均數約落在40-50歲，而薪資水平小於等於50K的族群偏年輕。</p>
<p><img loading="lazy" class="alignnone size-large wp-image-890" src="/wp-content/uploads/2018/08/pic01-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic01-1024x659.png 1024w, /wp-content/uploads/2018/08/pic01-300x193.png 300w, /wp-content/uploads/2018/08/pic01-768x494.png 768w, /wp-content/uploads/2018/08/pic01-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>2-2. Workclass</p><pre class="crayon-plain-tag">summary(inputData$WORKCLASS)
# ?       Federal-gov         Local-gov      Never-worked 
# 1836               960              2093                 7 
# Private      Self-emp-inc  Self-emp-not-inc         State-gov 
# 22696              1116              2541              1298 
# Without-pay 
# 14</pre><p>查看workclass各類別次數分佈。</p><pre class="crayon-plain-tag">inputData$WORKCLASS &lt;- factor(x = inputData$WORKCLASS,levels = names(sort(table(inputData$WORKCLASS),decreasing = TRUE)))
ggplot(data = inputData, aes(x = WORKCLASS, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired")</pre><p><img loading="lazy" class="alignnone size-large wp-image-891" src="/wp-content/uploads/2018/08/pic02-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic02-1024x659.png 1024w, /wp-content/uploads/2018/08/pic02-300x193.png 300w, /wp-content/uploads/2018/08/pic02-768x494.png 768w, /wp-content/uploads/2018/08/pic02-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>查看workclass各類別薪資水準組成比例。</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(WORKCLASS = inputData$WORKCLASS,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(WORKCLASS,ABOVE50K) %&gt;% 
  summarise(n = n()) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n)))

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = WORKCLASS, x = as.numeric(ABOVE50K),fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired")</pre><p><img loading="lazy" class="alignnone size-large wp-image-957" src="/wp-content/uploads/2018/08/pic03-1024x928.png" alt="logistic regression" width="960" height="870" srcset="/wp-content/uploads/2018/08/pic03-1024x928.png 1024w, /wp-content/uploads/2018/08/pic03-300x272.png 300w, /wp-content/uploads/2018/08/pic03-768x696.png 768w, /wp-content/uploads/2018/08/pic03-1140x1034.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<p>2-3. Education</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$EDUCATION)
# 10th          11th          12th       1st-4th       5th-6th       7th-8th 
# 933          1175           433           168           333           646 
# 9th    Assoc-acdm     Assoc-voc     Bachelors     Doctorate       HS-grad 
# 514          1067          1382          5355           413         10501 
# Masters     Preschool   Prof-school  Some-college 
# 1723            51           576          7291</pre><p>次數分配圖</p><pre class="crayon-plain-tag">inputData$EDUCATION &lt;- factor(x = inputData$EDUCATION,levels = names(sort(table(inputData$EDUCATION),decreasing = TRUE)))
ggplot(data = inputData, aes(x = EDUCATION, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-893" src="/wp-content/uploads/2018/08/pic04-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic04-1024x659.png 1024w, /wp-content/uploads/2018/08/pic04-300x193.png 300w, /wp-content/uploads/2018/08/pic04-768x494.png 768w, /wp-content/uploads/2018/08/pic04-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(EDUCATION = inputData$EDUCATION,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(EDUCATION) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = EDUCATION, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-960" src="/wp-content/uploads/2018/08/pic05-1024x928.png" alt="logistic regression" width="960" height="870" srcset="/wp-content/uploads/2018/08/pic05-1024x928.png 1024w, /wp-content/uploads/2018/08/pic05-300x272.png 300w, /wp-content/uploads/2018/08/pic05-768x696.png 768w, /wp-content/uploads/2018/08/pic05-1140x1034.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>2-4. Educationnum (教育年份)</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$AGE)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 17.00   28.00   37.00   38.58   48.00   90.00</pre><p>次數分配圖</p><pre class="crayon-plain-tag">inputData$AGE_cut &lt;- inputData$AGE 
inputData$AGE_cut &lt;- cut(inputData$AGE_cut, breaks = seq(15,90,5),include.lowest = TRUE)
ggplot(data = inputData, aes(x = AGE_cut, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "AGE")</pre><p><img loading="lazy" class="alignnone size-large wp-image-895" src="/wp-content/uploads/2018/08/pic06-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic06-1024x659.png 1024w, /wp-content/uploads/2018/08/pic06-300x193.png 300w, /wp-content/uploads/2018/08/pic06-768x494.png 768w, /wp-content/uploads/2018/08/pic06-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(AGE_cut = inputData$AGE_cut,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(AGE_cut) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = AGE_cut, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "AGE")</pre><p><img loading="lazy" class="alignnone size-large wp-image-896" src="/wp-content/uploads/2018/08/pic07-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic07-1024x659.png 1024w, /wp-content/uploads/2018/08/pic07-300x193.png 300w, /wp-content/uploads/2018/08/pic07-768x494.png 768w, /wp-content/uploads/2018/08/pic07-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>2-5. MaritalStatus</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$MARITALSTATUS)
# Divorced      Married-AF-spouse     Married-civ-spouse 
# 4443                     23                  14976 
# Married-spouse-absent          Never-married              Separated 
# 418                  10683                   1025 
# Widowed 
# 993</pre><p>次數分配圖</p><pre class="crayon-plain-tag">inputData$MARITALSTATUS &lt;- factor(x = inputData$MARITALSTATUS,levels = names(sort(table(inputData$MARITALSTATUS),decreasing = TRUE)))
ggplot(data = inputData, aes(x = MARITALSTATUS, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-897" src="/wp-content/uploads/2018/08/pic08-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic08-1024x659.png 1024w, /wp-content/uploads/2018/08/pic08-300x193.png 300w, /wp-content/uploads/2018/08/pic08-768x494.png 768w, /wp-content/uploads/2018/08/pic08-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(MARITALSTATUS = inputData$MARITALSTATUS,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(MARITALSTATUS) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = MARITALSTATUS, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "MARITALSTATUS", y = "percentage") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-898" src="/wp-content/uploads/2018/08/pic09-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic09-1024x659.png 1024w, /wp-content/uploads/2018/08/pic09-300x193.png 300w, /wp-content/uploads/2018/08/pic09-768x494.png 768w, /wp-content/uploads/2018/08/pic09-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>如果想要同一張圖y軸可以看到frequency，stacked bar可以看到目標類別水平的比例分佈，可以使用下面方法繪製。</p><pre class="crayon-plain-tag"># 如果想要在同一張圖同時看到frequencies &amp; proportion:
# 先新增一欄label位置的欄位
# (依照ABOVE50K的類別水準順序，計算累積數值，並將數值置中於各類別累積高度)
df3.summary &lt;-
  df2.summary %&gt;%
  group_by(MARITALSTATUS) %&gt;%
  #因為繪圖資訊是先畫&gt;50K，再畫&lt;=50K，故要調整累積數值計算的順序
  do( data.frame(with(data=., .[order(desc(ABOVE50K)),] )) ) %&gt;% 
  ungroup() %&gt;% 
  group_by(MARITALSTATUS) %&gt;%
  mutate(pos = (cumsum(n) - (0.5 * n))) %&gt;%
  as.data.frame() %&gt;% 
  ungroup()

ggplot(data = df3.summary,mapping = aes(x = MARITALSTATUS, y = n, fill = ABOVE50K)) +
  geom_bar(stat = "identity") + 
  geom_text(mapping = aes(y = pos, label = ratio), size = 3) +
  scale_fill_brewer(palette="Paired") +
  labs(title = "MARITALSTATUS VS ABOVE50K",
       x = "MARITALSTATUS", y = "Frequencies") + # Add Title and Labels
  theme(plot.title = element_text(hjust = 0.5)) # Change the appearance of the main title</pre><p><img loading="lazy" class="alignnone size-large wp-image-958" src="/wp-content/uploads/2018/08/pic10-1024x928.png" alt="logistic regression" width="960" height="870" srcset="/wp-content/uploads/2018/08/pic10-1024x928.png 1024w, /wp-content/uploads/2018/08/pic10-300x272.png 300w, /wp-content/uploads/2018/08/pic10-768x696.png 768w, /wp-content/uploads/2018/08/pic10-1140x1034.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>2-6. Occupation職業</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$OCCUPATION)
# ?       Adm-clerical       Armed-Forces       Craft-repair 
# 1843               3770                  9               4099 
# Exec-managerial    Farming-fishing  Handlers-cleaners  Machine-op-inspct 
# 4066                994               1370               2002 
# Other-service    Priv-house-serv     Prof-specialty    Protective-serv 
# 3295                149               4140                649 
# Sales       Tech-support   Transport-moving 
# 3650                928               1597</pre><p>可以發現類別水準值滿複雜的。</p>
<p>次數分配圖</p><pre class="crayon-plain-tag">inputData$OCCUPATION &lt;- factor(x = inputData$OCCUPATION,levels = names(sort(table(inputData$OCCUPATION),decreasing = TRUE)))
ggplot(data = inputData, aes(x = OCCUPATION, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-900" src="/wp-content/uploads/2018/08/pic11-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic11-1024x659.png 1024w, /wp-content/uploads/2018/08/pic11-300x193.png 300w, /wp-content/uploads/2018/08/pic11-768x494.png 768w, /wp-content/uploads/2018/08/pic11-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(OCCUPATION = inputData$OCCUPATION,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(OCCUPATION) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  as.data.frame() %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = OCCUPATION, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "OCCUPATION", y = "percentage") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-901" src="/wp-content/uploads/2018/08/pic12-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic12-1024x659.png 1024w, /wp-content/uploads/2018/08/pic12-300x193.png 300w, /wp-content/uploads/2018/08/pic12-768x494.png 768w, /wp-content/uploads/2018/08/pic12-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>如果想要同一張圖y軸可以看到frequency，stacked bar可以看到目標類別水平的比例分佈，可以使用下面方法繪製。</p><pre class="crayon-plain-tag">df3.summary &lt;-
  df2.summary %&gt;%
  group_by(OCCUPATION) %&gt;%
  #因為繪圖資訊是先畫&gt;50K，再畫&lt;=50K，故要調整累積數值計算的順序
  do( data.frame(with(data=., .[order(desc(ABOVE50K)),] )) ) %&gt;% 
  ungroup() %&gt;% 
  group_by(OCCUPATION) %&gt;%
  mutate(pos = (cumsum(n) - (0.5 * n))) %&gt;%
  as.data.frame() %&gt;% 
  ungroup()

ggplot(data = df3.summary,mapping = aes(x = OCCUPATION, y = n, fill = ABOVE50K)) +
  geom_bar(stat = "identity") + 
  geom_text(mapping = aes(y = pos, label = ratio), size = 3) +
  scale_fill_brewer(palette="Paired") +
  labs(title = "OCCUPATION VS ABOVE50K",
       x = "OCCUPATION", y = "Frequencies") + # Add Title and Labels
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-902" src="/wp-content/uploads/2018/08/pic13-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic13-1024x659.png 1024w, /wp-content/uploads/2018/08/pic13-300x193.png 300w, /wp-content/uploads/2018/08/pic13-768x494.png 768w, /wp-content/uploads/2018/08/pic13-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>2-7. Relationship</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$RELATIONSHIP)
# Husband   Not-in-family  Other-relative       Own-child       Unmarried 
# 13193            8305             981            5068            3446 
# Wife 
# 1568</pre><p>次數分配圖</p><pre class="crayon-plain-tag">inputData$RELATIONSHIP &lt;- factor(x = inputData$RELATIONSHIP,levels = names(sort(table(inputData$RELATIONSHIP),decreasing = TRUE)))
ggplot(data = inputData, aes(x = RELATIONSHIP, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired")</pre><p><img loading="lazy" class="alignnone size-large wp-image-903" src="/wp-content/uploads/2018/08/pic14-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic14-1024x659.png 1024w, /wp-content/uploads/2018/08/pic14-300x193.png 300w, /wp-content/uploads/2018/08/pic14-768x494.png 768w, /wp-content/uploads/2018/08/pic14-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(RELATIONSHIP = inputData$RELATIONSHIP,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(RELATIONSHIP) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  as.data.frame() %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = RELATIONSHIP, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "RELATIONSHIP", y = "percentage") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-904" src="/wp-content/uploads/2018/08/pic15-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic15-1024x659.png 1024w, /wp-content/uploads/2018/08/pic15-300x193.png 300w, /wp-content/uploads/2018/08/pic15-768x494.png 768w, /wp-content/uploads/2018/08/pic15-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>繪製同時一張圖呈現frequency與stacked bar目標類別水平的比例分佈圖。</p><pre class="crayon-plain-tag">df3.summary &lt;-
  df2.summary %&gt;%
  group_by(RELATIONSHIP) %&gt;%
  #因為繪圖資訊是先畫&gt;50K，再畫&lt;=50K，故要調整累積數值計算的順序
  do( data.frame(with(data=., .[order(desc(ABOVE50K)),] )) ) %&gt;% 
  ungroup() %&gt;% 
  group_by(RELATIONSHIP) %&gt;%
  mutate(pos = (cumsum(n) - (0.5 * n))) %&gt;%
  as.data.frame() %&gt;% 
  ungroup()

ggplot(data = df3.summary,mapping = aes(x = RELATIONSHIP, y = n, fill = ABOVE50K)) +
  geom_bar(stat = "identity") + 
  geom_text(mapping = aes(y = pos, label = ratio), size = 3) +
  scale_fill_brewer(palette="Paired") +
  labs(title = "RELATIONSHIP VS ABOVE50K",
       x = "RELATIONSHIP", y = "Frequencies") + # Add Title and Labels
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 30, hjust = 1)) # Change the appearance of the main title</pre><p><img loading="lazy" class="alignnone size-large wp-image-905" src="/wp-content/uploads/2018/08/pic16-1024x659.png" alt="logistic regression" width="960" height="618" srcset="/wp-content/uploads/2018/08/pic16-1024x659.png 1024w, /wp-content/uploads/2018/08/pic16-300x193.png 300w, /wp-content/uploads/2018/08/pic16-768x494.png 768w, /wp-content/uploads/2018/08/pic16-1140x734.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>2-8. Race種族</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$RACE)
# Amer-Indian-Eskimo  Asian-Pac-Islander               Black               Other               White 
# 311                1039                3124                 271               27816</pre><p>次數分配圖</p><pre class="crayon-plain-tag">inputData$RACE &lt;- factor(x = inputData$RACE,levels = names(sort(table(inputData$RACE),decreasing = TRUE)))
ggplot(data = inputData, aes(x = RACE, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-906" src="/wp-content/uploads/2018/08/pic17-1024x933.png" alt="logistic regression" width="960" height="875" srcset="/wp-content/uploads/2018/08/pic17-1024x933.png 1024w, /wp-content/uploads/2018/08/pic17-300x273.png 300w, /wp-content/uploads/2018/08/pic17-768x700.png 768w, /wp-content/uploads/2018/08/pic17-1140x1039.png 1140w" sizes="(max-width: 960px) 100vw, 960px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(RACE = inputData$RACE,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(RACE) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  as.data.frame() %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = RACE, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "RACE", y = "percentage") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-1581" src="/wp-content/uploads/2018/09/pic18-1-1024x928.png" alt="logistic regression" width="1024" height="928" srcset="/wp-content/uploads/2018/09/pic18-1-1024x928.png 1024w, /wp-content/uploads/2018/09/pic18-1-300x272.png 300w, /wp-content/uploads/2018/09/pic18-1-768x696.png 768w, /wp-content/uploads/2018/09/pic18-1-830x753.png 830w, /wp-content/uploads/2018/09/pic18-1-230x209.png 230w, /wp-content/uploads/2018/09/pic18-1-350x317.png 350w, /wp-content/uploads/2018/09/pic18-1-480x435.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>繪製同時一張圖呈現frequency與stacked bar目標類別水平的比例分佈圖。</p><pre class="crayon-plain-tag">df3.summary &lt;-
  df2.summary %&gt;%
  group_by(RACE) %&gt;%
  #因為繪圖資訊是先畫&gt;50K，再畫&lt;=50K，故要調整累積數值計算的順序
  do( data.frame(with(data=., .[order(desc(ABOVE50K)),] )) ) %&gt;% 
  ungroup() %&gt;% 
  group_by(RACE) %&gt;%
  mutate(pos = (cumsum(n) - (0.5 * n))) %&gt;%
  as.data.frame() %&gt;% 
  ungroup()

ggplot(data = df3.summary,mapping = aes(x = RACE, y = n, fill = ABOVE50K)) +
  geom_bar(stat = "identity") + 
  geom_text(mapping = aes(y = pos, label = ratio), size = 3) +
  scale_fill_brewer(palette="Paired") +
  labs(title = "RACE VS ABOVE50K",
       x = "RACE", y = "Frequencies") + # Add Title and Labels
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 30, hjust = 1)) # Change the appearance of the main title</pre><p><img loading="lazy" class="alignnone size-large wp-image-1572" src="/wp-content/uploads/2018/09/pic19-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic19-1024x602.png 1024w, /wp-content/uploads/2018/09/pic19-300x176.png 300w, /wp-content/uploads/2018/09/pic19-768x451.png 768w, /wp-content/uploads/2018/09/pic19-830x488.png 830w, /wp-content/uploads/2018/09/pic19-230x135.png 230w, /wp-content/uploads/2018/09/pic19-350x206.png 350w, /wp-content/uploads/2018/09/pic19-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>2-9. Sex 性別</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$SEX)
# Female    Male 
# 10771   21790</pre><p>次數分配圖</p><pre class="crayon-plain-tag">inputData$SEX &lt;- factor(x = inputData$SEX,levels = names(sort(table(inputData$SEX),decreasing = TRUE)))
ggplot(data = inputData, aes(x = SEX, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired")</pre><p><img loading="lazy" class="alignnone size-large wp-image-1574" src="/wp-content/uploads/2018/09/pic20-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic20-1024x602.png 1024w, /wp-content/uploads/2018/09/pic20-300x176.png 300w, /wp-content/uploads/2018/09/pic20-768x451.png 768w, /wp-content/uploads/2018/09/pic20-830x488.png 830w, /wp-content/uploads/2018/09/pic20-230x135.png 230w, /wp-content/uploads/2018/09/pic20-350x206.png 350w, /wp-content/uploads/2018/09/pic20-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>各類別水準值中目標變數分佈圖</p><pre class="crayon-plain-tag"># 首先，先計算類別變數中，不同類別水準值中的薪資水平分佈比例
df2 &lt;- cbind.data.frame(SEX = inputData$SEX,ABOVE50K = inputData$ABOVE50K)
df2.summary &lt;- 
  df2 %&gt;% group_by(SEX) %&gt;% 
  count(ABOVE50K) %&gt;% 
  mutate(ratio=scales::percent(n/sum(n))) %&gt;% 
  as.data.frame() %&gt;% 
  ungroup()

# 依據ABOVE50K的比例排序，更可以看出哪些類別水準有較高ABOVE50K比例
ggplot(inputData, aes(x = forcats::fct_reorder(f = SEX, x = as.numeric(ABOVE50K), fun = mean, .desc = TRUE), fill = ABOVE50K)) +
  geom_bar(position = "fill") + 
  geom_text(data=df2.summary, aes(y=n,label=ratio),
            position=position_fill(vjust=0.5)) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette="Paired") +
  labs(x = "SEX", y = "percentage") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-1575" src="/wp-content/uploads/2018/09/pic21-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic21-1024x602.png 1024w, /wp-content/uploads/2018/09/pic21-300x176.png 300w, /wp-content/uploads/2018/09/pic21-768x451.png 768w, /wp-content/uploads/2018/09/pic21-830x488.png 830w, /wp-content/uploads/2018/09/pic21-230x135.png 230w, /wp-content/uploads/2018/09/pic21-350x206.png 350w, /wp-content/uploads/2018/09/pic21-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>繪製同時一張圖呈現frequency與stacked bar目標類別水平的比例分佈圖。</p><pre class="crayon-plain-tag">df3.summary &lt;-
  df2.summary %&gt;%
  group_by(SEX) %&gt;%
  #因為繪圖資訊是先畫&gt;50K，再畫&lt;=50K，故要調整累積數值計算的順序
  do( data.frame(with(data=., .[order(desc(ABOVE50K)),] )) ) %&gt;% 
  ungroup() %&gt;% 
  group_by(SEX) %&gt;%
  mutate(pos = (cumsum(n) - (0.5 * n))) %&gt;%
  as.data.frame() %&gt;% 
  ungroup()

ggplot(data = df3.summary,mapping = aes(x = SEX, y = n, fill = ABOVE50K)) +
  geom_bar(stat = "identity") + 
  geom_text(mapping = aes(y = pos, label = ratio), size = 3) +
  scale_fill_brewer(palette="Paired") +
  labs(title = "SEX VS ABOVE50K",
       x = "SEX", y = "Frequencies") + # Add Title and Labels
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 30, hjust = 1)) # Change the appearance of the main title</pre><p>&nbsp;</p>
<p><img loading="lazy" class="alignnone size-large wp-image-1576" src="/wp-content/uploads/2018/09/pic22-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic22-1024x602.png 1024w, /wp-content/uploads/2018/09/pic22-300x176.png 300w, /wp-content/uploads/2018/09/pic22-768x451.png 768w, /wp-content/uploads/2018/09/pic22-830x488.png 830w, /wp-content/uploads/2018/09/pic22-230x135.png 230w, /wp-content/uploads/2018/09/pic22-350x206.png 350w, /wp-content/uploads/2018/09/pic22-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>2-10. CapitalGain 資本獲利</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$CAPITALGAIN)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0       0       0    1078       0   99999</pre><p>可以發現資料很右偏，至少有75％(第三個四分位數)的資料都是0。</p>
<p>次數分配圖</p><pre class="crayon-plain-tag">ggplot(data = inputData,mapping = aes(x = CAPITALGAIN, fill = ABOVE50K, group = ABOVE50K)) +
  geom_histogram(bins = 10,color = 'black',lwd =0.3, binwidth = 10000) +  # default bins = 30
  stat_bin(binwidth = 10000, geom = "text", color = "white", size = 3.5,
           mapping = aes(label = ..count.., group = ABOVE50K),position=position_stack(vjust=0.5)) +
  scale_fill_brewer(palette="Paired") +
  scale_x_continuous(breaks= seq(0,max(inputData$CAPITALGAIN), 10000))</pre><p>我們可以觀察到，視覺化的資料極右偏，幾乎所有資料都是0</p>
<p><img loading="lazy" class="alignnone size-large wp-image-1577" src="/wp-content/uploads/2018/09/pic23-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic23-1024x602.png 1024w, /wp-content/uploads/2018/09/pic23-300x176.png 300w, /wp-content/uploads/2018/09/pic23-768x451.png 768w, /wp-content/uploads/2018/09/pic23-830x488.png 830w, /wp-content/uploads/2018/09/pic23-230x135.png 230w, /wp-content/uploads/2018/09/pic23-350x206.png 350w, /wp-content/uploads/2018/09/pic23-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>看一下capitalgain資料是0的比例：</p><pre class="crayon-plain-tag">sum(inputData$CAPITALGAIN == 0)/length(inputData$CAPITALGAIN)
# [1] 0.9167102</pre><p>2-11. Capital Loss 資本失利</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$CAPITALLOSS)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.0     0.0     0.0    87.3     0.0  4356.0</pre><p>次數分配圖</p><pre class="crayon-plain-tag">ggplot(data = inputData,mapping = aes(x = CAPITALLOSS, fill = ABOVE50K, group = ABOVE50K)) +
  geom_histogram(color = 'black',lwd =0.3, binwidth = 1000) +  # default bins = 30
  stat_bin(geom = "text", color = "white", size = 3.5, binwidth = 1000,
           mapping = aes(label = ..count.., group = ABOVE50K),position=position_stack(vjust=0.5)) +
  scale_fill_brewer(palette="Paired")</pre><p><img loading="lazy" class="alignnone size-large wp-image-1578" src="/wp-content/uploads/2018/09/pic24-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic24-1024x602.png 1024w, /wp-content/uploads/2018/09/pic24-300x176.png 300w, /wp-content/uploads/2018/09/pic24-768x451.png 768w, /wp-content/uploads/2018/09/pic24-830x488.png 830w, /wp-content/uploads/2018/09/pic24-230x135.png 230w, /wp-content/uploads/2018/09/pic24-350x206.png 350w, /wp-content/uploads/2018/09/pic24-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>看一下CAPITALLOSS資料是0的比例：</p><pre class="crayon-plain-tag">sum(inputData$CAPITALLOSS == 0)/length(inputData$CAPITALLOSS)
# [1] 0.9533491</pre><p>2-12. HOURSPERWEEK</p>
<p>基礎敘述統計</p><pre class="crayon-plain-tag">summary(inputData$HOURSPERWEEK)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 1.00   40.00   40.00   40.44   45.00   99.00</pre><p>次數分配圖</p><pre class="crayon-plain-tag">ggplot(data = inputData,mapping = aes(x = HOURSPERWEEK, fill = ABOVE50K, group = ABOVE50K)) +
  geom_histogram(bins = 10, color = 'black',lwd =0.3) +  # default bins = 30
  stat_bin(geom = "text", color = "white", size = 3.5, bins = 10,
           mapping = aes(label = ..count.., group = ABOVE50K),position=position_stack(vjust=0.5)) +
  scale_fill_brewer(palette="Paired")</pre><p><img loading="lazy" class="alignnone size-large wp-image-1579" src="/wp-content/uploads/2018/09/pic25-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic25-1024x602.png 1024w, /wp-content/uploads/2018/09/pic25-300x176.png 300w, /wp-content/uploads/2018/09/pic25-768x451.png 768w, /wp-content/uploads/2018/09/pic25-830x488.png 830w, /wp-content/uploads/2018/09/pic25-230x135.png 230w, /wp-content/uploads/2018/09/pic25-350x206.png 350w, /wp-content/uploads/2018/09/pic25-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p>2-13. NATIVECOUNTRY 國籍</p>
<p>次數分配圖</p><pre class="crayon-plain-tag">inputData$NATIVECOUNTRY &lt;- factor(x = inputData$NATIVECOUNTRY,levels = names(sort(table(inputData$NATIVECOUNTRY),decreasing = TRUE)))
ggplot(data = inputData, aes(x = NATIVECOUNTRY, fill = ABOVE50K)) +
  geom_bar() +
  geom_text(stat = "count", aes(label=..count..),size=3.5,position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))</pre><p><img loading="lazy" class="alignnone size-large wp-image-1580" src="/wp-content/uploads/2018/09/pic26-1024x602.png" alt="logistic regression" width="1024" height="602" srcset="/wp-content/uploads/2018/09/pic26-1024x602.png 1024w, /wp-content/uploads/2018/09/pic26-300x176.png 300w, /wp-content/uploads/2018/09/pic26-768x451.png 768w, /wp-content/uploads/2018/09/pic26-830x488.png 830w, /wp-content/uploads/2018/09/pic26-230x135.png 230w, /wp-content/uploads/2018/09/pic26-350x206.png 350w, /wp-content/uploads/2018/09/pic26-480x282.png 480w" sizes="(max-width: 1024px) 100vw, 1024px" /></p>
<p><span style="color: #9d6ad4;">可以發現資料超偏，都集中在美國，因此不適合投入模型</span>。</p>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<h3>3. 資料前處理</h3>
<p>3- 1. 類別水準值簡化</p>
<p>OCCUPATION的部分，因為水平值偏多，且沒有替代變數欄位，故我們考慮將此變數水平值簡化。我們將之簡化為以下幾群：<br />
Blue-Collar, Professional, Sales, Service, and White-Collar, Other/Unknown。</p><pre class="crayon-plain-tag"># 先將?改命名成Unknown
levels(inputData$OCCUPATION)[1] &lt;- "Unknown"

# 新增一個replacement水準值後的欄位：
inputData$OCCUPATION_rep &lt;- inputData$OCCUPATION

# (1) Craft-repair, Farming-fishing, Handlers-cleaners , Machine-op-inspct, Transport-moving =&gt; 合併成Blue-Collar
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Craft-repair', replacement = 'Blue-Collar', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Farming-fishing', replacement = 'Blue-Collar', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Handlers-cleaners', replacement = 'Blue-Collar', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Machine-op-inspct', replacement = 'Blue-Collar', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Transport-moving', replacement = 'Blue-Collar', x = inputData$OCCUPATION_rep)

# (2) Prof-specialty, =&gt; Professional
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Prof-specialty', replacement = 'Professional', x = inputData$OCCUPATION_rep)

# (3) Sales =&gt; Sales不變

# (4) Other-service, Priv-house-serv, Protective-serv, Tech-support, =&gt; Service
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Other-service', replacement = 'Service', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Priv-house-serv', replacement = 'Service', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Protective-serv', replacement = 'Service', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Tech-support', replacement = 'Service', x = inputData$OCCUPATION_rep)

# (5) Adm-clerical, Exec-managerial =&gt; 合併成White-Collar
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Adm-clerical', replacement = 'White-Collar', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Exec-managerial', replacement = 'White-Collar', x = inputData$OCCUPATION_rep)
# (6) ?,Armed-Forces =&gt; Other/Unknown
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^Unknown', replacement = 'Other/Unknown', x = inputData$OCCUPATION_rep)
inputData$OCCUPATION_rep &lt;- gsub(pattern = '^ Armed-Forces', replacement = 'Other/Unknown', x = inputData$OCCUPATION_rep)

inputData$OCCUPATION_rep &lt;- as.factor(inputData$OCCUPATION_rep)

summary(inputData$OCCUPATION_rep)
# Sales   Blue-Collar Other/Unknown  Professional       Service  White-Collar 
# 3650         10062          1852          4140          5021          7836
levels(inputData$OCCUPATION_rep)
# [1] " Sales"        "Blue-Collar"   "Other/Unknown" "Professional"  "Service"       "White-Collar"</pre><p>3-2. (optional)產生類別變數的WOE值<span style="color: #9d6ad4;">(本分析不會執行此段程式碼）</span></p><pre class="crayon-plain-tag"># 這是一個選擇性的步驟，我們在本分析不會執行
# factor_vars &lt;- c ("WORKCLASS", "EDUCATION", "MARITALSTATUS", "OCCUPATION", "OCCUPATION_rep", "RELATIONSHIP", "RACE", "SEX", "NATIVECOUNTRY")

# not run
# for(factor_var in factor_vars){
#   inputData[[factor_var]] &lt;- WOE(X = inputData[,factor_var], Y = inputData$ABOVE50K_y)
# }</pre><p></p>
<h3>4. 產生訓練資料集與測試資料集</h3>
<p></p><pre class="crayon-plain-tag"># 產生訓練資料集
input_ones &lt;- inputData[which(inputData$ABOVE50K_y == 1),]
input_zeros &lt;- inputData[which(inputData$ABOVE50K_y == 0), ]
set.seed(100)
input_ones_training_row &lt;- sample(1:nrow(input_ones),0.7*nrow(input_ones))
input_zeros_training_row &lt;- sample(1:nrow(input_zeros),0.7*nrow(input_zeros))

training_ones &lt;- input_ones[input_ones_training_row,]
training_zeros &lt;- input_zeros[input_zeros_training_row,]
trainingData &lt;- rbind(training_ones, training_zeros)

# 產生測試資料集
test_ones &lt;- input_ones[-input_ones_training_row,]
test_zeros &lt;- input_zeros[-input_zeros_training_row,]
testData &lt;- rbind(test_ones, test_zeros)</pre><p></p>
<h3>5. 計算IV值，篩選變數</h3>
<p></p><pre class="crayon-plain-tag"># 我們會使用套件中的函數smbinning::smbinning，來將連續變數切割為類別變數
library(smbinning)
# 將連續型變數和類別型變數分開
# 記得加入"OCCUPATION_rep"
factor_vars &lt;- c ("WORKCLASS", "EDUCATION", "MARITALSTATUS", "OCCUPATION","OCCUPATION_rep", "RELATIONSHIP", "RACE", "SEX", "NATIVECOUNTRY")
continuous_vars &lt;- c("AGE", "FNLWGT","EDUCATIONNUM", "HOURSPERWEEK", "CAPITALGAIN", "CAPITALLOSS")

# 建立一個變數IV值表格 : numeric(參數要放變數行數)
iv_df &lt;- data.frame(VARS = c(factor_vars, continuous_vars), IV = numeric(15))

# 計算類別變數的IV值
for(factor_var in factor_vars){
  smb &lt;- smbinning.factor(df = trainingData ,y = "ABOVE50K_y",x = factor_var)
  if(class(smb) != "character"){
    iv_df[iv_df$VARS == factor_var,"IV"] &lt;- smb$iv
  }
}
# 計算連續變數的IV值
for(continuous_var in continuous_vars){
  smb &lt;- smbinning(df = trainingData,y = "ABOVE50K_y",x = continuous_var)
  if(class(smb) != "character"){
    iv_df[iv_df$VARS == continuous_var,"IV"] &lt;- smb$iv
  }
}

# 將變數依據IV值高低排列
iv_df &lt;- iv_df[order(-iv_df$IV),]
iv_df

# VARS     IV
# 6    RELATIONSHIP 1.5435
# 3   MARITALSTATUS 1.3195
# 10            AGE 1.1815
# 12   EDUCATIONNUM 0.7169
# 14    CAPITALGAIN 0.6849
# 13   HOURSPERWEEK 0.4592
# 5  OCCUPATION_rep 0.3594
# 8             SEX 0.3127
# 1       WORKCLASS 0.1673
# 7            RACE 0.0634
# 2       EDUCATION 0.0000
# 4      OCCUPATION 0.0000
# 9   NATIVECOUNTRY 0.0000
# 11         FNLWGT 0.0000
# 15    CAPITALLOSS 0.0000</pre><p>關於IV Table的部分，我們可以得出以下資訊：</p>
<ol>
<li>根據經驗，IV&gt;=0.3即表示該預測變數與目標變數有較強的關係。</li>
<li>類別變數IV=0表示類別水準值過多。
<ul>
<li>EDUCATION: 可以使用IV值較高的EDUCATIONNUM代替。</li>
<li>NATIVECOUNTRY:如我們一開始在資料探勘時所見，絕大多數資料皆為United States，因此不予進一步討論。</li>
</ul>
</li>
<li>連續變數IV=0表示沒有顯著的切點存在。
<ul>
<li>FNLWGT：一開始為簡化分析，即不考慮納入模型分析。</li>
<li>CAPITALLOSS: 因為該特徵資料分佈極偏，故不納入進一步模型分析。</li>
</ul>
</li>
<li>從IV表數值，我們決定初步篩選出變數RELATIONSHIP, MARITALSTATUS, AGE, EDUCATIONNUM, CAPITALGAIN, OCCUPATION_rep進行模型分析。</li>
</ol>
<p>Logistic Regression Modeling <span style="color: #9f6ad4;">羅吉斯回歸建模 part2 </span>的部分請參考: <a href="/logistic_regression_part2/" target="_blank" rel="noopener noreferrer">羅吉斯回歸 &#8211; part2 模型建置、診斷與比較</a>。</p>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<hr />
<p>更多模型建置筆記連結：</p>
<ol>
<li><a href="/logistic-regression-part2-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/" target="_blank" rel="noopener noreferrer">Logistic Regression 羅吉斯迴歸 | part2 &#8211; 模型建置、診斷與比較 | R語言</a></li>
<li><a href="/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/" target="_blank" rel="noopener noreferrer">Linear Regression | 線性迴歸模型 | using AirQuality Dataset</a></li>
<li><a href="/regularized-regression-ridge-lasso-elastic/" target="_blank" rel="noopener noreferrer">Regularized Regression | 正規化迴歸 &#8211; Ridge, Lasso, Elastic Net | R語言</a></li>
<li><a href="/decision-tree-cart-%e6%b1%ba%e7%ad%96%e6%a8%b9/" target="_blank" rel="noopener noreferrer">Decision Tree 決策樹 | CART, Conditional Inference Tree, Random Forest</a></li>
<li><a href="/regression-tree-%e8%bf%b4%e6%ad%b8%e6%a8%b9-bagging-bootstrap-aggrgation-r%e8%aa%9e%e8%a8%80/" target="_blank" rel="noopener noreferrer">Regression Tree | 迴歸樹, Bagging, Bootstrap Aggregation | R語言</a></li>
<li><a href="/random-forests-%e9%9a%a8%e6%a9%9f%e6%a3%ae%e6%9e%97/" target="_blank" rel="noopener noreferrer">Random Forests 隨機森林 | randomForest, ranger, h2o | R語言</a></li>
<li><a href="/gradient-boosting-machines-gbm/" target="_blank" rel="noopener noreferrer">Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言</a></li>
<li><a href="/hierarchical-clustering-%e9%9a%8e%e5%b1%a4%e5%bc%8f%e5%88%86%e7%be%a4/" target="_blank" rel="noopener noreferrer">Hierarchical Clustering 階層式分群 | Clustering 資料分群 | R統計</a></li>
<li><a href="/partitional-clustering-kmeans-kmedoid/" target="_blank" rel="noopener noreferrer">Partitional Clustering | 切割式分群 | Kmeans, Kmedoid | Clustering 資料分群</a></li>
<li><a href="/principal-components-analysis-pca-%e4%b8%bb%e6%88%90%e4%bb%bd%e5%88%86%e6%9e%90/" target="_blank" rel="noopener noreferrer">Principal Components Analysis (PCA) | 主成份分析 | R 統計</a></li>
</ol>
<hr />
<p>參考:</p>
<ol>
<li><a href="https://tinyurl.com/y796qqca">歐萊禮  R資料科學</a></li>
</ol>
<p>這篇文章 <a rel="nofollow" href="/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/">Logistic Regression 羅吉斯迴歸 | part1 &#8211; 資料探勘與處理 | 統計 R語言</a> 最早出現於 <a rel="nofollow" href="/">果醬珍珍•JamJam</a>。</p>
]]></content:encoded>
					
					<wfw:commentRss>/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/feed/</wfw:commentRss>
			<slash:comments>2</slash:comments>
		
		
			</item>
		<item>
		<title>Linear Regression &#124; 線性迴歸模型 &#124; using AirQuality Dataset</title>
		<link>/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/</link>
					<comments>/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/#comments</comments>
		
		<dc:creator><![CDATA[jamleecute]]></dc:creator>
		<pubDate>Mon, 06 Aug 2018 12:45:23 +0000</pubDate>
				<category><![CDATA[ 程式與統計]]></category>
		<category><![CDATA[統計模型]]></category>
		<category><![CDATA[AIC]]></category>
		<category><![CDATA[airquality]]></category>
		<category><![CDATA[assumption of linear regression]]></category>
		<category><![CDATA[BIC]]></category>
		<category><![CDATA[eda]]></category>
		<category><![CDATA[exploratory data analysis]]></category>
		<category><![CDATA[ggplot2]]></category>
		<category><![CDATA[kfold cross validation]]></category>
		<category><![CDATA[Linear Regression]]></category>
		<category><![CDATA[linearregression]]></category>
		<category><![CDATA[lm]]></category>
		<category><![CDATA[Missing Values Treatment]]></category>
		<category><![CDATA[modeling]]></category>
		<category><![CDATA[predict]]></category>
		<category><![CDATA[regression]]></category>
		<category><![CDATA[R語言]]></category>
		<category><![CDATA[test]]></category>
		<category><![CDATA[train]]></category>
		<category><![CDATA[統計]]></category>
		<category><![CDATA[線性回歸]]></category>
		<category><![CDATA[線性回歸假設]]></category>
		<category><![CDATA[資料視覺化]]></category>
		<category><![CDATA[遺失值填補]]></category>
		<guid isPermaLink="false">https://jamleecute.wordpress.com/?p=518</guid>

					<description><![CDATA[<p>Linear Regression 線性迴歸模型是用來預測連續型目標變數與預測變數間的線性關係，並存在許多資料符合常態分佈與線性關係等基本假設。預測變數可以是數 [&#8230;]</p>
<p>這篇文章 <a rel="nofollow" href="/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/">Linear Regression | 線性迴歸模型 | using AirQuality Dataset</a> 最早出現於 <a rel="nofollow" href="/">果醬珍珍•JamJam</a>。</p>
]]></description>
										<content:encoded><![CDATA[<p>Linear Regression 線性迴歸模型是用來預測<span style="color: #9f6ad4;">連續型目標變數</span>與預測變數間的線性關係，並存在許多資料符合常態分佈與線性關係等基本假設。預測變數可以是數值或類別型態，投入模型進行時類別變數都會被轉換成虛擬變數。對於有遺失值的觀測值則會直接忽略，且易受極端值影響，因此在使用模型前必須做好資料前處理。</p>
<h3>Linear Regression Introduction</h3>
<p>Linear Regression 線性迴歸模型主要是使用最適線性迴歸線來建立依變數Y和一個或多個自變數X間的關係，並可以此線性迴歸方程式，使用給定自變數X的值來預測依變數Y值（適用於目標變數為連續變數時，若目標變數為二元變數，則適用<a href="/logistic_regression_part1/" target="_blank" rel="noopener noreferrer">羅吉斯回歸</a>）。（＊線性迴歸方程式的建立則是使用最小平方法Least Sqaures Method來找尋X和Y之間的關係與趨勢）</p>
<p>Linear Regression 線性迴歸方程式：<span style="font-weight: 400;">\(Y=\beta_{1}+\beta_{2}*X+\varepsilon\)</span></p>
<p><img loading="lazy" class="wp-image-717 aligncenter" src="/wp-content/uploads/2018/08/統計概念圖_Linear-Regression.jpg" alt="linear regression" width="539" height="404" srcset="/wp-content/uploads/2018/08/統計概念圖_Linear-Regression.jpg 960w, /wp-content/uploads/2018/08/統計概念圖_Linear-Regression-300x225.jpg 300w, /wp-content/uploads/2018/08/統計概念圖_Linear-Regression-768x576.jpg 768w" sizes="(max-width: 539px) 100vw, 539px" /></p>
<h3>Example Problem</h3>
<p>使用資料集為R dataset套件中的<a href="https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/airquality.html">airquality</a>。此資料集主要搜集自1973年5月到9月，每日空氣品質相關的衡量指標，包括臭氧濃度、太陽輻射、平均風速、最高溫度，以及資料月份與資料日。</p>
<p><span style="color: #9f6ad4;"><strong>分析目標：找出影響空氣中臭氧(Ozone)濃度的重要影響因子與關係。</strong></span></p>
<p>目標變數（依變數）：連續變數(臭氧濃度，Ozone)<br />
預測變數（自變數）：連續/類別變數(太陽輻射Solar.R、平均風速Wind、最高溫度Temp、資料月份Month、資料日Day)(*此資料集剛好都是連續變數)</p>
<p>為了達成分析目標，主要的資料處理與分析架構會包括以下步驟：</p>
<ol>
<li>資料載入與檢視</li>
<li>資料探索(Exploratory Data Analysis, EDA)：視覺化分析
<ol>
<li>視覺化預測變數與目標變數間的關係：相關係數矩陣、散佈圖scatter plot</li>
<li>偵測離群值：盒須圖box plot</li>
<li>檢查預測變數分佈是否為常態分佈(鐘型)而沒有左右偏移：機率密度圖density plot</li>
</ol>
</li>
<li>資料前處理
<ol>
<li>離群值處理</li>
<li>標準化-使變數間關係衡量不受單位規模數值影響</li>
<li>變數轉換-使變數接近常態分佈，以符合模型假設</li>
<li>遺失值填補-使用MICE()套件來預測遺失值</li>
</ol>
</li>
<li>建立預測線性模型
<ol>
<li>Pooling &#8211; 綜合多組遺失值填補後的datasets建立回歸模型，並摘要模型配適結果</li>
<li>CompleteData &#8211; 挑選其中一組遺失填補後的dataset建立回歸模型，並摘要模型配適結果</li>
</ol>
</li>
<li>線性回歸模型適合度診斷
<ol>
<li>資料是否符合線性迴歸模型假設</li>
<li>使用gvlma套件檢測</li>
<li>使用shapiro test 來看變數是否成常態分佈</li>
</ol>
</li>
<li>模型驗證
<ol>
<li>檢視(比較)模型配適能力常用指標</li>
<li>80% 訓練 20%驗證
<ul>
<li> 真實值與預測值相關性(Correlation)</li>
<li>正確率(min_max_accuracy)</li>
<li>錯誤率(MAPE ,Mean absolute percentage error)</li>
</ul>
</li>
<li>加強版模型效果驗證：K-fold Cross Validation
<ol>
<li>mean squared error</li>
</ol>
</li>
</ol>
</li>
<li>結論</li>
</ol>
<h3>1. 資料載入與檢視</h3>
<p>載入資料</p><pre class="crayon-plain-tag"># 1. Load and View Dataset library(datasets) 
# 載入今天分析主要會用到的資料集：AirQuality data("airquality") 
inputData &lt;- airquality 

# 查看資料結構:資料變數、型態
str(inputData)

# 'data.frame':	153 obs. of  6 variables:
# $ Ozone  : int  41 36 12 18 NA 28 23 19 8 NA ...
# $ Solar.R: int  190 118 149 313 NA NA 299 99 19 194 ...
# $ Wind   : num  7.4 8 12.6 11.5 14.3 14.9 8.6 13.8 20.1 8.6 ...
# $ Temp   : int  67 72 74 62 56 66 65 59 61 69 ...
# $ Month  : int  5 5 5 5 5 5 5 5 5 5 ...
# $ Day    : int  1 2 3 4 5 6 7 8 9 10 ...</pre><p>檢視資料</p><pre class="crayon-plain-tag"># 資料欄位詳細說明可在console輸入： ?datasets::airquality 
# 查看資料頭幾列 head(inputData)
head(inputData)

#   Ozone Solar.R Wind Temp Month Day
# 1    41     190  7.4   67     5   1
# 2    36     118  8.0   72     5   2
# 3    12     149 12.6   74     5   3
# 4    18     313 11.5   62     5   4
# 5    NA      NA 14.3   56     5   5
# 6    28      NA 14.9   66     5   6</pre><p></p>
<h3>2. 資料探索(Exploratory Data Analysis, EDA)</h3>
<h4>基本敘述統計</h4>
<p>使用summary()函數查看基本敘述統計。可以看到此資料集共有153列，以及6個特徵變數的最大最小值、第一與第三分位數以及遺失值數量。</p><pre class="crayon-plain-tag"># mean,median,25th and 75th quartiles,min,max, NA數量
summary(inputData)

#         Ozone          Solar.R         Wind            Temp          Month           Day      
# Min.   :  1.0   Min.   :  7   Min.   : 1.70   Min.   :56.0   Min.   :5.00   Min.   : 1.0  
# 1st Qu.: 18.0   1st Qu.:116   1st Qu.: 7.40   1st Qu.:72.0   1st Qu.:6.00   1st Qu.: 8.0  
# Median : 31.5   Median :205   Median : 9.70   Median :79.0   Median :7.00   Median :16.0  
# Mean   : 42.1   Mean   :186   Mean   : 9.96   Mean   :77.9   Mean   :6.99   Mean   :15.8  
# 3rd Qu.: 63.2   3rd Qu.:259   3rd Qu.:11.50   3rd Qu.:85.0   3rd Qu.:8.00   3rd Qu.:23.0  
# Max.   :168.0   Max.   :334   Max.   :20.70   Max.   :97.0   Max.   :9.00   Max.   :31.0  
# NA's   :37      NA's   :7</pre><p></p>
<h4>視覺化分析</h4>
<h4>視覺化預測變數與目標變數間的關係</h4>
<p>使用GGally套件中ggcorr()來查看各變數間的相關係數強弱。</p><pre class="crayon-plain-tag">library(&quot;GGally&quot;)
# ggcorr(): Plot a correlation matrix
# The function ggcorr() draws a correlation matrix plot using ggplot2.
ggcorr(data = inputData, palette = &quot;RdYlGn&quot;,
label = TRUE, label_color = &quot;black&quot;)</pre><p><img loading="lazy" class="alignnone size-full wp-image-682" src="/wp-content/uploads/2018/08/Rplot01.jpeg" alt="linear regression" width="600" height="569" srcset="/wp-content/uploads/2018/08/Rplot01.jpeg 600w, /wp-content/uploads/2018/08/Rplot01-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></p>
<p>由上圖可以觀察到</p>
<p>(1)具有較強正相關性(相關係數&gt;=0.4)的變數關係有：</p>
<ul>
<li>氣溫(Temp)&amp;月份(Month)</li>
<li>臭氧濃度(Ozone)與氣溫(Temp)</li>
</ul>
<p>(2)具有較強負相關性(相關係數&lt;= -0.4)的變數關係有：</p>
<ul>
<li>風速(Wind)與氣溫(Temp)</li>
<li>臭氧濃度(Ozone)與風速(Wind)</li>
</ul>
<p>但僅參考相關係數，並無法知道兩者是否符合線性關係。</p>
<p>散佈圖scatter plot ＆ 機率密度圖</p><pre class="crayon-plain-tag"># 使用 ggpairs() 函數產生多個變數間關係的視覺化矩陣散佈圖
ggpairs(data = inputData)</pre><p><img loading="lazy" class="alignnone size-full wp-image-684" src="/wp-content/uploads/2018/08/Rplot02.jpeg" alt="linear regression" width="800" height="759" srcset="/wp-content/uploads/2018/08/Rplot02.jpeg 800w, /wp-content/uploads/2018/08/Rplot02-300x285.jpeg 300w, /wp-content/uploads/2018/08/Rplot02-768x729.jpeg 768w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>由上圖可以觀察到三種數據型態，分別為：</p>
<ol>
<li>對角線上各個變數的機率密度分佈（用來檢視變數分佈是否為常態）
<ul>
<li>除了Temp稍微看似常態，其餘變數Ozone(右偏嚴重)、Solar.R、Wind都不太滿足常態分佈。</li>
</ul>
</li>
<li>左上方三角區塊變數間的相關係數數值大小
<ul>
<li>可以與前面ggcorr()畫的圖做比對</li>
</ul>
</li>
<li>左下方三角區塊變數間的散佈圖
<ul>
<li><span style="color: #9f6ad4;">可以發現此散佈圖在繪製時，已自動使用各變數的最大最小值將數值標準化，所以變數間的散佈圖將不受尺度大小所影響，都剛好在方形的繪圖範圍中</span>。</li>
</ul>
</li>
</ol>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<p>雖然ggpar可以一次畫出全部，但如果要<span style="color: #9f6ad4;">進一步加上趨勢輔助線，看變數x和y是否為線性關係，可以使用下列語法檢視</span>。</p>
<p>我們將剛剛得知有較強相關性的變數關係畫成散佈圖如下。(Ozone, Temp, Wind, Month)</p><pre class="crayon-plain-tag">scatter.smooth(x = inputData$Month, y = inputData$Temp,main = &quot;Temp ~ Month&quot;)
scatter.smooth(x = inputData$Temp, y = inputData$Ozone,main = &quot;Ozone ~ Temp&quot;)
scatter.smooth(x = inputData$Wind, y = inputData$Ozone,main = &quot;Ozone ~ Wind&quot;)
scatter.smooth(x = inputData$Wind, y = inputData$Temp,main = &quot;Temp ~ Wind&quot;)</pre><p><a href='/wp-content/uploads/2018/08/Rplot03.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot03.jpeg" class="attachment-full size-full" alt="Rplot03" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot03.jpeg 600w, /wp-content/uploads/2018/08/Rplot03-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot04.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot04.jpeg" class="attachment-full size-full" alt="Rplot04" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot04.jpeg 600w, /wp-content/uploads/2018/08/Rplot04-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot05.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot05.jpeg" class="attachment-full size-full" alt="Rplot05" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot05.jpeg 600w, /wp-content/uploads/2018/08/Rplot05-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot06.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot06.jpeg" class="attachment-full size-full" alt="Rplot06" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot06.jpeg 600w, /wp-content/uploads/2018/08/Rplot06-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>
</p>
<p>由上面四張散佈圖，可大略看到線性關係如下：</p>
<ol>
<li>雖然氣溫和部分月份數值成正向關，但根據常識，這並不是我們希望的正向關。</li>
<li>臭氧濃度會隨著氣溫上升而上升。</li>
<li>臭氧濃度會隨著風速上升而下降。</li>
<li>氣溫會隨著風速上升而下降。</li>
</ol>
<h4>離群值偵測</h4>
<p>經過上述變數關係探索後，<span style="color: #0000ff;"><span style="color: #9f6ad4;">我們將僅針對聚焦後的變數(Ozone,Temp,Wind)，進行偵測離群值</span>。</span></p>
<p>我們將使用合鬚圖(box-plot)法來偵測離群值。</p><pre class="crayon-plain-tag">boxplot(inputData$Ozone, main="Ozone", sub=paste("Outlier rows: ", paste(boxplot.stats(inputData$Ozone)$out, collapse = ","))) #有離群值
boxplot(inputData$Wind, main="Wind", sub=paste("Outlier rows: ", paste(boxplot.stats(inputData$Wind)$out, collapse = ","))) #有三個離群值
boxplot(inputData$Temp, main="Temp", sub=paste("Outlier rows: ", paste(boxplot.stats(inputData$Temp)$out, collapse = ","))) #無離群值</pre><p>&nbsp;</p>

<a href='/wp-content/uploads/2018/08/Rplot07.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot07.jpeg" class="attachment-full size-full" alt="Rplot07" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot07.jpeg 600w, /wp-content/uploads/2018/08/Rplot07-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot08.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot08.jpeg" class="attachment-full size-full" alt="Rplot08" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot08.jpeg 600w, /wp-content/uploads/2018/08/Rplot08-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot09.jpeg'><img width="600" height="569" src="/wp-content/uploads/2018/08/Rplot09.jpeg" class="attachment-full size-full" alt="Rplot09" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot09.jpeg 600w, /wp-content/uploads/2018/08/Rplot09-300x285.jpeg 300w" sizes="(max-width: 600px) 100vw, 600px" /></a>

<p>由盒鬚圖可知，臭氧濃度(Ozone)跟風速(Wind)都有一些離群值。</p>
<p>由上述發現可知，<span style="color: #9f6ad4;">針對聚焦後的變數(Ozone, Temp, Wind)</span>，接下來需要處理：</p>
<ol>
<li>離群值處理：Ozone(2), Wind(3)。</li>
<li>變數標準化: 使不衡量尺度（單位）間的變數關係不受數值大小所影響。</li>
<li>變數轉換：盡可能讓變數分佈符合常態，以符合線性迴歸基本假設。</li>
<li>空值填補：Ozone(37)。</li>
</ol>
<h3>3. 資料前處理</h3>
<h4>3-1. 離群值處理</h4>
<p>針對聚焦的三個變數(Ozone,Temp,Wind)，<span style="color: #0000ff;"><span style="color: #9f6ad4;">本範例會將離群值填補為NA，再之後跟其他空值一併使用MICE方法預測</span>。</span></p>
<p>偵測離群值(<span style="color: #9f6ad4;">回傳的是離群數值，而非資料列index</span>)。</p><pre class="crayon-plain-tag">boxplot.stats(inputData$Ozone)$out
# [1] 135 168
boxplot.stats(inputData$Wind)$out
# [1] 20.1 18.4 20.7
boxplot.stats(inputData$Temp)$out
# integer(0)</pre><p>將離群值填補為NA。</p><pre class="crayon-plain-tag"># 將遺失值用NA填補
tempData &lt;- inputData
outlier &lt;- function(x) {
x[x &gt; quantile(x,probs = 0.75,na.rm = T) + 1.5 * IQR(x, na.rm = T) |
x &lt; quantile(x,probs = 0.25, na.rm = T) - 1.5 * IQR(x, na.rm = T)] &lt;- NA
x
}
# apply()的第一個參數只能接受「矩陣」物件，意味著所有元素必須是同一類
# 若用在其他結構的物件，如data.frame，他就會先被轉換成matrix
tempData &lt;- apply(X = tempData,MARGIN = 2,FUN = outlier)
# tempData
tempData&lt;- as.data.frame(tempData)</pre><p>檢視離群值處理後的結果。</p><pre class="crayon-plain-tag">summary(tempData) #check Ozone NA數為37+2, Wind NA數為3

#         Ozone          Solar.R         Wind            Temp          Month           Day      
# Min.   :  1.0   Min.   :  7   Min.   : 1.70   Min.   :56.0   Min.   :5.00   Min.   : 1.0  
# 1st Qu.: 18.0   1st Qu.:116   1st Qu.: 7.40   1st Qu.:72.0   1st Qu.:6.00   1st Qu.: 8.0  
# Median : 30.5   Median :205   Median : 9.70   Median :79.0   Median :7.00   Median :16.0  
# Mean   : 40.2   Mean   :186   Mean   : 9.76   Mean   :77.9   Mean   :6.99   Mean   :15.8  
# 3rd Qu.: 60.5   3rd Qu.:259   3rd Qu.:11.50   3rd Qu.:85.0   3rd Qu.:8.00   3rd Qu.:23.0  
# Max.   :122.0   Max.   :334   Max.   :16.60   Max.   :97.0   Max.   :9.00   Max.   :31.0  
# NA's   :39      NA's   :7     NA's   :3</pre><p>檢視離群值處理後變數分佈的變化。</p><pre class="crayon-plain-tag"># 經過極端值處理後：
# Ozone超級偏(skewness = 1.21 -&amp;gt; 0.94)
plot(density(tempData$Ozone, na.rm = TRUE), main=&quot;Density Plot: Ozone&quot;, ylab=&quot;Frequency&quot;, sub=paste(&quot;Skewness:&quot;, round(e1071::skewness(tempData$Ozone, na.rm = TRUE), 2)))
# Wind 平均值右偏(skewness = 0.34 -&amp;gt; 0.06)
plot(density(tempData$Wind, na.rm = TRUE), main=&quot;Density Plot: Wind&quot;, ylab=&quot;Frequency&quot;, sub=paste(&quot;Skewness:&quot;, round(e1071::skewness(tempData$Wind, na.rm = TRUE), 2)))
# Temp 平均值左篇(skewness = -0.37 -&amp;gt; =0.37)沒影響
plot(density(tempData$Temp, na.rm = TRUE), main=&quot;Density Plot: Temp&quot;, ylab=&quot;Frequency&quot;, sub=paste(&quot;Skewness:&quot;, round(e1071::skewness(tempData$Temp, na.rm = TRUE), 2)))</pre><p>可以看到：</p>
<ol>
<li>Ozone skewness有減少(skewness = 1.21 -&gt; 0.94)，但視覺上還是沒有非常接近常態分佈。</li>
<li>Wind的skewness有從0.34減少到0.06，視覺上已接近常態。</li>
<li>Temp的部份因為透過box-plot沒有偵測到明顯離群值，故在此沒有變化。</li>
</ol>

<a href='/wp-content/uploads/2018/08/Rplot12.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot12.jpeg" class="attachment-full size-full" alt="Rplot12" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot12.jpeg 800w, /wp-content/uploads/2018/08/Rplot12-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot12-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot12-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot13.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot13.jpeg" class="attachment-full size-full" alt="Rplot13" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot13.jpeg 800w, /wp-content/uploads/2018/08/Rplot13-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot13-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot13-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot14.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot14.jpeg" class="attachment-full size-full" alt="Rplot14" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot14.jpeg 800w, /wp-content/uploads/2018/08/Rplot14-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot14-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot14-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>

<p>用新的資料偵測離群值，可發現使用box-plot法，已無離群值。</p><pre class="crayon-plain-tag"># (2)outlier detection 離群值偵測 =&amp;gt;都沒有了
boxplot(tempData$Ozone, main=&quot;Ozone&quot;, sub=paste(&quot;Outlier rows: &quot;, paste(boxplot.stats(tempData$Ozone)$out, collapse = &quot;,&quot;))) #有離群值
boxplot(tempData$Wind, main=&quot;Wind&quot;, sub=paste(&quot;Outlier rows: &quot;, paste(boxplot.stats(tempData$Wind)$out, collapse = &quot;,&quot;))) #有三個離群值
boxplot(tempData$Temp, main=&quot;Temp&quot;, sub=paste(&quot;Outlier rows: &quot;, paste(boxplot.stats(tempData$Temp)$out, collapse = &quot;,&quot;))) #無黎群值</pre><p><a href='/wp-content/uploads/2018/08/Rplot03-1.jpeg'><img width="700" height="586" src="/wp-content/uploads/2018/08/Rplot03-1.jpeg" class="attachment-full size-full" alt="Rplot03" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot03-1.jpeg 700w, /wp-content/uploads/2018/08/Rplot03-1-300x251.jpeg 300w, /wp-content/uploads/2018/08/Rplot03-1-230x193.jpeg 230w, /wp-content/uploads/2018/08/Rplot03-1-350x293.jpeg 350w, /wp-content/uploads/2018/08/Rplot03-1-480x402.jpeg 480w" sizes="(max-width: 700px) 100vw, 700px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot04-1.jpeg'><img width="700" height="586" src="/wp-content/uploads/2018/08/Rplot04-1.jpeg" class="attachment-full size-full" alt="Rplot04" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot04-1.jpeg 700w, /wp-content/uploads/2018/08/Rplot04-1-300x251.jpeg 300w, /wp-content/uploads/2018/08/Rplot04-1-230x193.jpeg 230w, /wp-content/uploads/2018/08/Rplot04-1-350x293.jpeg 350w, /wp-content/uploads/2018/08/Rplot04-1-480x402.jpeg 480w" sizes="(max-width: 700px) 100vw, 700px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot05-1.jpeg'><img width="700" height="586" src="/wp-content/uploads/2018/08/Rplot05-1.jpeg" class="attachment-full size-full" alt="Rplot05" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot05-1.jpeg 700w, /wp-content/uploads/2018/08/Rplot05-1-300x251.jpeg 300w, /wp-content/uploads/2018/08/Rplot05-1-230x193.jpeg 230w, /wp-content/uploads/2018/08/Rplot05-1-350x293.jpeg 350w, /wp-content/uploads/2018/08/Rplot05-1-480x402.jpeg 480w" sizes="(max-width: 700px) 100vw, 700px" /></a>
</p>
<h4>3-2. 標準化</h4>
<p>將所有變數標準化(0 to 1)。</p><pre class="crayon-plain-tag">tempData2 &lt;- apply(tempData, 2, function(x){(x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T))})
tempData2 &lt;- as.data.frame(tempData2)</pre><p></p>
<h4>3-3. 變數轉換(\(X_{transform} = \log_{10}X\))</h4>
<p>透過變數log10轉換，來使變數更近似常態分配(僅針對Ozone)。</p><pre class="crayon-plain-tag">subTempData &lt;- tempData2[,c(1)]
subTempData2 &lt;- sapply(subTempData, function(x){x &lt;- log10(x+1)})
tempData2$Ozone_log10 &lt;- as.vector(subTempData2)</pre><p>檢視變數轉換後Ozone的機率密度分佈圖。</p><pre class="crayon-plain-tag"># Ozone_log10(skewness = 1.21 -&gt; 0.94 -&gt;0.69)
plot(density(tempData2$Ozone_log10, na.rm = TRUE), main="Density Plot: Ozone", ylab="Frequency", sub=paste("Skewness:", round(e1071::skewness(tempData2$Ozone_log10, na.rm = TRUE), 2)))</pre><p>可以發現經log10轉換後的Ozone_log10的skewness有降低，但視覺上分佈還是不是那麼常態。(skewness = 1.21 -&gt; 0.94 -&gt;0.69)</p>
<p><img loading="lazy" class="alignnone size-full wp-image-727" src="/wp-content/uploads/2018/08/Rplot15.jpeg" alt="linear regression" width="800" height="787" srcset="/wp-content/uploads/2018/08/Rplot15.jpeg 800w, /wp-content/uploads/2018/08/Rplot15-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot15-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot15-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<h4>3-4. 空值填補(MICE, Multivariate Imputation by Chained Equations)</h4>
<p>當一個特徵變數空值資料占比超過5%就有必要做空值填補之處理。我們建立一個函數用來檢查每個特徵變數遺失資料列佔比。可以發現臭氧Ozone的遺失比例高達25%(原始資料遺失＋離群值NA)。</p><pre class="crayon-plain-tag">pMiss &lt;- function(x){sum(is.na(x))/length(x)*100}
apply(tempData2[,-1],2,pMiss)

#  Solar.R        Wind        Temp       Month         Day Ozone_log10 
# 4.575163    1.960784    0.000000    0.000000    0.000000   25.490196</pre><p>在此我們選擇使用<span style="text-decoration: underline;"><span style="color: #9f6ad4; text-decoration: underline;">MICE Package</span></span>來處理Ozone的遺失值。（更多有關遺失值處理請參考：「<a href="/%e3%80%8c%e7%b5%b1%e8%a8%88%e2%80%a2r%e8%aa%9e%e8%a8%80%e2%80%a2%e9%81%ba%e5%a4%b1%e5%80%bc%e8%99%95%e7%90%86%e3%80%8dmissing-value-treatment/" target="_blank" rel="noopener noreferrer">遺失值處理方法</a>」）</p>
<p><strong>MICE代表： Multivariate Imputations by Chained Equations (MICE)，具有以下幾個特點：</strong></p>
<ul>
<li>主要可用來產生<span style="text-decoration: underline;">多元變數(multivariate)</span>的<span style="text-decoration: underline;">多組空值填補值(multiple imputations)</span>（可透過mice()函式中的<span style="color: #9f6ad4;"><span style="text-decoration: underline;">參數m，number of mutiple imputations</span>，</span>來指定要產生幾組填補值解，預設為5組）。</li>
<li>透過<a href="https://zh.wikipedia.org/wiki/%E5%90%89%E5%B8%83%E6%96%AF%E9%87%87%E6%A0%B7">Gibbs sampling</a>法來對多元變數產稱多組空值填補值。</li>
<li>MICE填補方法是採用Fully Conditional Specification，即<span style="color: #9f6ad4;">每一個不完整的變數都是分別用獨立的模型來預測空值的</span>。</li>
<li>MICE可處理連續型變數(continuous)、二元變數(binary)、無順序類別型變數(unordered categorical)、有序類別變數(ordered categorical)。</li>
<li>MICE在預測目標欄位時(target column)，<span style="text-decoration: underline;">預設會使用其他非目標欄位來作為預測變數(predictors)</span>。如遇預測變數本身也不完整的情況，最新產生的一組填補值會被用來完整預測變數，再進行目標變數的填補預測。</li>
<li>我們可以替不同欄位指定各自的單變數填補模型(univariate imputation model)，使用方法範例：mice(data, meth=c(&#8216;sample&#8217;,&#8217;pmm&#8217;,&#8217;logreg&#8217;,&#8217;norm&#8217;)))。</li>
<li>單變數填補模型可以使用<span style="text-decoration: underline;">內建的方法</span>或是<span style="text-decoration: underline; color: #9f6ad4;">自訂方法(mice.impute.myfunc)</span>(mice(method = c(&#8220;xxx&#8221;, &#8220;<span style="color: #9f6ad4;">myfunc</span>&#8220;))。</li>
<li>常見的幾種內建填補模型包括：
<ul>
<li>pmm (Predictive mean matching) : 任何變數型態</li>
<li>cart (Classification and regression trees) : 任何變數型態</li>
<li>rf (Random forest imputations) : 任何變數型態</li>
<li> logreg (Logistic regression) : 二元類別型態 (binary)</li>
</ul>
</li>
</ul>
<p><strong>MICE package套件中的主要函式說明：</strong></p>
<ul>
<li>md.pattern() : inspect the missing data pattern</li>
<li>mice(): impute the missing values *m* times</li>
<li>with(): analyzed completed data sets =&gt; Performs a computation of each of imputed datasets in data. with (data, expr<span style="color: #9f6ad4;"> = formula</span>, &#8230;)。將產生的m組填補值套用到計算公式。</li>
<li>pool(): combine parameter estimates =&gt; Pool the results of the repeated analyses。綜合m組填補數據所產生的模型的估計係數(estimates)、標準差(std.error)、和p-value。</li>
<li><a href="https://www.rdocumentation.org/packages/mice/versions/3.3.0/topics/pool.compare">pool.compare()</a> : pool.compare(fit1, fit0, method = c(&#8220;wald&#8221;, &#8220;likelihood&#8221;), data = NULL)。使用方法&#8221;wald&#8221;或&#8221;likelihood&#8221;來比較<span style="text-decoration: underline;">兩種模型公式</span>套用在所有填補數據的綜合結果。</li>
<li>complete(): export imputed data 儲存和輸出其中一組完整填補數據</li>
<li>ampute(): generate missing data =&gt; Generate simulated incomplete data 產生模擬的不完整數據</li>
</ul>
<p>首先，因為MICE處理遺失值的假設為，<span style="color: #9f6ad4;">資料為隨機遺失(Missing Completely At Random, MCAR)</span>，所以在使用套件前，<span style="color: #9f6ad4;">我們先使用mice套件中的md.pattern()函數來檢視資料遺失分佈的狀況</span>。我們可以看到有106列資料是完整的，37列資料缺Ozone，5列資料缺Solar.R，2列資料同時缺Ozone&amp;Solar.R。3列資料缺Wind。Ozone總遺失數為39，Solar.R總遺失數為7，Wind總遺失數為3。</p><pre class="crayon-plain-tag">library(mice)
md.pattern(tempData2[,-1])

#     Temp Month Day Wind Solar.R Ozone_log10   
# 106    1     1   1    1       1           1  0
# 37     1     1   1    1       1           0  1
# 5      1     1   1    1       0           1  1
# 2      1     1   1    1       0           0  2
# 3      1     1   1    0       1           1  1
#        0     0   0    3       7          39 49</pre><p>我們使用VIM(Visualization and Imputation of Missing Values)套件中的aggr()函數將上述結果用更有效的視覺化圖表來檢視。</p><pre class="crayon-plain-tag">library(VIM)
aggr_plot &lt;- aggr(tempData2[,-1], col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))</pre><p></p>
<ul>
<li>左圖：各特徵變數的遺失資料比例</li>
<li>右圖：遺失狀況分佈pattern。由圖可知，有近7成資料是完整的，單單遺失Ozone的資料列高達近25%。</li>
</ul>
<p><img loading="lazy" class="alignnone size-full wp-image-1415" src="/wp-content/uploads/2018/08/Rplot01-2.jpeg" alt="linear regression" width="700" height="586" srcset="/wp-content/uploads/2018/08/Rplot01-2.jpeg 700w, /wp-content/uploads/2018/08/Rplot01-2-300x251.jpeg 300w, /wp-content/uploads/2018/08/Rplot01-2-230x193.jpeg 230w, /wp-content/uploads/2018/08/Rplot01-2-350x293.jpeg 350w, /wp-content/uploads/2018/08/Rplot01-2-480x402.jpeg 480w" sizes="(max-width: 700px) 100vw, 700px" /></p>
<p>&nbsp;</p>
<p>而如何檢視資料的<span style="color: #9f6ad4;">遺失分佈是屬於隨機(Missing Completely At Random, MCAR)</span>，就是使用<span style="color: #9f6ad4;">VIM套件的marginplot()</span>函數。關於marginplot()的一些特性如下：</p>
<ul>
<li>一次只能畫出兩維度(變量A&amp;B)遺失分佈關係。在此，因為 Ozone和Solar.R的遺失比例最高，我們將檢視此二變數遺失分佈是否隨機</li>
<li>圖的兩軸最外側盒鬚圖：變量A中，對應變量B完整（藍色）/遺失（紅色）的分佈。</li>
<li>圖的兩軸內側散佈圖：單一變量A在的變量B發生遺失值的散佈圖。</li>
<li>圖的最左下角為變量A與變量B同時遺失的列數。其上方與右方數字則分別表單變量遺失的列數。</li>
<li>圖中央則為兩變數A&amp;B的散佈圖。</li>
<li>如果IQR區間重疊，且盒鬚圖分佈相似，則變量A與變量B的遺失值分佈為隨機，符合MCAR假設。</li>
</ul>
<p></p><pre class="crayon-plain-tag"># Solar.R &amp;amp; Ozone_log10
marginplot(tempData2[c(2,7)])</pre><p>我們從下圖可觀察到：</p>
<ul>
<li>圖左側紅色盒鬚圖為Ozone中Solar.R遺失資料點的分佈，藍色則為其餘Ozone資料點分佈。</li>
<li>圖下側紅色盒鬚圖為Solar.R中Ozone遺失資料點的分佈，藍色則為其餘Solar.R資料點分佈。</li>
<li>從圖兩側我們可以發現，IQR區間是重疊的，且紅色藍色盒鬚圖分佈相似，因此Var1(Solar.R)與Var2(Ozone)的遺失分佈為隨機的，符合MCAR假設。</li>
</ul>
<p><img loading="lazy" class="alignnone size-full wp-image-1420" src="/wp-content/uploads/2018/08/Rplot02-3.jpeg" alt="linear regression" width="700" height="586" srcset="/wp-content/uploads/2018/08/Rplot02-3.jpeg 700w, /wp-content/uploads/2018/08/Rplot02-3-300x251.jpeg 300w, /wp-content/uploads/2018/08/Rplot02-3-230x193.jpeg 230w, /wp-content/uploads/2018/08/Rplot02-3-350x293.jpeg 350w, /wp-content/uploads/2018/08/Rplot02-3-480x402.jpeg 480w" sizes="(max-width: 700px) 100vw, 700px" /></p>
<p>&nbsp;</p>
<p>使用mice()函數進行空值填補，幾個重要參數如下：</p>
<ul>
<li>參數m表示要產生幾組填補數據集。預設為產生5組填補數據集。我們將它設為50組。</li>
<li>參數method (or meth)表示填補方法。在本範例中，因為變數皆為數值，我將使用預設的pmm(predictive mean matching)法。其他方法包括：
<ul>
<li>PMM (Predictive Mean Matching) – For any type variables</li>
<li>logreg(Logistic Regression) – For binary variables( with 2 levels)</li>
<li>polyreg(Polytomous logistic regression) – For unordered categorical/factor variables (&gt;= 2 levels)</li>
<li>polr (Proportional odds model) –  For ordered categorical variables ( &gt;= 2 levels)</li>
</ul>
</li>
<li>參數maxit表示用於計算遺失值的<span style="color: #9f6ad4;">迭代次數，預設為5</span>。本範例將迭代次數設為50。</li>
</ul>
<p></p><pre class="crayon-plain-tag"># 先選取後續會分析的變數Wind,Temp,Ozone_log10
tempData2 &lt;- tempData2[,c(3,4,7)]
tempData3 &lt;- mice(tempData2,m=50,maxit=50,meth='pmm',seed=500)</pre><p>使用summary()來看一下填補的結果。可以看到各特徵變數所使用的補值法分別為何，以及填補各目標變數(y)所投入的預測變數(x)。</p><pre class="crayon-plain-tag">summary(tempData3)

# Class: mids
# Number of multiple imputations:  50 
# Imputation methods:
#        Wind        Temp Ozone_log10 
#       "pmm"          ""       "pmm" 
# PredictorMatrix:
#             Wind Temp Ozone_log10
# Wind           0    1           1
# Temp           1    0           1
# Ozone_log10    1    1           0</pre><p>查看特定特徵值變數填補後的數值可用$imp$var。（列數為該變數有遺失值的列數，行數為各組填補數據集數，本範例為50組）。以Wind為例，遺失的三筆資料，填補後的50組數據集如下：</p><pre class="crayon-plain-tag">#&gt; tempData3$imp$Wind
#&gt; 1     2     3     4     5     6     7     8     9    10    11    12    13    14    15    16    17    18    19
#&gt; 9  0.617 0.846 0.537 0.846 0.577 0.423 0.537 0.349 0.349 0.537 0.349 0.463 0.349 0.349 0.617 0.349 0.812 0.577 0.846
#&gt; 18 0.846 0.577 0.577 0.846 0.537 0.423 0.537 0.577 0.577 0.537 0.886 0.537 0.577 0.537 0.537 0.349 0.846 0.537 0.577
#&gt; 48 0.617 0.617 0.423 0.577 0.886 0.349 0.423 0.926 0.617 0.423 0.537 0.617 0.383 0.423 0.658 0.577 0.383 0.349 0.658
#&gt; 20    21    22    23    24    25    26    27    28    29    30    31    32    33    34    35    36    37    38
#&gt; 9  0.537 0.577 0.537 0.537 1.000 0.846 0.772 0.617 0.658 0.658 0.577 0.846 0.537 0.846 0.423 0.537 0.537 0.423 0.846
#&gt; 18 0.537 0.617 0.537 0.537 0.732 0.423 0.658 0.503 0.423 0.658 0.846 0.577 0.846 0.846 0.537 0.617 0.577 0.423 0.463
#&gt; 48 0.423 0.463 0.309 0.886 0.812 0.195 0.309 0.383 0.383 0.423 0.537 0.658 0.577 0.349 0.309 0.537 0.383 0.537 0.886
#&gt; 39    40    41    42    43    44    45    46    47    48    49    50
#&gt; 9  1.000 1.000 0.846 0.577 0.617 0.537 0.537 0.349 0.503 0.812 0.617 0.537
#&gt; 18 0.577 0.537 0.886 0.732 0.537 0.537 0.537 0.537 0.846 0.846 0.846 0.537
#&gt; 48 0.349 0.309 0.537 0.383 0.658 0.349 0.812 0.886 0.349 0.503 0.383 0.423</pre><p></p>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<h3>4. 建立線性模型 linear regression model</h3>
<p>最後我們來使用處理好的數據來建立回歸模型。</p>
<p>4-1. Pooling: 使用剛剛填補的50組的資料建模，並摘要綜合50組模型的效果。建模結果顯示預測變數皆為顯著。(p-value &lt; 0.05)</p><pre class="crayon-plain-tag"># 使用不同的datasets(m=50)分別建模，並綜合摘要結果
modelFit1 &lt;- with(tempData3,lm(Ozone_log10 ~ Temp + Wind))
summary(pool(modelFit1))
# 根據p-value，預測變數Temp &amp; Wind 都有顯著

#                estimate  std.error statistic       df      p.value
# (Intercept)  0.06810694 0.02245463  3.033091 67.91444 3.255054e-03
# Temp         0.19479181 0.02223289  8.761425 80.70210 2.420286e-13
# Wind        -0.10332966 0.02533499 -4.078536 64.42491 1.056795e-04</pre><p>4-2. 使用complete()隨機挑選一組填補後的dataset來建模(預設是第一組，但也可以透過參數調整)。發現模型配適結果也是顯著的(p-value &lt; 0.05)。</p><pre class="crayon-plain-tag">completedData &lt;- complete(tempData3,1) #預設是挑第一組，也可以更改第二個參數
modelFit2 &lt;- lm(Ozone_log10 ~ Temp + Wind, completedData)
summary(modelFit2)

# Call:
# lm(formula = Ozone_log10 ~ Temp + Wind, data = completedData)
# 
# Residuals:
#       Min        1Q    Median        3Q       Max 
# -0.108651 -0.030307 -0.004117  0.034658  0.142650 
# 
# Coefficients:
#               Estimate Std. Error t value Pr(&gt;|t|)    
#   (Intercept)  0.06882    0.01713   4.017 9.29e-05 ***
#   Temp         0.18569    0.01784  10.409  &lt; 2e-16 ***
#   Wind        -0.10191    0.01883  -5.412 2.42e-07 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 0.04581 on 150 degrees of freedom
# Multiple R-squared:  0.6041,	Adjusted R-squared:  0.5988 
# F-statistic: 114.4 on 2 and 150 DF,  p-value: &lt; 2.2e-16</pre><p><span style="text-decoration: underline;">評估<strong>係數(Coefficients)</strong>指標說明：</span></p>
<ol>
<li>Estimate: 表示各變數的估計係數。</li>
<li>Std. Error (SE) of Estimate: 估計標準誤，用來衡量估計回歸式的精準度。表示觀測值與回歸線間的分散或離散程度。<br />
\(\beta_{0}, \beta_{1}\)計算方式分別如下：<br />
$$SE(\beta_{0})^2 = \sigma^2[\frac{1}{n}+\frac{\bar{x}^2}{\sum_{i=1}^n (x_{i} &#8211; \bar{x})^2}],\space \space SE(\beta_{1})^2 = \frac{\sigma^2}{\sum_{i=1}^n (x_{i} &#8211; \bar{x})^2}$$<br />
其中，\(\sigma^2 = Var(\epsilon)\)表示隨機誤差的變異數。<br />
我們可以透過標準誤SE來計算95%信心水準係數區間如下：<br />
<pre class="crayon-plain-tag">confint(object = modelFit2,level = 0.95)
#                   2.5 %      97.5 %
# (Intercept)  0.03497014  0.10267304
# Temp         0.15044504  0.22094442
# Wind        -0.13912079 -0.06470414</pre><br />
從以上數據來說，在95%信心水準下\(\beta{1}(Temp)\)的係數區間[0.15,0.22]並沒有包括0，也因此我們可以推論說，當溫度升高100度時，log(臭氧濃度)會增加15-22個單位。</li>
<li>t-value: 衡量\(\beta{1}\)距離0有多少個標準差。t-value越大，p-value越小，表示該變數與目標變數關係顯著。t-value計算公式如下：<br />
$$t = \frac{\beta_{1}-0}{SE(\beta_{1})}$$</li>
<li>Pr(&gt;|t|): 兩個預測變數p-value都小於0.05(95%信心水準)，表示與目標變數有顯著關係。</li>
</ol>
<p><span style="text-decoration: underline;">評估<strong>模型正確性(Model Accuracy)</strong>指標說明：</span></p>
<p>我們可以透過以下幾個數值指標來了解模型配適資料的適合度(goodness-of-fit)。</p>
<ol>
<li><strong>Residual standard error (RSE)</strong>：估計誤差標準差(estimate the standard deviation of error \(\epsilon\))。此模型誤差標準差為0.0458 (越小越好)，表示平均來說，實際觀測到的臭氧濃度會偏離回歸預測值約0.0458個單位(這是取log轉換後的數值）。<br />
誤差標準差衡量的是平均觀測值偏離回歸的程度。計算公式如下：<br />
$$RSE = \sqrt{\frac{1}{n-2} \sum_{i=1}^n (y_{i} &#8211; \hat{y}_{i})^2}$$<br />
RSE除了顯示在sumary(modelFit2)的底端，亦可透過以下sigma()函數取得。<br />
<pre class="crayon-plain-tag">sigma(modelFit2)
# [1] 0.04580728</pre><br />
但畢竟RSE評估模型配適資料合適度是用<span style="text-decoration: underline;">實際觀測值偏離回歸預測值多少個Y單位</span>，無從得知構成模型配適</li>
<li><strong>R-squared (判定係數)</strong>: 衡量的是預測變數共解釋了多少變異。\(R^2\)是一個介於0到1的數值，越大越好，且數值不受Y單位所影響。\(R^2\)計算公式如下：<br />
$$R^2 = 1 &#8211; \frac{SSR}{SST} = 1 &#8211; \frac{\sum_{i=1}^n (y_{i} &#8211; \hat{y}_{i})^2}{\sum_{i=1}^n (y_{i} &#8211; \bar{y}_{i})^2}$$<br />
除了可以從sumary(modelFit2)最後幾行得知\(R^2\)的資訊，我們亦可透過以下<span style="text-decoration: underline;">modelr套件中的rsqaure()函數</span>取得。<br />
<pre class="crayon-plain-tag">rsquare(modelFit2, data = completedData)
# [1] 0.604058</pre><br />
此模型的預測變數(Temp &amp; Wind)共解釋了60%目標變數(Ozone)的變異。</li>
<li><strong>Adjusted R-squared</strong>: 調整後的\(R^2\)有綜合考量變數總數(模型複雜度)的懲罰效果。此模型adj.\(R^2\)為 0.599(會比\(R^2\)來的小)，近似60%。</li>
<li><strong>F-statistic</strong>: <span style="text-decoration: underline;"><span style="color: #9f6ad4; text-decoration: underline;">F-statistic test是用來檢測是否模型中至少有一預測變數係數不為0(當模型為複回歸時，此檢測結果特別重要)</span></span>。F統計量的計算公式如下：<br />
$$F = \frac{TSS &#8211; RSS/p}{RSS/n-p-1}$$<br />
F統計量越大，p-value越顯著(p&lt;0.05)。<br />
<span style="text-decoration: underline;">此模型的F統計量為114</span><span style="color: #9f6ad4;"><span style="text-decoration: underline;">(越大越好)，對應的p-value為 p &lt; 2.2e-16</span>。</span></li>
</ol>
<h3>5. linear regression 線性回歸模型適合度診斷</h3>
<h4>5-1. 基本假設檢定</h4>
<p>檢視模型配適度一個重要的步驟，就是透過<span style="text-decoration: underline;">視覺化<span style="color: #9f6ad4; text-decoration: underline;">殘差分佈</span></span>，來檢視模型基本假設是否皆符合。</p><pre class="crayon-plain-tag"># Reset par to the default values at startup
dev.off()
# 5.1 是否符合線性迴歸之基本假設：殘差變異數均一性
plot(modelFit2, which = 1) # 殘差變異分佈不在水平線上，且不接近零
# 5.2 殘差是否為常態分佈
plot(modelFit2, which = 2) # 殘差值分佈不在45度線上
# 5.3 標準化殘差分佈亦不成水平線分佈
plot(modelFit2, which = 3)
# 5.4 沒有對模型影響力過強的資料點（如果有的話，會出現在虛線cook's distance之外）
plot(modelFit2, which = 5)</pre><p>由下圖可以發現：</p>
<ul>
<li>左上：殘差變異數不符合均一性。(理想上，希望紅色線條要接近水平線並接近0)</li>
<li>右上：殘差分佈不符合常態。（理想上，希望殘差值分佈不在45度線上）</li>
<li>左下：標準化殘差變異數不符合均一性。(理想上，希望紅色線條要接近水平線並接近0)</li>
<li>右下：檢視是否有對模型影響力過高的資料點。（若是有，資料點將會超過cook&#8217;s distance虛線外）</li>
</ul>
<p>綜合以上，會發現線性模型似乎不適合用來配適此組資料。</p>

<a href='/wp-content/uploads/2018/08/Rplot16.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot16.jpeg" class="attachment-full size-full" alt="Rplot16" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot16.jpeg 800w, /wp-content/uploads/2018/08/Rplot16-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot16-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot16-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot17.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot17.jpeg" class="attachment-full size-full" alt="Rplot17" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot17.jpeg 800w, /wp-content/uploads/2018/08/Rplot17-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot17-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot17-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot18.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot18.jpeg" class="attachment-full size-full" alt="Rplot18" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot18.jpeg 800w, /wp-content/uploads/2018/08/Rplot18-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot18-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot18-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>
<a href='/wp-content/uploads/2018/08/Rplot19.jpeg'><img width="800" height="787" src="/wp-content/uploads/2018/08/Rplot19.jpeg" class="attachment-full size-full" alt="Rplot19" loading="lazy" srcset="/wp-content/uploads/2018/08/Rplot19.jpeg 800w, /wp-content/uploads/2018/08/Rplot19-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot19-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot19-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></a>

<h4>5-2. gvlma package</h4>
<p>另外，也可以使用gvlma套件來檢定模型是否符合假設。可以發現有部分線性迴歸模型的基礎假設是不成立的。(不過要注意的是，gvlma套件結果相關說明的資料不是很充足。)</p><pre class="crayon-plain-tag"># Check Assumptions Automatically
library(gvlma)
# mod &lt;- lm(Ozone ~ Solar.R, data=airquality)
gvlma(modelFit2)
summary(gvlma(modelFit2))
# 但網路上相關資源目前並沒有太多有關gvlma套件產生結果的說明

# Call:
# lm(formula = Ozone_log10 ~ Temp + Wind, data = completedData)
# 
# Residuals:
#       Min        1Q    Median        3Q       Max 
# -0.108651 -0.030307 -0.004117  0.034658  0.142650 
# 
# Coefficients:
#               Estimate Std. Error t value Pr(&gt;|t|)    
#   (Intercept)  0.06882    0.01713   4.017 9.29e-05 ***
#   Temp         0.18569    0.01784  10.409  &lt; 2e-16 ***
#   Wind        -0.10191    0.01883  -5.412 2.42e-07 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 0.04581 on 150 degrees of freedom
# Multiple R-squared:  0.6041,	Adjusted R-squared:  0.5988 
# F-statistic: 114.4 on 2 and 150 DF,  p-value: &lt; 2.2e-16
# 
# 
# ASSESSMENT OF THE LINEAR MODEL ASSUMPTIONS
# USING THE GLOBAL TEST ON 4 DEGREES-OF-FREEDOM:
#   Level of Significance =  0.05 
# 
# Call:
#   gvlma(x = modelFit2) 
# 
#                          Value   p-value                   Decision
#   Global Stat        31.296325 2.664e-06 Assumptions NOT satisfied!
#   Skewness            1.321357 2.503e-01    Assumptions acceptable.
#   Kurtosis            0.004069 9.491e-01    Assumptions acceptable.
#   Link Function      28.858171 7.788e-08 Assumptions NOT satisfied!
#   Heteroscedasticity  1.112728 2.915e-01    Assumptions acceptable.</pre><p></p>
<h4>5-3. shapiro test常態分佈檢定</h4>
<p>另外，我們亦使用shapiro test 來看鎖定變數是否成常態分佈(H0: 分佈等於常態分佈)。可以發現除了Wind符合常態分配，另外兩個變數都離常態分佈有些距離。<span style="color: #9f6ad4;">因此除非進一步將變數有效轉換以符合常態，否則不適合用線性迴規模性來進行資料配適</span>。</p><pre class="crayon-plain-tag">options(scipen = 999)
normality_test &lt;- apply(X = completedData,MARGIN = 2,FUN = function(x) round(shapiro.test(x)$p.value, digits = 4))
normality_test
#   Wind        Temp Ozone_log10 
# 0.0928      0.0093      0.0000</pre><p></p>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<h3>6. 模型驗證Validation</h3>
<h4>6-1. 常見模型效果評估指標</h4>
<table style="width: 100%; border-collapse: collapse; height: 323px;" border="1">
<tbody>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" bgcolor="#ecd5ed"><strong>STATISTIC</strong></td>
<td style="width: 52.232%; height: 23px;" bgcolor="#ecd5ed"><strong>CRITERION</strong></td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;R-Squared&quot;}">R-Squared</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;R-Squared&quot;}">Higher the better (&gt; 0.70)。表示解釋變異量佔總變異量的百分比。</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Adj R-Squared&quot;}">Adj R-Squared</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Adj R-Squared&quot;}">Higher the better。表示調整後(對模型複雜度加入懲罰)解釋變異量佔總變異量的百分比。</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;F-Statistic&quot;}">F-Statistic</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;F-Statistic&quot;}">Higher the better。</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Std. Error&quot;}">Std. Error (標準誤)</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Std. Error&quot;}">Closer to zero the better。 (表抽樣結果與母體的偏差)</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;t-statistic&quot;}">t-statistic</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;t-statistic&quot;}">Should be greater 1.96 for p-value to be less than 0.05</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;AIC&quot;}">AIC</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;AIC&quot;}">Lower the better</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;BIC&quot;}">BIC</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;BIC&quot;}">Lower the better</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Mallows cp&quot;}">Mallows cp</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Mallows cp&quot;}">Should be close to the number of predictors in model</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;MAPE (Mean absolute percentage error)&quot;}">MAPE (Mean absolute percentage error)</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;MAPE (Mean absolute percentage error)&quot;}">Lower the better</td>
</tr>
<tr style="height: 23px;">
<td style="width: 46.903%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;MSE (Mean squared error)&quot;}">MSE (Mean squared error)</td>
<td style="width: 52.232%; height: 23px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;MSE (Mean squared error)&quot;}">Lower the better</td>
</tr>
<tr style="height: 70px;">
<td style="width: 46.903%; height: 70px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Min_Max Accuracy =&gt; \nmean(min(actual, predicted)/\nmax(actual, predicted))&quot;}">Min_Max Accuracy =&gt;<br />
mean(min(actual, predicted)/<br />
max(actual, predicted))</td>
<td style="width: 52.232%; height: 70px;" data-sheets-value="{&quot;1&quot;:2,&quot;2&quot;:&quot;Min_Max Accuracy =&gt; \nmean(min(actual, predicted)/\nmax(actual, predicted))&quot;}">Higher the better</td>
</tr>
</tbody>
</table>
<h4>6-2. 模型驗證(80%Training20%Testing)</h4>
<p>將資料隨機區分為訓練資料集(80%)與測試資料集(20%)</p><pre class="crayon-plain-tag"># 將資料切分為訓練集與測試集
set.seed(1234)
trainingRowIndex &lt;- sample(1:nrow(completedData),0.7*nrow(completedData))
trainingData &lt;- completedData[trainingRowIndex,]
testData &lt;- completedData[-trainingRowIndex,]</pre><p>使用訓練及資料建置模型 &amp; 使用測試集資料預測結果。並摘要訓練的模型效果summary(mod)。</p><pre class="crayon-plain-tag"># 使用訓練及資料建置模型 &amp; 使用測試集資料預測結果
mod &lt;- lm(Ozone_log10 ~ ., data=trainingData, na.action = na.omit)
predictY &lt;- predict(object = mod, newdata = testData)

summary(mod)

# Call:
# lm(formula = Ozone_log10 ~ ., data = trainingData, na.action = na.omit)
# 
# Residuals:
#       Min        1Q    Median        3Q       Max 
# -0.099618 -0.031069 -0.003893  0.032104  0.138297 
# 
# Coefficients:
#               Estimate Std. Error t value        Pr(&gt;|t|)    
#   (Intercept)  0.08839    0.02154   4.103 0.0000812697310 ***
#   Wind        -0.11489    0.02344  -4.901 0.0000035281189 ***
#   Temp         0.16479    0.02187   7.534 0.0000000000188 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 0.04639 on 104 degrees of freedom
# Multiple R-squared:  0.5734,	Adjusted R-squared:  0.5652 
# F-statistic: 69.89 on 2 and 104 DF,  p-value: &lt; 0.00000000000000022</pre><p>檢視模型預測的效果。</p><pre class="crayon-plain-tag">actuals_predicts &lt;- data.frame(cbind(actuals = testData$Ozone_log10, predicteds = predictY)])</pre><p>計算真實數據與預測數據的相關係數：越高越好。</p><pre class="crayon-plain-tag">cor(actuals_predicts,use="complete.obs") # 0.8136252
cor(actuals_predicts,use="pairwise.complete.obs") # 0.8136252</pre><p>計算AIC, BIC =&gt; 越低越好。</p><pre class="crayon-plain-tag">AIC(mod)
# [1] -348.5126
BIC(mod)
# [1] -337.8213</pre><p>計算模型預測正確率min_max_accuracy： 70.4% = &gt; 越高越好。</p><pre class="crayon-plain-tag">min_max_accuracy &lt;- mean(apply(actuals_predicts, 1, min) / apply(actuals_predicts, 1, max))
min_max_accuracy
# [1] 0.7036471</pre><p>計算模型預測錯誤率 MAPE (Mean absolute percentage error)： 56% =&gt; 越低越好。</p><pre class="crayon-plain-tag">mape &lt;- mean(abs((actuals_predicts$predicteds - actuals_predicts$actuals))/actuals_predicts$actuals)
mape
# [1] 0.5598302</pre><p></p>
<h4>6-3. 加強版模型驗證: K-fold Cross Validation</h4>
<p>使用k-fold交叉驗證。</p><pre class="crayon-plain-tag">library(DAAG)
cvResults &lt;- suppressWarnings(CVlm(data=completedData, form.lm=Ozone_log10 ~ ., m=5, dots=FALSE, seed=29, legend.pos="topleft", main="Small symbols are predicted values while bigger ones are actuals.")) # performs the CV</pre><p>查看交叉驗證的平均平方誤差(MSE):越低越好。</p><pre class="crayon-plain-tag"># MSE (Mean squared error): Lower the better
attr(cvResults, 'ms')  
# [1] 0.0105</pre><p>交叉5次模型配適結果圖如下。小圖示為模型預測值，大圖示則為真實資料值。<span style="color: #9f6ad4;">可以發現第五次模型擬和的結果與其他四次有較大差異</span>。</p>
<p><img loading="lazy" class="alignnone size-full wp-image-738" src="/wp-content/uploads/2018/08/Rplot20.jpeg" alt="linear regression" width="800" height="787" srcset="/wp-content/uploads/2018/08/Rplot20.jpeg 800w, /wp-content/uploads/2018/08/Rplot20-300x295.jpeg 300w, /wp-content/uploads/2018/08/Rplot20-768x756.jpeg 768w, /wp-content/uploads/2018/08/Rplot20-75x75.jpeg 75w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<h3>7. 結論</h3>
<p>我們可以發現，由於airquality<span style="color: #9f6ad4;">資料型態不接近理想的常態分佈，故使用Linear Regression 線性迴歸模型做資料配適不是很合適<span style="color: #333333;">(根據「回歸模型適合度診斷」)</span></span>。如果遇到資料分配非常態時，建議可以考慮其他模型如<a href="/%e3%80%8c%e7%b5%b1%e8%a8%88%e2%80%a2r%e8%aa%9e%e8%a8%80%e2%80%a2%e6%b1%ba%e7%ad%96%e6%a8%b9%e3%80%8ddecision-tree-classification-and-regression-tree-cart/" target="_blank" rel="noopener noreferrer">決策樹</a>（不受限母體分配）。</p>
<div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><br />
<!-- text & display ads 1 --><br />
<ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-7946632597933771" data-ad-slot="8154450369" data-ad-format="auto" data-full-width-responsive="true"></ins><br />
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script></div>
<hr />
<p>更多線性回歸模型應用：</p>
<ol>
<li><a href="/app-mobile-ad-revenue-admob-%e8%a1%8c%e5%8b%95%e5%bb%a3%e5%91%8a%e6%94%b6%e5%85%a5/" target="_blank" rel="noopener noreferrer">開發一個免費App能賺多少錢? 靠 AdMod 廣告月收3萬實例分享</a></li>
</ol>
<p><strong>更多統計模型學習筆記連結：</strong></p>
<ol>
<li><a href="/regularized-regression-ridge-lasso-elastic/" target="_blank" rel="noopener noreferrer">Regularized Regression | 正規化迴歸 &#8211; Ridge, Lasso, Elastic Net | R語言</a></li>
<li><a href="/logistic-regression-part1-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/" target="_blank" rel="noopener noreferrer">Logistic Regression 羅吉斯迴歸 | part1 &#8211; 資料探勘與處理 | 統計 R語言</a></li>
<li><a href="/logistic-regression-part2-%e7%be%85%e5%90%89%e6%96%af%e8%bf%b4%e6%ad%b8/" target="_blank" rel="noopener noreferrer">Logistic Regression 羅吉斯迴歸 | part2 &#8211; 模型建置、診斷與比較 | R語言</a></li>
<li><a href="/decision-tree-cart-%e6%b1%ba%e7%ad%96%e6%a8%b9/" target="_blank" rel="noopener noreferrer">Decision Tree 決策樹 | CART, Conditional Inference Tree, Random Forest</a></li>
<li><a href="/regression-tree-%e8%bf%b4%e6%ad%b8%e6%a8%b9-bagging-bootstrap-aggrgation-r%e8%aa%9e%e8%a8%80/" target="_blank" rel="noopener noreferrer">Regression Tree | 迴歸樹, Bagging, Bootstrap Aggregation | R語言</a></li>
<li><a href="/random-forests-%e9%9a%a8%e6%a9%9f%e6%a3%ae%e6%9e%97/" target="_blank" rel="noopener noreferrer">Random Forests 隨機森林 | randomForest, ranger, h2o | R語言</a></li>
<li><a href="/gradient-boosting-machines-gbm/" target="_blank" rel="noopener noreferrer">Gradient Boosting Machines GBM | gbm, xgboost, h2o | R語言</a></li>
<li><a href="/hierarchical-clustering-%e9%9a%8e%e5%b1%a4%e5%bc%8f%e5%88%86%e7%be%a4/" target="_blank" rel="noopener noreferrer">Hierarchical Clustering 階層式分群 | Clustering 資料分群 | R統計</a></li>
<li><a href="/partitional-clustering-kmeans-kmedoid/" target="_blank" rel="noopener noreferrer">Partitional Clustering | 切割式分群 | Kmeans, Kmedoid | Clustering 資料分群</a></li>
<li><a href="/principal-components-analysis-pca-%e4%b8%bb%e6%88%90%e4%bb%bd%e5%88%86%e6%9e%90/" target="_blank" rel="noopener noreferrer">Principal Components Analysis (PCA) | 主成份分析 | R 統計</a></li>
</ol>
<hr />
<p>參考文章連結：</p>
<ol>
<li><a href="http://r-statistics.co/Linear-Regression.html">Linear Regression</a></li>
<li><a href="http://rpubs.com/Nitika/linearRegression_Airquality">Linear Regression using AirQuality Dataset</a></li>
<li><a href="https://www.r-bloggers.com/imputing-missing-data-with-r-mice-package/">Imputing missing data with R; MICE package</a></li>
<li><a href="http://r-statistics.co/Assumptions-of-Linear-Regression.html">Assumptions of Linear Regression</a></li>
<li><a href="https://ademos.people.uic.edu/Chapter12.html">Chapter 12: Regression: Basics, Assumptions, &amp; Diagnostics</a></li>
<li><a href="https://view.officeapps.live.com/op/view.aspx?src=http://cyber.mcu.edu.tw/%E7%AE%A1%E7%90%86%E5%AD%B8%E9%99%A2/%E7%B5%B1%E8%A8%88%E5%AD%B8%E9%A1%9E/%E8%A4%87%E8%BF%B4%E6%AD%B8%E5%88%86%E6%9E%90%E4%B8%80/%E8%A4%87%E8%BF%B4%E6%AD%B8%E5%88%86%E6%9E%90%E4%B8%80.ppt">複回歸分析</a></li>
<li><a href="http://uc-r.github.io/linear_regression">Linear Regression (2)</a></li>
</ol>
<p>這篇文章 <a rel="nofollow" href="/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/">Linear Regression | 線性迴歸模型 | using AirQuality Dataset</a> 最早出現於 <a rel="nofollow" href="/">果醬珍珍•JamJam</a>。</p>
]]></content:encoded>
					
					<wfw:commentRss>/linear-regression-%e7%b7%9a%e6%80%a7%e8%bf%b4%e6%ad%b8%e6%a8%a1%e5%9e%8b/feed/</wfw:commentRss>
			<slash:comments>3</slash:comments>
		
		
			</item>
	</channel>
</rss>
